<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Calendario de Reservas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
        integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
        integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">
    </script>
    <style>
        body {
            background-color: #dde9ce !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            line-height: 1.6;
        }

        .calendar-container {
            background: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1.2rem;
            margin-top: 20px;
            overflow: hidden;
        }

        @media (max-width: 992px) {
            .calendar {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }

        @media (max-width: 576px) {
            .calendar {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
        }

        .day {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.07);
            min-height: 350px;
        }

        .day h5 {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #343a40;
            text-align: center;
        }

        .hour {
            background: #f8f9fa;
            color: #495057;
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: 1px solid #dee2e6;
            font-size: 0.9rem;
        }

        .hour:hover:not(.reserved) {
            background-color: #e9ecef;
            transform: translateY(-1px);
        }

        .reserved {
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            padding: 10px;
            font-size: 0.85rem;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
            border-radius: 8px;
            margin-bottom: 8px;
            text-align: center;
            border: 1px solid transparent;
            transition: filter 0.2s ease, transform 0.1s ease;
        }

        .tipo-individual {
            background-color: #d9a35b;
            border-color: #c7934b;
            color: #212529;
        }

        /* Ochre */
        .tipo-grupal {
            background-color: #95bf35;
            border-color: #85ab25;
            color: #212529;
        }

        /* Lime Green */
        .tipo-ayuda-ingreso {
            background-color: #d8d02a;
            border-color: #c6c01a;
            color: #212529;
        }

        /* Yellow-Green */
        .tipo-desde-tres-anios {
            background-color: #2ab0d8;
            border-color: #1a9fc6;
            color: #fff;
        }

        /* Cyan Blue */
        .tipo-piano-terapeutico {
            background-color: #f59e90;
            border-color: #e38e80;
            color: #212529;
        }

        /* Salmon Pink */
        .tipo-default {
            background-color: #6c757d;
            border-color: #5c636a;
        }

        /* Default Grey */


        .reserved strong {
            display: block;
            margin-bottom: 3px;
            font-size: 0.9rem;
        }

        .reserved small {
            font-weight: normal;
            font-style: italic;
            display: block;
            margin-top: 2px;
        }

        .reserved:hover {
            filter: brightness(90%);
            transform: translateY(-1px);
        }

        .modal-header {
            background-color: #96a5c0;
            color: white;
            border-bottom: none;
            border-color: #96a5c0;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            padding: 20px;
        }

        .modal-content {
            border-radius: 10px;
            border: none;
        }

        .modal-footer {
            border-top: 1px solid #e9ecef;
        }

        .swal2-container {
            z-index: 1060;
            justify-content: center !important;
            align-items: center !important;
        }

        .action-buttons {
            text-align: center;
            margin-top: 15px;
            margin-bottom: 20px;
        }

        .action-buttons .btn {
            margin: 5px 8px;
        }
    </style>
</head>

<body style="background-color: #dde9ce !important;">
    <div class="container py-4">

        <div class="calendar-container" id="calendarContainer">
            <h2 class="text-center mb-0">Calendario de Clases Semanal</h2>
            <div class="action-buttons">
                <button id="downloadImageBtn" class="btn btn-outline-secondary btn-sm btn-bock">
                    <svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0" />
                        <path
                            d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z" />
                    </svg>
                    Exportar Imagen
                </button>
                <button id="downloadPdfBtn" class="btn btn-outline-danger btn-sm  btn-bock">
                    <svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path
                            d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z" />
                        <path
                            d="M4.603 14.087a.8.8 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.7 7.7 0 0 1 1.482-.625c.49-.174.99-.326 1.493-.472a.5.5 0 0 1 .497.48.5.5 0 0 1-.497.51a6.7 6.7 0 0 0-1.442.439c-.56.2-.986.465-1.284.788-.297.322-.407.718-.383 1.152a.8.8 0 0 0 .438.42zM7.06 10.44a.3.3 0 0 1 .3-.295c.408 0 .76.162.993.402s.398.577.468.957a.3.3 0 0 1-.3.295c-.408 0-.76-.162-.993-.402a1.2 1.2 0 0 1-.468-.957z" />
                    </svg>
                    Exportar PDF
                </button>
                <button id="exportDataBtn" class="btn btn-outline-success btn-sm btn-bock">
                    <svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M3.5 10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5" />
                        <path d="M4 1a1 1 0 0 0-1 1v1h1V2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 .5.5v1h1V2a1 1 0 0 0-1-1z" />
                        <path
                            d="M4 5.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5M4 7.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m1 4v1H4v-1zm4 0v1H8v-1zm4 0v1h-1v-1z" />
                        <path fill-rule="evenodd"
                            d="M1.5 3A1.5 1.5 0 0 0 0 4.5v7A1.5 1.5 0 0 0 1.5 13h13a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 14.5 3zm13 1a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .5-.5z" />
                    </svg>
                    Exportar Datos (.json)
                </button>
                <button id="importDataBtn" class="btn btn-outline-primary btn-sm btn-bock">
                    <svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M3.5 10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5" />
                        <path d="M4 1a1 1 0 0 0-1 1v1h1V2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 .5.5v1h1V2a1 1 0 0 0-1-1z" />
                        <path
                            d="M4 5.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5M4 7.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m1 4v1H4v-1zm4 0v1H8v-1zm4 0v1h-1v-1z" />
                        <path fill-rule="evenodd"
                            d="M1.5 3A1.5 1.5 0 0 0 0 4.5v7A1.5 1.5 0 0 0 1.5 13h13a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 14.5 3zm13 1a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .5-.5z" />
                    </svg>
                    Importar Datos (.json)
                </button>
                <input type="file" id="fileInput" accept=".txt, .json" style="display: none;" />
            </div>

            <div class="calendar" id="calendar">
                <div class="text-center w-100" style="grid-column: 1 / -1; padding: 20px;">Cargando calendario...</div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reservaModal" tabindex="-1" aria-labelledby="reservaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reservaModalLabel">Detalles Clase</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="reservaForm" novalidate>
                        <input type="hidden" id="reservaDia" />
                        <input type="hidden" id="reservaHora" />
                        <div class="row g-3">
                            <div class="col-md-6 mb-3"> <label for="horaInicio" class="form-label">Inicio</label> <input
                                    type="time" class="form-control bg-light" id="horaInicio" readonly /> </div>
                            <div class="col-md-6 mb-3"> <label for="horaFin" class="form-label">Fin</label> <input
                                    type="time" class="form-control bg-light" id="horaFin" readonly /> </div>
                            <div class="col-12 mb-3"> <label for="nombre" class="form-label">Nombre</label> <input
                                    type="text" id="nombre" class="form-control" required />
                                <div class="invalid-feedback">Ingresa un nombre.</div>
                            </div>
                            <div class="col-md-6 mb-3"> <label for="tipo" class="form-label">Tipo</label>
                                <select id="tipo" class="form-select" required>
                                    <option>Individual</option>
                                    <option>Grupal</option>
                                    <option>Ayuda Ingreso a institutos</option>
                                    <option>Desde los 3 años</option>
                                    <option>Piano terapéutico</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3"> <label for="duracion" class="form-label">Duración</label>
                                <select id="duracion" class="form-select" required>
                                    <option value="40">40 min</option>
                                    <option value="60">1 hora</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn me-auto" id="eliminarBtn"
                        style="display: none; background-color: #f3a391;">
                        <svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z" />
                            <path
                                d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z" />
                        </svg>
                        Eliminar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn" style="background-color: #dde9ce !important;" id="guardarBtn">
                        Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        (function () {
            emailjs.init({ publicKey: "qOfrwmjiPJNVT91sk" });
        })();

        const calendar = document.getElementById('calendar');
        const downloadImageBtn = document.getElementById('downloadImageBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const fileInput = document.getElementById('fileInput');
        const reservaForm = document.getElementById('reservaForm');
        const eliminarBtn = document.getElementById('eliminarBtn');

        const days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
        const startHour = 15 * 60;
        const endHour = 21 * 60;
        const hours = [];
        const generationIntervalMinutes = 20;
        for (let min = startHour; min < endHour; min += generationIntervalMinutes) { hours.push(min); }
        const localKey = 'reservasCalendarioV2';
        let reservas = {};

        function formatHora(min) {
            const h = Math.floor(min / 60).toString().padStart(2, '0');
            const m = (min % 60).toString().padStart(2, '0');
            return `${h}:${m}`;
        }

        function getTipoClass(tipo) {
            switch (tipo) {
                case 'Individual': return 'tipo-individual';
                case 'Grupal': return 'tipo-grupal';
                case 'Ayuda Ingreso a institutos': return 'tipo-ayuda-ingreso';
                case 'Desde los 3 años': return 'tipo-desde-tres-anios';
                case 'Piano terapéutico': return 'tipo-piano-terapeutico';
                default:
                    console.warn(`Tipo de reserva desconocido: "${tipo}". Usando clase default.`);
                    return 'tipo-default';
            }
        }

        function guardarReservasEnLocalStorage() {
            try {
                localStorage.setItem(localKey, JSON.stringify(reservas));
                console.log('Reservas guardadas en localStorage.');
            } catch (error) {
                console.error('Error al guardar en localStorage:', error);
                Swal.fire('Error', 'No se pudieron guardar los cambios. El almacenamiento local podría estar lleno o deshabilitado.', 'error');
            }
        }
        function cargarReservasDesdeLocalStorage() {
            calendar.innerHTML = '<div class="text-center w-100" style="grid-column: 1 / -1; padding: 20px;">Cargando calendario...</div>';
            try {
                const dataGuardada = localStorage.getItem(localKey);
                reservas = dataGuardada ? JSON.parse(dataGuardada) : {};
                console.log('Reservas cargadas desde localStorage.');
            } catch (error) {
                console.error('Error al cargar/parsear desde localStorage:', error);
                reservas = {};
                Swal.fire('Error', 'No se pudieron cargar las reservas anteriores. Pueden estar corruptas.', 'warning');
            }
            requestAnimationFrame(() => setTimeout(renderCalendar, 0));
        }

        function renderCalendar() {
            calendar.innerHTML = '';
            days.forEach(day => {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'day';
                dayColumn.innerHTML = `<h5>${day}</h5>`;

                hours.forEach(min => {
                    const horaStr = formatHora(min);
                    const slotKey = `${day}-${horaStr}`;
                    const reservaQueIniciaAqui = reservas[slotKey];

                    if (reservaQueIniciaAqui) {
                        const hourDiv = document.createElement('div');
                        const reservaTipo = reservaQueIniciaAqui.tipo;
                        const tipoClass = getTipoClass(reservaTipo);

                        hourDiv.classList.add('hour', 'reserved', tipoClass);

                        hourDiv.innerHTML = `<strong>${reservaQueIniciaAqui.nombre}</strong><br>${reservaQueIniciaAqui.horaInicio} - ${reservaQueIniciaAqui.horaFin} (${reservaQueIniciaAqui.duracion} min)<br><small>${reservaQueIniciaAqui.tipo}</small>`;
                        hourDiv.onclick = () => abrirModal(day, horaStr, reservaQueIniciaAqui);
                        dayColumn.appendChild(hourDiv);
                    } else {
                        if (!estaEnReserva(day, min)) {
                            if (canFitReservation(day, min, 40)) {
                                const hourDiv = document.createElement('div');
                                hourDiv.className = 'hour';
                                hourDiv.textContent = horaStr;
                                hourDiv.onclick = () => abrirModal(day, horaStr, null);
                                dayColumn.appendChild(hourDiv);
                            }
                        }
                    }
                });
                calendar.appendChild(dayColumn);
            });
        }

        function estaEnReserva(dia, minutos) {
            for (const key in reservas) {
                const reserva = reservas[key];
                if (!key || typeof key !== 'string' || key.indexOf('-') === -1) continue;
                const parts = key.split('-');
                if (parts.length < 2) continue;
                const resDia = parts.slice(0, -1).join('-');
                const resHoraStr = parts[parts.length - 1];
                if (resDia !== dia || !reserva || typeof reserva !== 'object' || !reserva.horaInicio || typeof reserva.horaInicio !== 'string' || typeof reserva.duracion !== 'number' || isNaN(reserva.duracion)) continue;
                const horaParts = reserva.horaInicio.split(':');
                if (horaParts.length !== 2) continue;
                const rh = parseInt(horaParts[0], 10);
                const rm = parseInt(horaParts[1], 10);
                if (isNaN(rh) || isNaN(rm)) continue;
                const resInicio = rh * 60 + rm;
                const resFin = resInicio + reserva.duracion;
                if (minutos >= resInicio && minutos < resFin) return true;
            }
            return false;
        }
        function canFitReservation(day, startMin, duration) {
            const endMinPropuesto = startMin + duration;
            if (endMinPropuesto > endHour) return false;
            for (const key in reservas) {
                const reservaExistente = reservas[key];
                if (!key || typeof key !== 'string' || key.indexOf('-') === -1) continue;
                const parts = key.split('-');
                if (parts.length < 2) continue;
                const resDia = parts.slice(0, -1).join('-');
                const resHoraStr = parts[parts.length - 1];
                if (resDia !== day || !reservaExistente || typeof reservaExistente !== 'object' || !reservaExistente.horaInicio || typeof reservaExistente.horaInicio !== 'string' || typeof reservaExistente.duracion !== 'number' || isNaN(reservaExistente.duracion)) continue;
                const horaParts = reservaExistente.horaInicio.split(':');
                if (horaParts.length !== 2) continue;
                const rh = parseInt(horaParts[0], 10);
                const rm = parseInt(horaParts[1], 10);
                if (isNaN(rh) || isNaN(rm)) continue;
                const resInicioExistente = rh * 60 + rm;
                const resFinExistente = resInicioExistente + reservaExistente.duracion;
                if (startMin < resFinExistente && endMinPropuesto > resInicioExistente) {
                    return false;
                }
            }
            return true;
        }

        function actualizarHoraFin() {
            const horaInicioStr = document.getElementById('horaInicio').value;
            const duracion = parseInt(document.getElementById('duracion').value);
            const guardarBtn = document.getElementById('guardarBtn');
            if (!horaInicioStr || isNaN(duracion) || duracion <= 0) {
                document.getElementById('horaFin').value = '';
                guardarBtn.disabled = true;
                return;
            }
            const [h, m] = horaInicioStr.split(':').map(Number);
            const inicioMin = h * 60 + m;
            const finMin = inicioMin + duracion;
            if (finMin > endHour) {
                document.getElementById('horaFin').value = formatHora(endHour);
                guardarBtn.disabled = true;
                Swal.fire({ icon: 'warning', title: 'Hora Inválida', text: `La clase terminaría después de las ${formatHora(endHour)}. Ajusta la duración o la hora de inicio.`, timer: 3000, showConfirmButton: false });
            } else {
                document.getElementById('horaFin').value = formatHora(finMin);
                guardarBtn.disabled = false;
            }
        }
        function abrirModal(dia, hora, reservaExistente) {
            reservaForm.classList.remove('was-validated');
            document.getElementById('reservaDia').value = dia;
            document.getElementById('reservaHora').value = hora;
            document.getElementById('nombre').value = reservaExistente?.nombre || '';
            document.getElementById('tipo').value = reservaExistente?.tipo || 'Individual';
            document.getElementById('duracion').value = reservaExistente?.duracion || 40;
            document.getElementById('horaInicio').value = reservaExistente?.horaInicio || hora;
            actualizarHoraFin();
            eliminarBtn.style.display = reservaExistente ? 'inline-block' : 'none';
            const modal = new bootstrap.Modal(document.getElementById('reservaModal'));
            modal.show();
        }
        document.getElementById('duracion').addEventListener('change', actualizarHoraFin);
        document.getElementById('horaInicio').addEventListener('change', actualizarHoraFin);

        function enviarCorreoReserva(datosReserva) {
            const serviceID = 'service_93zs6up';
            const templateID = 'template_352le9n';
            const templateParams = {
                day: datosReserva.dia,
                horaInicio: datosReserva.horaInicio,
                horaFin: datosReserva.horaFin,
                name: datosReserva.nombre,
                type: datosReserva.tipo,
                duration: datosReserva.duracion
            };
            console.log("Enviando correo con parámetros:", templateParams);
            emailjs.send(serviceID, templateID, templateParams)
                .then(response => {
                    console.log('Correo enviado con éxito!', response.status, response.text);
                    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true, didOpen: (toast) => { toast.onmouseenter = Swal.stopTimer; toast.onmouseleave = Swal.resumeTimer; } });
                    Toast.fire({ icon: 'info', title: 'Notificación enviada.' });
                })
                .catch(error => {
                    console.error('Error al enviar correo:', error);
                    Swal.fire({ title: "Error de Notificación", text: `La reserva se guardó, pero hubo un error al enviar el correo de notificación: ${error.text || 'Error desconocido'}`, icon: "warning", timer: 4000, showConfirmButton: true });
                });
        }

        document.getElementById('guardarBtn').onclick = () => {
            if (!reservaForm.checkValidity()) { reservaForm.classList.add('was-validated'); return; }
            const dia = document.getElementById('reservaDia').value;
            const horaInicioStr = document.getElementById('horaInicio').value;
            const nombre = document.getElementById('nombre').value.trim();
            const tipo = document.getElementById('tipo').value;
            const duracion = parseInt(document.getElementById('duracion').value);
            if (isNaN(duracion) || duracion <= 0) { Swal.fire('Error', 'La duración debe ser un número positivo.', 'error'); return; }
            const [h, m] = horaInicioStr.split(':').map(Number);
            const inicioMin = h * 60 + m;
            const finMin = inicioMin + duracion;
            if (finMin > endHour) { Swal.fire('Error', `La clase no puede terminar después de las ${formatHora(endHour)}. Verifica la duración o la hora de inicio.`, 'error'); return; }
            const horaFinStr = formatHora(finMin);
            const slotKey = `${dia}-${horaInicioStr}`;
            let conflicto = false;
            let reservaConflictiva = null;
            for (const key in reservas) {
                if (key === slotKey) continue;
                const reservaExistente = reservas[key];
                if (!key || typeof key !== 'string' || key.indexOf('-') === -1) continue;
                const parts = key.split('-');
                if (parts.length < 2) continue;
                const resDiaExistente = parts.slice(0, -1).join('-');
                if (resDiaExistente !== dia || !reservaExistente || typeof reservaExistente !== 'object' || !reservaExistente.horaInicio || typeof reservaExistente.horaInicio !== 'string' || typeof reservaExistente.duracion !== 'number' || isNaN(reservaExistente.duracion)) continue;
                const horaPartsExistente = reservaExistente.horaInicio.split(':');
                if (horaPartsExistente.length !== 2) continue;
                const rhC = parseInt(horaPartsExistente[0], 10);
                const rmC = parseInt(horaPartsExistente[1], 10);
                if (isNaN(rhC) || isNaN(rmC)) continue;
                const rInicioC = rhC * 60 + rmC;
                const rFinC = rInicioC + reservaExistente.duracion;
                if (inicioMin < rFinC && finMin > rInicioC) { conflicto = true; reservaConflictiva = reservaExistente; break; }
            }
            if (conflicto) { Swal.fire('Error de Conflicto', `La reserva propuesta (${horaInicioStr} - ${horaFinStr}) se solapa con la clase de "${reservaConflictiva.nombre}" (${reservaConflictiva.horaInicio} - ${reservaConflictiva.horaFin}).`, 'error'); return; }
            const esEdicion = eliminarBtn.style.display !== 'none';
            const ejecutarGuardado = () => {
                const datosParaGuardar = { nombre, tipo, duracion, horaInicio: horaInicioStr, horaFin: horaFinStr };
                const horaOriginalClickeada = document.getElementById('reservaHora').value;
                const slotKeyOriginal = `${dia}-${horaOriginalClickeada}`;
                if (esEdicion && slotKey !== slotKeyOriginal && reservas[slotKeyOriginal]) { delete reservas[slotKeyOriginal]; }
                reservas[slotKey] = datosParaGuardar;
                guardarReservasEnLocalStorage();
                const datosParaCorreo = { dia, horaInicio: horaInicioStr, horaFin: horaFinStr, nombre, tipo, duracion };
                enviarCorreoReserva(datosParaCorreo);
                const mE = document.getElementById('reservaModal');
                const mI = bootstrap.Modal.getInstance(mE);
                if (mI) mI.hide();
                renderCalendar();
                Swal.fire({ icon: 'success', title: '¡Guardado!', text: `Reserva para ${nombre} guardada correctamente.`, showConfirmButton: false, timer: 1500 });
            };
            if (esEdicion) {
                Swal.fire({ title: 'Confirmar Cambios', text: `¿Estás seguro de guardar los cambios para la reserva de "${nombre}"?`, icon: 'question', showCancelButton: true, confirmButtonColor: '#d9e6cc', cancelButtonColor: '#f3a391', confirmButtonText: 'Sí, guardar', cancelButtonText: 'Cancelar' }).then((result) => { if (result.isConfirmed) { ejecutarGuardado(); } });
            } else { ejecutarGuardado(); }
        };
        document.getElementById('eliminarBtn').onclick = () => {
            const dia = document.getElementById('reservaDia').value;
            const hora = document.getElementById('horaInicio').value;
            const key = `${dia}-${hora}`;
            if (!reservas[key]) { Swal.fire('Error', 'No se encontró la reserva para eliminar.', 'error'); return; }
            Swal.fire({ title: '¿Estás seguro?', text: `Estás a punto de eliminar la reserva de "${reservas[key]?.nombre || 'esta clase'}". ¡Esta acción no se puede deshacer!`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d9e6cc', cancelButtonColor: '#f3a391', confirmButtonText: 'Sí, eliminar', cancelButtonText: 'Cancelar' }).then((result) => {
                if (result.isConfirmed) {
                    if (reservas[key]) {
                        delete reservas[key];
                        guardarReservasEnLocalStorage();
                        const mE = document.getElementById('reservaModal');
                        const mI = bootstrap.Modal.getInstance(mE);
                        if (mI) mI.hide();
                        renderCalendar();
                        Swal.fire('¡Eliminado!', 'La reserva ha sido eliminada.', 'success');
                    } else { Swal.fire('Error', 'No se pudo eliminar la reserva porque ya no existe.', 'error'); renderCalendar(); }
                }
            });
        };

        function setExportButtonLoading(isLoading) {
            const buttons = [downloadImageBtn, downloadPdfBtn, exportDataBtn, importDataBtn];
            buttons.forEach(btn => { if (btn) btn.disabled = isLoading; });

            const loadingSpinner = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
            const imgIconHTML = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/><path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/></svg> Exportar Imagen';
            const pdfIconHTML = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/><path d="M4.603 14.087a.8.8 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.7 7.7 0 0 1 1.482-.625c.49-.174.99-.326 1.493-.472a.5.5 0 0 1 .497.48.5.5 0 0 1-.497.51a6.7 6.7 0 0 0-1.442.439c-.56.2-.986.465-1.284.788-.297.322-.407.718-.383 1.152a.8.8 0 0 0 .438.42zM7.06 10.44a.3.3 0 0 1 .3-.295c.408 0 .76.162.993.402s.398.577.468.957a.3.3 0 0 1-.3.295c-.408 0-.76-.162-.993-.402a1.2 1.2 0 0 1-.468-.957z"/></svg> Exportar PDF';
            const exportDataIconHTML = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M3.5 10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5"/><path d="M4 1a1 1 0 0 0-1 1v1h1V2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 .5.5v1h1V2a1 1 0 0 0-1-1z"/><path d="M4 5.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5M4 7.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m1 4v1H4v-1zm4 0v1H8v-1zm4 0v1h-1v-1z"/><path fill-rule="evenodd" d="M1.5 3A1.5 1.5 0 0 0 0 4.5v7A1.5 1.5 0 0 0 1.5 13h13a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 14.5 3zm13 1a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .5-.5z"/></svg> Exportar Datos (.json)';
            const importDataIconHTML = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M3.5 10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5"/><path d="M4 1a1 1 0 0 0-1 1v1h1V2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 .5.5v1h1V2a1 1 0 0 0-1-1z"/><path d="M4 5.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5M4 7.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m1 4v1H4v-1zm4 0v1H8v-1zm4 0v1h-1v-1z"/><path fill-rule="evenodd" d="M1.5 3A1.5 1.5 0 0 0 0 4.5v7A1.5 1.5 0 0 0 1.5 13h13a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 14.5 3zm13 1a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .5-.5z"/></svg> Importar Datos (.json)';

            if (isLoading) {
                if (downloadImageBtn) downloadImageBtn.innerHTML = loadingSpinner;
                if (downloadPdfBtn) downloadPdfBtn.innerHTML = loadingSpinner;
                if (exportDataBtn) exportDataBtn.innerHTML = loadingSpinner;
                if (importDataBtn) importDataBtn.innerHTML = loadingSpinner;
            } else {
                if (downloadImageBtn) downloadImageBtn.innerHTML = imgIconHTML;
                if (downloadPdfBtn) downloadPdfBtn.innerHTML = pdfIconHTML;
                if (exportDataBtn) exportDataBtn.innerHTML = exportDataIconHTML;
                if (importDataBtn) importDataBtn.innerHTML = importDataIconHTML;
            }
        }
        async function captureCalendar(options = {}) {
            try {
                const calendarElement = document.getElementById('calendar');
                const containerElement = document.getElementById('calendarContainer');
                const originalPadding = containerElement.style.paddingBottom;
                containerElement.style.paddingBottom = '30px';

                const targetWidth = 1200;
                const canvas = await html2canvas(containerElement, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: targetWidth,
                    windowWidth: targetWidth,
                    ignoreElements: (element) => element.classList.contains('action-buttons') || element.tagName === 'BUTTON' || element.tagName === 'INPUT',
                    ...options
                });
                containerElement.style.paddingBottom = originalPadding;
                return canvas;
            } catch (err) {
                console.error("Error html2canvas:", err);
                const containerElement = document.getElementById('calendarContainer');
                containerElement.style.paddingBottom = originalPadding;
                throw err;
            }
        }
        downloadImageBtn.addEventListener('click', async () => {
            setExportButtonLoading(true);
            await new Promise(resolve => setTimeout(resolve, 100));
            try {
                const canvas = await captureCalendar();
                const imageData = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = imageData;
                link.download = 'calendario-reservas.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                Swal.fire({ icon: 'success', title: 'Imagen generada', showConfirmButton: false, timer: 1500 });
            } catch (err) {
                console.error("Error generando imagen:", err);
                Swal.fire('Error', 'No se pudo generar la imagen. Revisa la consola para detalles.', 'error');
            }
            finally { setExportButtonLoading(false); }
        });
        downloadPdfBtn.addEventListener('click', async () => {
            setExportButtonLoading(true);
            await new Promise(resolve => setTimeout(resolve, 100));
            const { jsPDF } = window.jspdf;
            try {
                const canvas = await captureCalendar();
                const imgData = canvas.toDataURL('image/jpeg', 0.92);
                const imgProps = { width: canvas.width, height: canvas.height };
                const pdfWidth = 595.28;
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                const orientation = pdfWidth > pdfHeight ? 'l' : 'p';
                const pdf = new jsPDF({ orientation: orientation, unit: 'pt', format: 'a4' });
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                pdf.save('calendario-reservas.pdf');
                Swal.fire({ icon: 'success', title: 'PDF generado', showConfirmButton: false, timer: 1500 });
            } catch (err) {
                console.error("Error generando PDF:", err);
                Swal.fire('Error', 'No se pudo generar el PDF. Revisa la consola para detalles.', 'error');
            }
            finally { setExportButtonLoading(false); }
        });
        exportDataBtn.addEventListener('click', () => {
            if (Object.keys(reservas).length === 0) { Swal.fire('Vacío', 'No hay reservas para exportar.', 'info'); return; }
            try {
                const dataString = JSON.stringify(reservas, null, 2);
                const blob = new Blob([dataString], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `calendario_reservas_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                Swal.fire('¡Exportado!', 'Datos guardados en formato JSON (.json)', 'success');
            } catch (error) {
                console.error("Error exportando datos:", error);
                Swal.fire('Error', 'Ocurrió un error al exportar los datos.', 'error');
            }
        });
        importDataBtn.addEventListener('click', () => { fileInput.click(); });
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.match('application/json') && !file.name.endsWith('.json') && !file.name.endsWith('.txt')) {
                Swal.fire('Archivo Inválido', 'Por favor, selecciona un archivo .json o .txt que contenga datos JSON válidos.', 'error');
                fileInput.value = null;
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const fileContent = e.target.result;
                try {
                    const importedData = JSON.parse(fileContent);
                    if (typeof importedData !== 'object' || importedData === null || Array.isArray(importedData)) {
                        throw new Error("El archivo no contiene un objeto JSON válido en la raíz.");
                    }
                    let dataIsValid = true;
                    for (const key in importedData) {
                        if (typeof key !== 'string' || key.indexOf('-') === -1 || typeof importedData[key] !== 'object' || !importedData[key].nombre || !importedData[key].horaInicio) {
                            console.warn(`Entrada inválida encontrada durante la importación: Clave "${key}"`, importedData[key]);
                            dataIsValid = false;
                        }
                    }
                    if (!dataIsValid) {
                        console.warn("Algunas entradas en el archivo importado podrían tener un formato inesperado.");
                    }
                    Swal.fire({
                        title: 'Confirmar Importación',
                        html: `Se encontraron <b>${Object.keys(importedData).length}</b> reservas en el archivo.<br>¿Deseas reemplazar <b>TODAS</b> las reservas actuales con las del archivo? <br><b style='color:red;'>¡Esta acción es irreversible!</b>`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Sí, reemplazar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            reservas = importedData;
                            guardarReservasEnLocalStorage();
                            renderCalendar();
                            Swal.fire('¡Importado!', 'Las reservas han sido actualizadas desde el archivo.', 'success');
                        }
                    });
                } catch (error) {
                    console.error("Error procesando archivo importado:", error);
                    Swal.fire('Error de Importación', `No se pudo procesar el archivo. Asegúrate de que sea un archivo JSON válido.\nError: ${error.message}`, 'error');
                }
                finally {
                    fileInput.value = null;
                }
            };
            reader.onerror = (e) => {
                Swal.fire('Error de Lectura', 'No se pudo leer el archivo seleccionado.', 'error');
                fileInput.value = null;
            };
            reader.readAsText(file);
        });

        document.addEventListener('DOMContentLoaded', cargarReservasDesdeLocalStorage);
    </script>

</body>

</html>