<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Calendario de Reservas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- SweetAlert2 Theme -->
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.min.css" rel="stylesheet" />
    <!-- Incluir jsPDF y html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
        integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
        integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- ******** NEW: Include EmailJS Library ******** -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">
    </script>
    <style>
        /* Estilos (sin cambios) */
        body {
            background: #f4f6f9;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            line-height: 1.6;
        }

        .calendar-container {
            background: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1.2rem;
            margin-top: 20px;
            overflow: hidden;
        }

        @media (max-width: 992px) {
            .calendar {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }

        @media (max-width: 576px) {
            .calendar {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
        }

        .day {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.07);
            min-height: 350px;
        }

        .day h5 {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #343a40;
            text-align: center;
        }

        .hour {
            background: #f8f9fa;
            color: #495057;
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: 1px solid #dee2e6;
            font-size: 0.9rem;
        }

        .hour:hover {
            background-color: #e9ecef;
            transform: translateY(-1px);
        }

        .reserved {
            background: #51c2d5;
            color: #fff;
            cursor: pointer;
            border: 1px solid #40a7b8;
            font-weight: bold;
            padding: 10px;
            font-size: 0.85rem;
            line-height: 1.4;
            word-wrap: break-word;
            border-radius: 8px;
            margin-bottom: 8px;
            text-align: center;
        }

        .reserved strong {
            display: block;
            margin-bottom: 3px;
            font-size: 0.9rem;
        }

        .reserved small {
            font-weight: normal;
            font-style: italic;
            display: block;
            margin-top: 2px;
        }

        .reserved:hover {
            background-color: #40a7b8;
            transform: translateY(-1px);
        }

        .modal-header {
            background-color: #51c2d5;
            color: white;
            border-bottom: none;
        }

        .modal-content {
            border-radius: 10px;
            border: none;
        }

        .modal-footer {
            border-top: 1px solid #e9ecef;
        }

        .swal2-container {
            z-index: 1060;
            justify-content: center !important;
            align-items: center !important;
        }

        .action-buttons {
            text-align: center;
            margin-top: 15px;
            margin-bottom: 20px;
        }

        .action-buttons .btn {
            margin: 5px 8px;
        }
    </style>
</head>

<body>
    <div class="container py-4">

        <div class="calendar-container" id="calendarContainer">
            <h2 class="text-center mb-0">Calendario de Clases Semanal</h2>
            <div class="action-buttons">
                <button id="downloadImageBtn" class="btn btn-outline-secondary btn-sm btn-bock">
                    <svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0" />
                        <path
                            d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z" />
                    </svg>
                    Exportar Imagen
                </button>
                <button id="downloadPdfBtn" class="btn btn-outline-danger btn-sm  btn-bock">
                    <svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path
                            d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z" />
                        <path
                            d="M4.603 14.087a.8.8 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.7 7.7 0 0 1 1.482-.625c.49-.174.99-.326 1.493-.472a.5.5 0 0 1 .497.48.5.5 0 0 1-.497.51a6.7 6.7 0 0 0-1.442.439c-.56.2-.986.465-1.284.788-.297.322-.407.718-.383 1.152a.8.8 0 0 0 .438.42zM7.06 10.44a.3.3 0 0 1 .3-.295c.408 0 .76.162.993.402s.398.577.468.957a.3.3 0 0 1-.3.295c-.408 0-.76-.162-.993-.402a1.2 1.2 0 0 1-.468-.957z" />
                    </svg>
                    Exportar PDF
                </button>
                <button id="exportDataBtn" class="btn btn-outline-success btn-sm btn-bock">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-box-arrow-down me-1" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M3.5 10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5" />
                        <path d="M4 1a1 1 0 0 0-1 1v1h1V2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 .5.5v1h1V2a1 1 0 0 0-1-1z" />
                        <path
                            d="M4 5.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5M4 7.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m1 4v1H4v-1zm4 0v1H8v-1zm4 0v1h-1v-1z" />
                        <path fill-rule="evenodd"
                            d="M1.5 3A1.5 1.5 0 0 0 0 4.5v7A1.5 1.5 0 0 0 1.5 13h13a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 14.5 3zm13 1a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .5-.5z" />
                    </svg>
                    Exportar Datos (.txt)
                </button>
                <button id="importDataBtn" class="btn btn-outline-primary btn-sm btn-bock">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-box-arrow-up me-1" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M3.5 10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5" />
                        <path d="M4 1a1 1 0 0 0-1 1v1h1V2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 .5.5v1h1V2a1 1 0 0 0-1-1z" />
                        <path
                            d="M4 5.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5M4 7.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m1 4v1H4v-1zm4 0v1H8v-1zm4 0v1h-1v-1z" />
                        <path fill-rule="evenodd"
                            d="M1.5 3A1.5 1.5 0 0 0 0 4.5v7A1.5 1.5 0 0 0 1.5 13h13a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 14.5 3zm13 1a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .5-.5z" />
                    </svg>
                    Importar Datos (.txt)
                </button>
                <input type="file" id="fileInput" accept=".txt, .json" style="display: none;" />
                <!-- Aceptar .json tambiÃ©n -->
            </div>

            <div class="calendar" id="calendar">
                <div class="text-center w-100" style="grid-column: 1 / -1; padding: 20px;">Cargando calendario...</div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="reservaModal" tabindex="-1" aria-labelledby="reservaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <!-- Contenido del modal -->
                <div class="modal-header">
                    <h5 class="modal-title" id="reservaModalLabel">Detalles Clase</h5> <button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="reservaForm" novalidate> <input type="hidden" id="reservaDia" /> <input type="hidden"
                            id="reservaHora" />
                        <div class="row g-3">
                            <div class="col-md-6 mb-3"> <label for="horaInicio" class="form-label">Inicio</label> <input
                                    type="time" class="form-control bg-light" id="horaInicio" readonly /> </div>
                            <div class="col-md-6 mb-3"> <label for="horaFin" class="form-label">Fin</label> <input
                                    type="time" class="form-control bg-light" id="horaFin" readonly /> </div>
                            <div class="col-12 mb-3"> <label for="nombre" class="form-label">Nombre</label> <input
                                    type="text" id="nombre" class="form-control" required />
                                <div class="invalid-feedback">Ingresa un nombre.</div>
                            </div>
                            <div class="col-md-6 mb-3"> <label for="tipo" class="form-label">Tipo</label> <select
                                    id="tipo" class="form-select" required>
                                    <option>Individual</option>
                                    <option>Grupal</option>
                                    <option>Ayuda Ingreso</option>
                                </select> </div>
                            <div class="col-md-6 mb-3"> <label for="duracion" class="form-label">DuraciÃ³n</label>
                                <select id="duracion" class="form-select" required>
                                    <option value="40">40 min</option>
                                    <option value="60">1 hora</option>
                                </select>
                            </div>
                            <!-- Opcional: Campo de mensaje si tu template lo requiere
                            <div class="col-12 mb-3">
                                <label for="mensajeExtra" class="form-label">Mensaje Adicional (Opcional)</label>
                                <textarea class="form-control" id="mensajeExtra" rows="2"></textarea>
                            </div>
                            -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer"> <button type="button" class="btn btn-danger me-auto" id="eliminarBtn"
                        style="display: none;"> <svg class="bi me-1" width="16" height="16" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path
                                d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z" />
                            <path
                                d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z" />
                        </svg> Eliminar </button> <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cancelar</button> <button type="button" class="btn btn-primary"
                        id="guardarBtn">Guardar</button> </div>
            </div>
        </div>
    </div>

    <!-- Scripts JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // ******** NEW: Initialize EmailJS ********
        (function () {
            // Reemplaza con tu PUBLIC KEY (antes User ID) de EmailJS
            emailjs.init({ publicKey: "qOfrwmjiPJNVT91sk" });
        })();

        // --- Elementos del DOM ---
        const calendar = document.getElementById('calendar');
        const downloadImageBtn = document.getElementById('downloadImageBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const fileInput = document.getElementById('fileInput');
        const reservaForm = document.getElementById('reservaForm');
        const eliminarBtn = document.getElementById('eliminarBtn');

        // --- ConfiguraciÃ³n y Variables Globales ---
        const days = ['Lunes', 'Martes', 'MiÃ©rcoles', 'Jueves', 'Viernes'];
        const startHour = 15 * 60; // 15:00 en minutos
        const endHour = 21 * 60;   // 21:00 en minutos
        const hours = []; // Array para los puntos de tiempo a verificar
        const generationIntervalMinutes = 20; // Intervalo para verificar disponibilidad
        for (let min = startHour; min < endHour; min += generationIntervalMinutes) { hours.push(min); }
        const localKey = 'reservasCalendarioV2'; // Clave para localStorage
        let reservas = {}; // Objeto para almacenar las reservas { "Lunes-15:00": {nombre: ..., ...} }

        // --- Funciones Utilitarias ---
        function formatHora(min) {
            const h = Math.floor(min / 60).toString().padStart(2, '0');
            const m = (min % 60).toString().padStart(2, '0');
            return `${h}:${m}`;
        }

        // --- Funciones de localStorage ---
        function guardarReservasEnLocalStorage() {
            try {
                localStorage.setItem(localKey, JSON.stringify(reservas));
                console.log('Reservas guardadas en localStorage.');
            } catch (error) {
                console.error('Error al guardar en localStorage:', error);
                Swal.fire('Error', 'No se pudieron guardar los cambios. El almacenamiento local podrÃ­a estar lleno o deshabilitado.', 'error');
            }
        }

        function cargarReservasDesdeLocalStorage() {
            calendar.innerHTML = '<div class="text-center w-100" style="grid-column: 1 / -1; padding: 20px;">Cargando calendario...</div>';
            try {
                const dataGuardada = localStorage.getItem(localKey);
                reservas = dataGuardada ? JSON.parse(dataGuardada) : {};
                console.log('Reservas cargadas desde localStorage.');
            } catch (error) {
                console.error('Error al cargar/parsear desde localStorage:', error);
                reservas = {}; // Empezar de cero si hay error
                Swal.fire('Error', 'No se pudieron cargar las reservas anteriores. Pueden estar corruptas.', 'warning');
            }
            requestAnimationFrame(() => setTimeout(renderCalendar, 0));
        }

        // --- LÃ³gica de Renderizado ---
        function renderCalendar() {
            calendar.innerHTML = ''; // Limpiar calendario
            days.forEach(day => {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'day';
                dayColumn.innerHTML = `<h5>${day}</h5>`;

                hours.forEach(min => {
                    const horaStr = formatHora(min);
                    const slotKey = `${day}-${horaStr}`;
                    const reservaQueIniciaAqui = reservas[slotKey];

                    if (reservaQueIniciaAqui) {
                        // Si una reserva INICIA aquÃ­, dibujarla
                        const hourDiv = document.createElement('div');
                        hourDiv.className = 'hour reserved';
                        hourDiv.innerHTML = `<strong>${reservaQueIniciaAqui.nombre}</strong><br>${reservaQueIniciaAqui.horaInicio} - ${reservaQueIniciaAqui.horaFin} (${reservaQueIniciaAqui.duracion} min)<br><small>${reservaQueIniciaAqui.tipo}</small>`;
                        hourDiv.onclick = () => abrirModal(day, horaStr, reservaQueIniciaAqui);
                        dayColumn.appendChild(hourDiv);
                    } else {
                        // Si NINGUNA reserva inicia aquÃ­:
                        // 1. Â¿EstÃ¡ este punto de tiempo libre (no dentro de otra reserva)?
                        if (!estaEnReserva(day, min)) {
                            // 2. Si estÃ¡ libre, Â¿PUEDE CABER una reserva mÃ­nima (40min) desde aquÃ­ sin chocar?
                            if (canFitReservation(day, min, 40)) {
                                const hourDiv = document.createElement('div');
                                hourDiv.className = 'hour';
                                hourDiv.textContent = horaStr;
                                hourDiv.onclick = () => abrirModal(day, horaStr, null);
                                dayColumn.appendChild(hourDiv);
                            }
                        }
                        // Nota: No se dibujan slots si estÃ¡n ocupados por una reserva que *no* empezÃ³ aquÃ­.
                    }
                });
                calendar.appendChild(dayColumn);
            });
        }

        function estaEnReserva(dia, minutos) {
            for (const key in reservas) {
                const reserva = reservas[key];
                // Validaciones robustas
                if (!key || typeof key !== 'string' || key.indexOf('-') === -1) continue;
                const parts = key.split('-');
                if (parts.length < 2) continue; // Asegurarse que hay dÃ­a y hora
                const resDia = parts.slice(0, -1).join('-'); // Manejar dÃ­as con guiones si existieran
                const resHoraStr = parts[parts.length - 1];

                if (resDia !== dia || !reserva || typeof reserva !== 'object' || !reserva.horaInicio || typeof reserva.horaInicio !== 'string' || typeof reserva.duracion !== 'number' || isNaN(reserva.duracion)) continue;

                // Validar formato de horaInicio
                const horaParts = reserva.horaInicio.split(':');
                if (horaParts.length !== 2) continue;
                const rh = parseInt(horaParts[0], 10);
                const rm = parseInt(horaParts[1], 10);
                if (isNaN(rh) || isNaN(rm)) continue;

                const resInicio = rh * 60 + rm;
                const resFin = resInicio + reserva.duracion;
                if (minutos >= resInicio && minutos < resFin) return true; // EstÃ¡ ocupado
            }
            return false; // EstÃ¡ libre
        }


        function canFitReservation(day, startMin, duration) {
            const endMinPropuesto = startMin + duration;
            if (endMinPropuesto > endHour) return false; // Excede lÃ­mite horario

            // Verificar si el slot propuesto completo (startMin hasta endMinPropuesto) choca con alguna reserva existente
            for (const key in reservas) {
                const reservaExistente = reservas[key];
                // Validaciones robustas (similares a estaEnReserva)
                if (!key || typeof key !== 'string' || key.indexOf('-') === -1) continue;
                const parts = key.split('-');
                if (parts.length < 2) continue;
                const resDia = parts.slice(0, -1).join('-');
                const resHoraStr = parts[parts.length - 1];

                if (resDia !== day || !reservaExistente || typeof reservaExistente !== 'object' || !reservaExistente.horaInicio || typeof reservaExistente.horaInicio !== 'string' || typeof reservaExistente.duracion !== 'number' || isNaN(reservaExistente.duracion)) continue;

                const horaParts = reservaExistente.horaInicio.split(':');
                if (horaParts.length !== 2) continue;
                const rh = parseInt(horaParts[0], 10);
                const rm = parseInt(horaParts[1], 10);
                if (isNaN(rh) || isNaN(rm)) continue;

                const resInicioExistente = rh * 60 + rm;
                const resFinExistente = resInicioExistente + reservaExistente.duracion;

                // LÃ³gica de solapamiento: si el inicio propuesto es antes de que termine la existente
                // Y el fin propuesto es despuÃ©s de que inicie la existente
                if (startMin < resFinExistente && endMinPropuesto > resInicioExistente) {
                    return false; // Hay solapamiento
                }
            }
            return true; // No hay solapamiento, se puede reservar
        }

        // --- LÃ³gica del Modal ---
        function actualizarHoraFin() {
            const horaInicioStr = document.getElementById('horaInicio').value;
            const duracion = parseInt(document.getElementById('duracion').value);
            const guardarBtn = document.getElementById('guardarBtn');

            // Deshabilitar botÃ³n si no hay hora de inicio o duraciÃ³n vÃ¡lida
            if (!horaInicioStr || isNaN(duracion) || duracion <= 0) {
                document.getElementById('horaFin').value = '';
                guardarBtn.disabled = true;
                return;
            }

            const [h, m] = horaInicioStr.split(':').map(Number);
            const inicioMin = h * 60 + m;
            const finMin = inicioMin + duracion;

            // Validar si la hora de fin excede el lÃ­mite del calendario
            if (finMin > endHour) {
                document.getElementById('horaFin').value = formatHora(endHour); // Mostrar el lÃ­mite
                guardarBtn.disabled = true; // Deshabilitar guardado
                // Opcional: Mostrar un mensaje de advertencia
                Swal.fire({
                    icon: 'warning',
                    title: 'Hora InvÃ¡lida',
                    text: `La clase terminarÃ­a despuÃ©s de las ${formatHora(endHour)}. Ajusta la duraciÃ³n o la hora de inicio.`,
                    timer: 3000,
                    showConfirmButton: false
                });
            } else {
                document.getElementById('horaFin').value = formatHora(finMin);
                guardarBtn.disabled = false; // Habilitar guardado si es vÃ¡lido
            }
        }


        function abrirModal(dia, hora, reservaExistente) {
            reservaForm.classList.remove('was-validated');
            document.getElementById('reservaDia').value = dia;
            document.getElementById('reservaHora').value = hora; // Slot clickeado (podrÃ­a no ser la hora de inicio real si es ediciÃ³n)
            document.getElementById('nombre').value = reservaExistente?.nombre || '';
            document.getElementById('tipo').value = reservaExistente?.tipo || 'Individual';
            document.getElementById('duracion').value = reservaExistente?.duracion || 40;
            document.getElementById('horaInicio').value = reservaExistente?.horaInicio || hora; // Usar la hora real de inicio si existe, sino la del slot

            // Limpiar campo de mensaje adicional si existe
            // const mensajeExtraEl = document.getElementById('mensajeExtra');
            // if (mensajeExtraEl) mensajeExtraEl.value = '';

            actualizarHoraFin(); // Calcular hora fin inicial
            eliminarBtn.style.display = reservaExistente ? 'inline-block' : 'none';

            const modal = new bootstrap.Modal(document.getElementById('reservaModal'));
            modal.show();
        }

        document.getElementById('duracion').addEventListener('change', actualizarHoraFin);
        // Actualizar tambiÃ©n si cambia la hora de inicio (aunque estÃ© readonly, por si acaso)
        document.getElementById('horaInicio').addEventListener('change', actualizarHoraFin);


        // ******** NEW: FunciÃ³n para enviar correo ********
        function enviarCorreoReserva(datosReserva) {
            // IDs de tu servicio y plantilla en EmailJS
            const serviceID = 'service_93zs6up'; // Tu Service ID
            const templateID = 'template_352le9n'; // Tu Template ID

            // Mapea tus datos a los parÃ¡metros de la plantilla de EmailJS
            // AsegÃºrate que los nombres de las propiedades (day, horaInicio, etc.)
            // coincidan con las variables en tu plantilla EmailJS (ej: {{day}}, {{horaInicio}})
            const templateParams = {
                day: datosReserva.dia,
                horaInicio: datosReserva.horaInicio,
                horaFin: datosReserva.horaFin,
                name: datosReserva.nombre,
                type: datosReserva.tipo,
                duration: datosReserva.duracion
                // message: datosReserva.mensaje || 'N/A' // AÃ±adir si tienes campo de mensaje
            };

            console.log("Enviando correo con parÃ¡metros:", templateParams); // Para depuraciÃ³n

            emailjs.send(serviceID, templateID, templateParams)
                .then(response => {
                    console.log('Correo enviado con Ã©xito!', response.status, response.text);
                    // Opcional: PequeÃ±a notificaciÃ³n no intrusiva de que el correo se enviÃ³
                    // Toast rÃ¡pido de SweetAlert
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.onmouseenter = Swal.stopTimer;
                            toast.onmouseleave = Swal.resumeTimer;
                        }
                    });
                    Toast.fire({
                        icon: 'info',
                        title: 'NotificaciÃ³n enviada.'
                    });
                })
                .catch(error => {
                    console.error('Error al enviar correo:', error);
                    // Mostrar un error especÃ­fico para el correo, sin detener el flujo principal
                    Swal.fire({
                        title: "Error de NotificaciÃ³n",
                        text: `La reserva se guardÃ³, pero hubo un error al enviar el correo de notificaciÃ³n: ${error.text || 'Error desconocido'}`,
                        icon: "warning",
                        timer: 4000, // MÃ¡s tiempo para leer el error
                        showConfirmButton: true // Permitir cerrar manualmente
                    });
                });
        }


        // --- Acciones de Guardar y Eliminar (con confirmaciones) ---
        document.getElementById('guardarBtn').onclick = () => {
            // 1. Validar Formulario Bootstrap
            if (!reservaForm.checkValidity()) {
                reservaForm.classList.add('was-validated');
                return; // Detener si el formulario no es vÃ¡lido
            }

            // 2. Obtener datos del formulario
            const dia = document.getElementById('reservaDia').value;
            const horaInicioStr = document.getElementById('horaInicio').value; // Hora real de inicio
            const nombre = document.getElementById('nombre').value.trim();
            const tipo = document.getElementById('tipo').value;
            const duracion = parseInt(document.getElementById('duracion').value);
            // const mensaje = document.getElementById('mensajeExtra')?.value.trim(); // Obtener mensaje si existe

            // Validar duraciÃ³n mÃ­nima (ej. > 0)
            if (isNaN(duracion) || duracion <= 0) {
                Swal.fire('Error', 'La duraciÃ³n debe ser un nÃºmero positivo.', 'error');
                return;
            }

            // 3. Calcular hora de fin y validar lÃ­mite horario
            const [h, m] = horaInicioStr.split(':').map(Number);
            const inicioMin = h * 60 + m;
            const finMin = inicioMin + duracion;

            if (finMin > endHour) {
                Swal.fire('Error', `La clase no puede terminar despuÃ©s de las ${formatHora(endHour)}. Verifica la duraciÃ³n o la hora de inicio.`, 'error');
                return; // Detener si excede el lÃ­mite
            }
            const horaFinStr = formatHora(finMin);

            // 4. Determinar la clave ÃNICA de la reserva (basada en dÃ­a y hora de INICIO)
            const slotKey = `${dia}-${horaInicioStr}`;

            // 5. Verificar conflictos con OTRAS reservas
            let conflicto = false;
            let reservaConflictiva = null;
            for (const key in reservas) {
                // Ignorar la propia reserva que se estÃ¡ editando
                if (key === slotKey) continue;

                const reservaExistente = reservas[key];
                // Validaciones robustas para la reserva existente
                if (!key || typeof key !== 'string' || key.indexOf('-') === -1) continue;
                const parts = key.split('-');
                if (parts.length < 2) continue;
                const resDiaExistente = parts.slice(0, -1).join('-');
                const resHoraStrExistente = parts[parts.length - 1];

                if (resDiaExistente !== dia || !reservaExistente || typeof reservaExistente !== 'object' || !reservaExistente.horaInicio || typeof reservaExistente.horaInicio !== 'string' || typeof reservaExistente.duracion !== 'number' || isNaN(reservaExistente.duracion)) continue;

                const horaPartsExistente = reservaExistente.horaInicio.split(':');
                if (horaPartsExistente.length !== 2) continue;
                const rhC = parseInt(horaPartsExistente[0], 10);
                const rmC = parseInt(horaPartsExistente[1], 10);
                if (isNaN(rhC) || isNaN(rmC)) continue;

                const rInicioC = rhC * 60 + rmC;
                const rFinC = rInicioC + reservaExistente.duracion;

                // LÃ³gica de solapamiento: si la nueva reserva (inicioMin a finMin)
                // se solapa con la existente (rInicioC a rFinC)
                if (inicioMin < rFinC && finMin > rInicioC) {
                    conflicto = true;
                    reservaConflictiva = reservaExistente;
                    break; // Salir al encontrar el primer conflicto
                }
            }

            if (conflicto) {
                Swal.fire('Error de Conflicto', `La reserva propuesta (${horaInicioStr} - ${horaFinStr}) se solapa con la clase de "${reservaConflictiva.nombre}" (${reservaConflictiva.horaInicio} - ${reservaConflictiva.horaFin}).`, 'error');
                return; // Detener si hay conflicto
            }

            // 6. ConfirmaciÃ³n (si es ediciÃ³n) y EjecuciÃ³n del Guardado
            const esEdicion = eliminarBtn.style.display !== 'none'; // Determinar si es ediciÃ³n antes de definir ejecutarGuardado

            const ejecutarGuardado = () => {
                const datosParaGuardar = { nombre, tipo, duracion, horaInicio: horaInicioStr, horaFin: horaFinStr };
                // Si la clave original (slot clickeado) es diferente a la nueva clave (porque se cambiÃ³ la hora de inicio durante la ediciÃ³n)
                // y se estaba editando (esEdicion era true), hay que eliminar la entrada antigua.
                const horaOriginalClickeada = document.getElementById('reservaHora').value;
                const slotKeyOriginal = `${dia}-${horaOriginalClickeada}`;
                if (esEdicion && slotKey !== slotKeyOriginal && reservas[slotKeyOriginal]) {
                    console.log(`Eliminando entrada antigua por cambio de hora: ${slotKeyOriginal}`);
                    delete reservas[slotKeyOriginal]; // Borrar la entrada vieja si la hora de inicio cambiÃ³
                }

                reservas[slotKey] = datosParaGuardar; // Guardar o sobrescribir con la nueva clave
                guardarReservasEnLocalStorage();

                // ******** NEW: Enviar correo DESPUÃS de guardar ********
                const datosParaCorreo = { dia, horaInicio: horaInicioStr, horaFin: horaFinStr, nombre, tipo, duracion /*, mensaje*/ };
                enviarCorreoReserva(datosParaCorreo);
                // ********************************************************

                const mE = document.getElementById('reservaModal');
                const mI = bootstrap.Modal.getInstance(mE);
                if (mI) mI.hide();
                renderCalendar(); // Re-renderizar el calendario
                Swal.fire({ icon: 'success', title: 'Â¡Guardado!', text: `Reserva para ${nombre} guardada correctamente.`, showConfirmButton: false, timer: 1500 });
            };

            if (esEdicion) {
                // Si es ediciÃ³n, preguntar antes de guardar
                Swal.fire({
                    title: 'Confirmar Cambios',
                    text: `Â¿EstÃ¡s seguro de guardar los cambios para la reserva de "${nombre}"?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'SÃ­, guardar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        ejecutarGuardado();
                    }
                });
            } else {
                // Si es una reserva nueva, guardar directamente
                ejecutarGuardado();
            }
        };
        document.getElementById('eliminarBtn').onclick = () => {
            const dia = document.getElementById('reservaDia').value;
            const hora = document.getElementById('horaInicio').value; // Usar horaInicio real
            const key = `${dia}-${hora}`;

            if (!reservas[key]) {
                Swal.fire('Error', 'No se encontrÃ³ la reserva para eliminar.', 'error');
                return;
            }

            Swal.fire({
                title: 'Â¿EstÃ¡s seguro?',
                text: `EstÃ¡s a punto de eliminar la reserva de "${reservas[key]?.nombre || 'esta clase'}". Â¡Esta acciÃ³n no se puede deshacer!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'SÃ­, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (reservas[key]) {
                        delete reservas[key]; // Eliminar la reserva del objeto
                        guardarReservasEnLocalStorage(); // Guardar los cambios en localStorage

                        const mE = document.getElementById('reservaModal');
                        const mI = bootstrap.Modal.getInstance(mE);
                        if (mI) mI.hide(); // Cerrar el modal

                        renderCalendar(); // Actualizar la vista del calendario
                        Swal.fire(
                            'Â¡Eliminado!',
                            'La reserva ha sido eliminada.',
                            'success'
                        );
                    } else {
                        // Esto no deberÃ­a pasar si la validaciÃ³n inicial funcionÃ³, pero por si acaso
                        Swal.fire('Error', 'No se pudo eliminar la reserva porque ya no existe.', 'error');
                        renderCalendar(); // Actualizar por si acaso
                    }
                }
            });
        };
        // --- Funciones y Listeners para Exportar (Visual y Datos) e Importar ---
        function setExportButtonLoading(isLoading) {
            const buttons = [downloadImageBtn, downloadPdfBtn, exportDataBtn, importDataBtn];
            buttons.forEach(btn => { if (btn) btn.disabled = isLoading; }); // Chequear si existen

            const loadingSpinner = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
            const imgIconHTML = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/><path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/></svg> Exportar Imagen';
            const pdfIconHTML = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/><path d="M4.603 14.087a.8.8 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.7 7.7 0 0 1 1.482-.625c.49-.174.99-.326 1.493-.472a.5.5 0 0 1 .497.48.5.5 0 0 1-.497.51a6.7 6.7 0 0 0-1.442.439c-.56.2-.986.465-1.284.788-.297.322-.407.718-.383 1.152a.8.8 0 0 0 .438.42zM7.06 10.44a.3.3 0 0 1 .3-.295c.408 0 .76.162.993.402s.398.577.468.957a.3.3 0 0 1-.3.295c-.408 0-.76-.162-.993-.402a1.2 1.2 0 0 1-.468-.957z"/></svg> Exportar PDF';
            const exportDataIconHTML = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M3.5 10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5"/><path d="M4 1a1 1 0 0 0-1 1v1h1V2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 .5.5v1h1V2a1 1 0 0 0-1-1z"/><path d="M4 5.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5M4 7.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m1 4v1H4v-1zm4 0v1H8v-1zm4 0v1h-1v-1z"/><path fill-rule="evenodd" d="M1.5 3A1.5 1.5 0 0 0 0 4.5v7A1.5 1.5 0 0 0 1.5 13h13a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 14.5 3zm13 1a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .5-.5z"/></svg> Exportar Datos (.txt)';
            const importDataIconHTML = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M3.5 10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5"/><path d="M4 1a1 1 0 0 0-1 1v1h1V2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 .5.5v1h1V2a1 1 0 0 0-1-1z"/><path d="M4 5.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5M4 7.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m1 4v1H4v-1zm4 0v1H8v-1zm4 0v1h-1v-1z"/><path fill-rule="evenodd" d="M1.5 3A1.5 1.5 0 0 0 0 4.5v7A1.5 1.5 0 0 0 1.5 13h13a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 14.5 3zm13 1a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .5-.5z"/></svg> Importar Datos (.txt)';

            if (isLoading) {
                if (downloadImageBtn) downloadImageBtn.innerHTML = loadingSpinner;
                if (downloadPdfBtn) downloadPdfBtn.innerHTML = loadingSpinner;
                if (exportDataBtn) exportDataBtn.innerHTML = loadingSpinner;
                if (importDataBtn) importDataBtn.innerHTML = loadingSpinner; // Aunque no deberÃ­a estar activo
            } else {
                if (downloadImageBtn) downloadImageBtn.innerHTML = imgIconHTML;
                if (downloadPdfBtn) downloadPdfBtn.innerHTML = pdfIconHTML;
                if (exportDataBtn) exportDataBtn.innerHTML = exportDataIconHTML;
                if (importDataBtn) importDataBtn.innerHTML = importDataIconHTML;
            }
        }
        async function captureCalendar(options = {}) {
            try {
                // AÃ±adir un pequeÃ±o margen inferior para asegurar que no se corte el borde
                const calendarElement = document.getElementById('calendar');
                const containerElement = document.getElementById('calendarContainer');
                const originalPadding = containerElement.style.paddingBottom;
                containerElement.style.paddingBottom = '30px'; // Aumentar temporalmente padding

                const targetWidth = 1200; // Ancho deseado para la captura
                const canvas = await html2canvas(containerElement, { // Capturar el contenedor para incluir tÃ­tulo y botones si estÃ¡n visibles
                    scale: 2, // Mayor resoluciÃ³n
                    useCORS: true,
                    logging: false,
                    allowTaint: true,
                    backgroundColor: '#ffffff', // Fondo blanco explÃ­cito
                    width: targetWidth,
                    windowWidth: targetWidth,
                    // Ignorar elementos que no queremos en la captura
                    ignoreElements: (element) => element.classList.contains('action-buttons') || element.tagName === 'BUTTON' || element.tagName === 'INPUT',
                    ...options
                });

                containerElement.style.paddingBottom = originalPadding; // Restaurar padding

                return canvas;
            } catch (err) {
                console.error("Error html2canvas:", err);
                // Restaurar padding en caso de error tambiÃ©n
                const containerElement = document.getElementById('calendarContainer');
                containerElement.style.paddingBottom = originalPadding;
                throw err;
            }
        }
        downloadImageBtn.addEventListener('click', async () => {
            setExportButtonLoading(true);
            await new Promise(resolve => setTimeout(resolve, 100)); // PequeÃ±a pausa para renderizado UI
            try {
                const canvas = await captureCalendar();
                const imageData = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = imageData;
                link.download = 'calendario-reservas.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                Swal.fire({ icon: 'success', title: 'Imagen generada', showConfirmButton: false, timer: 1500 });
            } catch (err) {
                console.error("Error generando imagen:", err);
                Swal.fire('Error', 'No se pudo generar la imagen. Revisa la consola para detalles.', 'error');
            }
            finally { setExportButtonLoading(false); }
        });
        downloadPdfBtn.addEventListener('click', async () => {
            setExportButtonLoading(true);
            await new Promise(resolve => setTimeout(resolve, 100)); // PequeÃ±a pausa
            const { jsPDF } = window.jspdf;
            try {
                const canvas = await captureCalendar();
                const imgData = canvas.toDataURL('image/jpeg', 0.92); // Usar JPEG para PDF, puede ser mÃ¡s eficiente

                const imgProps = { width: canvas.width, height: canvas.height };
                const pdfWidth = 595.28; // Ancho A4 en puntos (pt)
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width; // Calcular altura proporcional

                // Determinar orientaciÃ³n basada en la proporciÃ³n (si es mÃ¡s ancho que alto)
                const orientation = pdfWidth > pdfHeight ? 'l' : 'p';

                // Crear PDF en tamaÃ±o A4 con la orientaciÃ³n calculada
                const pdf = new jsPDF({ orientation: orientation, unit: 'pt', format: 'a4' });

                // AÃ±adir imagen al PDF, ajustando al ancho de la pÃ¡gina A4
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);

                pdf.save('calendario-reservas.pdf');
                Swal.fire({ icon: 'success', title: 'PDF generado', showConfirmButton: false, timer: 1500 });
            } catch (err) {
                console.error("Error generando PDF:", err);
                Swal.fire('Error', 'No se pudo generar el PDF. Revisa la consola para detalles.', 'error');
            }
            finally { setExportButtonLoading(false); }
        });
        exportDataBtn.addEventListener('click', () => {
            if (Object.keys(reservas).length === 0) {
                Swal.fire('VacÃ­o', 'No hay reservas para exportar.', 'info');
                return;
            }
            try {
                const dataString = JSON.stringify(reservas, null, 2); // Formato JSON legible
                const blob = new Blob([dataString], { type: 'application/json;charset=utf-8' }); // Cambiado a JSON type
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `calendario_reservas_${new Date().toISOString().split('T')[0]}.json`; // Nombre con fecha y extensiÃ³n .json
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                Swal.fire('Â¡Exportado!', 'Datos guardados en formato JSON (.json)', 'success');
            } catch (error) {
                console.error("Error exportando datos:", error);
                Swal.fire('Error', 'OcurriÃ³ un error al exportar los datos.', 'error');
            }
        });
        importDataBtn.addEventListener('click', () => { fileInput.click(); });
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tipo de archivo (opcional pero recomendado)
            if (!file.type.match('application/json') && !file.name.endsWith('.json') && !file.name.endsWith('.txt')) {
                Swal.fire('Archivo InvÃ¡lido', 'Por favor, selecciona un archivo .json o .txt que contenga datos JSON vÃ¡lidos.', 'error');
                fileInput.value = null; // Resetear input
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const fileContent = e.target.result;
                try {
                    const importedData = JSON.parse(fileContent);

                    // ValidaciÃ³n bÃ¡sica de la estructura importada
                    if (typeof importedData !== 'object' || importedData === null || Array.isArray(importedData)) {
                        throw new Error("El archivo no contiene un objeto JSON vÃ¡lido en la raÃ­z.");
                    }

                    // ValidaciÃ³n mÃ¡s especÃ­fica (opcional): verificar si las claves y valores tienen sentido
                    let dataIsValid = true;
                    for (const key in importedData) {
                        if (typeof key !== 'string' || key.indexOf('-') === -1 || typeof importedData[key] !== 'object' || !importedData[key].nombre || !importedData[key].horaInicio) {
                            console.warn(`Entrada invÃ¡lida encontrada durante la importaciÃ³n: Clave "${key}"`, importedData[key]);
                            dataIsValid = false;
                            // Decide si quieres detener la importaciÃ³n o solo advertir
                            // throw new Error(`Formato de reserva invÃ¡lido para la clave "${key}".`);
                        }
                    }
                    if (!dataIsValid) {
                        // PodrÃ­as preguntar al usuario si quiere continuar a pesar de las advertencias
                        console.warn("Algunas entradas en el archivo importado podrÃ­an tener un formato inesperado.");
                    }


                    Swal.fire({
                        title: 'Confirmar ImportaciÃ³n',
                        html: `Se encontraron <b>${Object.keys(importedData).length}</b> reservas en el archivo.<br>Â¿Deseas reemplazar <b>TODAS</b> las reservas actuales con las del archivo? <br><b style='color:red;'>Â¡Esta acciÃ³n es irreversible!</b>`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'SÃ­, reemplazar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            reservas = importedData; // Reemplazar datos en memoria
                            guardarReservasEnLocalStorage(); // Guardar los nuevos datos
                            renderCalendar(); // Actualizar la interfaz
                            Swal.fire('Â¡Importado!', 'Las reservas han sido actualizadas desde el archivo.', 'success');
                        }
                    });
                } catch (error) {
                    console.error("Error procesando archivo importado:", error);
                    Swal.fire('Error de ImportaciÃ³n', `No se pudo procesar el archivo. AsegÃºrate de que sea un archivo JSON vÃ¡lido.\nError: ${error.message}`, 'error');
                }
                finally {
                    fileInput.value = null; // Resetear input para permitir seleccionar el mismo archivo de nuevo
                }
            };
            reader.onerror = (e) => {
                Swal.fire('Error de Lectura', 'No se pudo leer el archivo seleccionado.', 'error');
                fileInput.value = null; // Resetear input
            };
            reader.readAsText(file); // Leer como texto
        });
        // --- INICIALIZACIÃN ---
        document.addEventListener('DOMContentLoaded', cargarReservasDesdeLocalStorage);
    </script>

</body>

</html>