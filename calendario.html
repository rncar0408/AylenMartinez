<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Calendario de Reservas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
        integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
        integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
        integrity="sha512-r22gChDnGvCbOBVEEYcvbRPcfTaXflcJrycv5fK7NfYMhAxtQQEz3O4ht6iAnWvSMnCjU/hV9YEr7+5JaK9MAA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" onload="xlsxScriptLoaded()"
        onerror="xlsxScriptFailed()"></script>
    <style>
        body {
            background-color: #dde9ce !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            line-height: 1.6;
            color: #495057
        }

        .calendar-container {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .09);
            margin-bottom: 30px;
            border: 1px solid #d8e0cc;
            position: relative
        }

        .back-to-dashboard {
            color: #0d6efd;
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: color 0.2s ease;
        }

        .back-to-dashboard:hover {
            color: #5a7d2a
        }

        .back-to-dashboard svg {
            width: 1em;
            height: 1em;
            margin-right: 3px;
            vertical-align: text-bottom
        }

        .calendar-title {
            text-align: center;
            margin-bottom: 15px;
            font-weight: 600;
            color: #5a7d2a;
            padding-top: 25px
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1.5rem;
            margin-top: 25px;
            overflow: visible
        }

        @media (max-width:1200px) {
            .calendar {
                grid-template-columns: repeat(3, 1fr)
            }
        }

        @media (max-width:768px) {
            .calendar {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem
            }
        }

        @media (max-width:576px) {
            .calendar {
                grid-template-columns: 1fr;
                gap: 1rem
            }

            .action-buttons .btn {
                width: calc(50% - 10px)
            }
        }

        .day {
            background: #fdfdfd;
            border: 1px solid #e0e7d1;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, .05);
            min-height: 380px
        }

        .day h5 {
            border-bottom: 1px solid #e0e7d1;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            color: #5a7d2a;
            text-align: center;
            font-size: 1.1rem
        }

        .hour {
            background: #f8f9fa;
            color: #495057;
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            transition: background-color .2s ease, transform .1s ease, box-shadow .2s ease;
            border: 1px solid #dee2e6;
            font-size: .9rem
        }

        .hour:hover:not(.reserved) {
            background-color: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, .08)
        }

        .reserved {
            color: #fff;
            cursor: pointer;
            font-weight: 700;
            padding: 12px;
            font-size: .9rem;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: center;
            border: 1px solid transparent;
            transition: filter .2s ease, transform .1s ease, box-shadow .2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, .1)
        }

        .tipo-individual {
            background-color: #ffe0b3;
            border-color: #ffe0b3;
            color: #333
        }

        .tipo-grupal {
            background-color: #c7e89b;
            border-color: #c7e89b;
            color: #333
        }

        .tipo-ayuda-ingreso {
            background-color: #b3e6f2;
            border-color: #b3e6f2;
            color: #333
        }

        .tipo-desde-tres-anios {
            background-color: #b3e6f2;
            border-color: #b3e6f2;
            color: #333
        }

        .tipo-piano-terapeutico {
            background-color: #f59e90;
            border-color: #e38e80;
            color: #333
        }

        .tipo-default {
            background-color: #6c757d;
            border-color: #5c636a;
            color: #fff
        }

        .reserved strong {
            display: block;
            margin-bottom: 4px;
            font-size: .95rem
        }

        .reserved small {
            font-weight: 400;
            font-style: italic;
            display: block;
            margin-top: 3px;
            font-size: .8rem;
            opacity: .9
        }

        .reserved:hover {
            filter: brightness(95%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, .15)
        }

        .modal-header {
            background-color: #8fa376;
            color: #fff;
            border-bottom: none;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            padding: 1rem 1.5rem
        }

        .modal-content {
            border-radius: 13px;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, .2)
        }

        .modal-body {
            padding: 1.5rem
        }

        .modal-footer {
            border-top: 1px solid #dee2e6;
            padding: 1rem 1.5rem
        }

        .swal2-container {
            z-index: 1060;
            justify-content: center !important;
            align-items: center !important
        }

        .action-buttons {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px
        }

        .action-buttons .btn {
            flex-grow: 0;
            flex-shrink: 0
        }

        /* --- Back to Top Button Styles --- */
        #backToTopBtn {
            display: none;
            /* Hidden by default */
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: #5a7d2a;
            /* Theme green */
            color: white;
            cursor: pointer;
            padding: 0;
            /* Remove padding for exact size */
            border-radius: 50%;
            /* Round shape */
            width: 50px;
            height: 50px;
            font-size: 24px;
            /* Icon size */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: opacity 0.3s ease-in-out, background-color 0.2s;
            /* Center icon */
            justify-content: center;
            align-items: center;
        }

        #backToTopBtn:hover {
            background-color: #486623;
            /* Darker green on hover */
        }

        #backToTopBtn.show {
            display: flex;
            /* Use flex to keep icon centered */
            opacity: 1;
        }

        /* --- End Back to Top Button Styles --- */
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="..."
        crossorigin="anonymous" referrerpolicy="no-referrer" onload="xlsxScriptLoaded()" onerror="xlsxScriptFailed()">
        </script>
</head>

<body style="background-color: #dde9ce !important;">
    <div class="container py-4">
        <div class="calendar-container" id="calendarContainer">
            <div class="mb-4">
                <a href="dashboard.html" class="back-to-dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-arrow-left-short" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5" />
                    </svg>
                    Volver al Dashboard
                </a>
            </div>
            <h2 class="calendar-title">Calendario de Clases Semanal</h2>
            <div class="action-buttons">
                <button id="downloadImageBtn" class="btn btn-sm" boton cancelar modal
                    style="background-color: #f3a391;"> <svg class="bi me-1" width="16" height="16" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0" />
                        <path
                            d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z" />
                    </svg> Exportar Imagen </button>
                <button id="downloadPdfBtn" class="btn btn-sm"
                    style="background-color: #fae39e; border-color: #fae39e; color: black;"> <svg class="bi me-1"
                        width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path
                            d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z" />
                        <!-- Corrected missing path data -->
                        <path fill-rule="evenodd"
                            d="M5 11.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5" />

                    </svg> Exportar PDF </button>
                <button id="exportExcelBtn" class="btn btn-sm"
                    style="background-color: #c0d5c1; border-color: #c0d5c1;color: black;"> <svg
                        xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-file-earmark-spreadsheet me-1" viewBox="0 0 16 16">
                        <path
                            d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V9h-3V6h1V4.5h-1A1.5 1.5 0 0 1 9.5 3M3 11h10v1h-3v2h3v1h-3v2H9v-2H6v2H5v-2H3z" />
                        <!-- Corrected missing path data -->
                        <path d="M3 6h10v3H3z" />
                    </svg> Exportar Excel </button>
                <button id="exportDataBtn" class="btn btn-sm"
                    style="background-color: #d9e6cc; border-color: #d9e6cc; color: black;"> <svg
                        xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-file-code me-1" viewBox="0 0 16 16">
                        <path
                            d="M14.5 14a1.5 1.5 0 0 1-1.5 1.5H3A1.5 1.5 0 0 1 1.5 14V2A1.5 1.5 0 0 1 3 0.5H13A1.5 1.5 0 0 1 14.5 2zm-1.5.5a.5.5 0 0 0 .5-.5V2a.5.5 0 0 0-.5-.5H3a.5.5 0 0 0-.5.5v12a.5.5 0 0 0 .5.5z" />
                        <path
                            d="M6.854 4.646a.5.5 0 0 1 0 .708L4.207 8l2.647 2.646a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 0 1 .708 0m2.292 0a.5.5 0 0 0 0 .708L11.793 8l-2.647 2.646a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708 0" />
                    </svg> Exportar JSON </button>
                <button id="importDataBtn" class="btn btn-sm"
                    style="background-color: #96a5c0; border-color: #96a5c0; color: black;"> <svg class="bi me-1"
                        width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M3.5 10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5" />
                        <path d="M4 1a1 1 0 0 0-1 1v1h1V2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 .5.5v1h1V2a1 1 0 0 0-1-1z" />
                        <path
                            d="M4 5.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5M4 7.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m1 4v1H4v-1zm4 0v1H8v-1zm4 0v1h-1v-1z" />
                        <path fill-rule="evenodd"
                            d="M1.5 3A1.5 1.5 0 0 0 0 4.5v7A1.5 1.5 0 0 0 1.5 13h13a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 14.5 3zm13 1a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .5-.5z" />
                    </svg> Importar JSON </button>
                <input type="file" id="fileInput" accept=".txt, .json" style="display: none;" />
            </div>
            <div class="calendar" id="calendar">
                <div class="text-center w-100" style="grid-column: 1 / -1; padding: 20px;">Cargando calendario...</div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="reservaModal" tabindex="-1" aria-labelledby="reservaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #c0d5c1; border-color: #c0d5c1; color: black;">
                    <h5 class="modal-title" id="reservaModalLabel">Detalles Clase</h5><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="reservaForm" novalidate> <input type="hidden" id="reservaDia" /> <input type="hidden"
                            id="reservaHora" />
                        <div class="row g-3">
                            <div class="col-md-6 mb-3"> <label for="horaInicio" class="form-label">Inicio</label> <input
                                    type="time" class="form-control bg-light" id="horaInicio" readonly /> </div>
                            <div class="col-md-6 mb-3"> <label for="horaFin" class="form-label">Fin</label> <input
                                    type="time" class="form-control bg-light" id="horaFin" readonly /> </div>
                            <div class="col-12 mb-3"> <label for="nombre" class="form-label">Nombre</label> <input
                                    type="text" id="nombre" class="form-control" required />
                                <div class="invalid-feedback">Ingresa un nombre.</div>
                            </div>
                            <div class="col-md-6 mb-3"> <label for="tipo" class="form-label">Tipo</label> <select
                                    id="tipo" class="form-select" required>
                                    <option>Individual</option>
                                    <option>Grupal</option>
                                    <option>Ayuda Ingreso a institutos</option>
                                    <!-- <option>Desde los 3 años</option> -->
                                    <!-- <option>Piano terapéutico</option> -->
                                </select> </div>
                            <div class="col-md-6 mb-3"> <label for="duracion" class="form-label">Duración</label>
                                <select id="duracion" class="form-select" required>
                                    <option value="40">40 min</option>
                                    <option value="60">1 hora</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer"> <button type="button" class="btn me-auto" boton cancelar modal
                        style="background-color: #f3a391;" id="eliminarBtn" style="display: none;"> <svg class="bi me-1"
                            width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z" />
                            <path
                                d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z" />
                        </svg> Eliminar </button> <button type="button" class="btn"
                        style="background-color: #fae39e; border-color: #fae39e; color: black;"
                        data-bs-dismiss="modal">Cancelar</button> <button type="button" class="btn"
                        style="background-color: #d9e6cc; border-color: #d9e6cc; color: black;" id="guardarBtn"> Guardar
                    </button> </div>
            </div>
        </div>
    </div>

    <!-- Back to Top Button HTML -->
    <button id="backToTopBtn" title="Volver arriba"
        style="background-color: #5b7d2b; border-color: #5b7d2b; color: black;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-arrow-up-short"
            viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M8 12a.5.5 0 0 0 .5-.5V5.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 5.707V11.5a.5.5 0 0 0 .5.5" />
        </svg>
    </button>
    <!-- End Back to Top Button HTML -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function xlsxScriptLoaded() {
            console.log("XLSX loaded.");
            const e = document.getElementById("exportExcelBtn"); e ? e.disabled = !1 : setTimeout(() => {
                const e = document.getElementById("exportExcelBtn"); e ? e.disabled = !1 : console.error("Excel export button not found after delay.")
            }, 500)
        } function xlsxScriptFailed() {
            console.error("Failed to load XLSX library.");
            const e = document.getElementById("exportExcelBtn");
            e && (e.title = "Error al cargar librería Excel",
                e.classList.add("btn-danger"),
                e.innerHTML = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z"/></svg> Error Excel'), Swal.fire("Error Crítico", "No se pudo cargar la librería necesaria para exportar a Excel. Por favor, revisa tu conexión a internet y recarga la página.", "error")
        } !function () { emailjs.init({ publicKey: "qOfrwmjiPJNVT91sk" }) }(); const calendar = document.getElementById("calendar"), downloadImageBtn = document.getElementById("downloadImageBtn"), downloadPdfBtn = document.getElementById("downloadPdfBtn"), exportDataBtn = document.getElementById("exportDataBtn"), importDataBtn = document.getElementById("importDataBtn"), exportExcelBtn = document.getElementById("exportExcelBtn"), fileInput = document.getElementById("fileInput"), reservaForm = document.getElementById("reservaForm"), eliminarBtn = document.getElementById("eliminarBtn"), guardarBtn = document.getElementById("guardarBtn"), duracionSelect = document.getElementById("duracion"), days = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"], startHour = 900, endHour = 1260, hours = [], generationIntervalMinutes = 20; for (let e = startHour; e < endHour; e += generationIntervalMinutes)hours.push(e); const localKey = "reservasCalendarioV2"; let reservas = {}; function formatHora(e) { const t = Math.floor(e / 60).toString().padStart(2, "0"), o = (e % 60).toString().padStart(2, "0"); return `${t}:${o}` } function getTipoClass(e) { switch (e) { case "Individual": return "tipo-individual"; case "Grupal": return "tipo-grupal"; case "Ayuda Ingreso a institutos": return "tipo-ayuda-ingreso"; case "Desde los 3 años": return "tipo-desde-tres-anios"; case "Piano terapéutico": return "tipo-piano-terapeutico"; default: return console.warn(`Tipo desconocido: "${e}". Usando default.`), "tipo-default" } } function guardarReservasEnLocalStorage() { try { localStorage.setItem(localKey, JSON.stringify(reservas)), console.log("Reservas guardadas.") } catch (e) { console.error("Error guardando:", e), Swal.fire("Error", "No se pudieron guardar.", "error") } } function cargarReservasDesdeLocalStorage() { calendar.innerHTML = '<div class="text-center w-100" style="grid-column: 1 / -1; padding: 20px;">Cargando...</div>'; try { const e = localStorage.getItem(localKey); reservas = e ? JSON.parse(e) : {}, console.log("Reservas cargadas.") } catch (e) { console.error("Error cargando:", e), reservas = {}, Swal.fire("Error", "Datos corruptos.", "warning") } requestAnimationFrame(() => setTimeout(renderCalendar, 0)) }
        function renderCalendar() {
            calendar.innerHTML = "",
                days.forEach(e => {
                    const t = document.createElement("div");
                    t.className = "day",
                        t.innerHTML = `<h5>${e}</h5>`,
                        hours.forEach(o => {
                            const n = formatHora(o),
                                a = `${e}-${n}`,
                                r = reservas[a];
                            if (r) {
                                const s = document.createElement("div"),
                                    i = r.tipo,
                                    l = getTipoClass(i);
                                s.classList.add("hour", "reserved", l),
                                    s.innerHTML = `<strong>${r.nombre}</strong><br>${r.horaInicio} - ${r.horaFin} (${r.duracion} min)<br><small>${r.tipo}</small>`,
                                    s.onclick = () => abrirModal(e, n, r), t.appendChild(s)
                            } else if (!estaEnReserva(e, o) && canFitReservation(e, o, 40)) { const s = document.createElement("div"); s.className = "hour", s.textContent = n, s.onclick = () => abrirModal(e, n, null), t.appendChild(s) }
                        }), calendar.appendChild(t)
                })
        } function estaEnReserva(e, t) { for (const o in reservas) { const n = reservas[o]; if (!o || "string" != typeof o || o.indexOf("-") === -1) continue; const a = o.split("-"); if (a.length < 2) continue; const r = a.slice(0, -1).join("-"); if (r !== e || !n || "object" != typeof n || !n.horaInicio || "string" != typeof n.horaInicio || "number" != typeof n.duracion || isNaN(n.duracion)) continue; const s = n.horaInicio.split(":"); if (s.length !== 2) continue; const i = parseInt(s[0], 10), l = parseInt(s[1], 10); if (isNaN(i) || isNaN(l)) continue; const c = 60 * i + l, d = c + n.duracion; if (t >= c && t < d) return !0 } return !1 } function canFitReservation(e, t, o) { const n = t + o; if (n > endHour) return !1; for (const a in reservas) { const r = reservas[a]; if (!a || "string" != typeof a || a.indexOf("-") === -1) continue; const s = a.split("-"); if (s.length < 2) continue; const i = s.slice(0, -1).join("-"); if (i !== e || !r || "object" != typeof r || !r.horaInicio || "string" != typeof r.horaInicio || "number" != typeof r.duracion || isNaN(r.duracion)) continue; const l = r.horaInicio.split(":"); if (l.length !== 2) continue; const c = parseInt(l[0], 10), d = parseInt(l[1], 10); if (isNaN(c) || isNaN(d)) continue; const u = 60 * c + d, h = u + r.duracion; if (t < h && n > u) return !1 } return !0 } function actualizarHoraFin() { const e = document.getElementById("horaInicio").value, t = parseInt(duracionSelect.value); if (!e || isNaN(t) || t <= 0) return document.getElementById("horaFin").value = "", guardarBtn.disabled = !0, void 0; const [o, n] = e.split(":").map(Number), a = 60 * o + n, r = a + t; r > endHour ? (document.getElementById("horaFin").value = formatHora(endHour), guardarBtn.disabled = !0, Swal.fire({ icon: "warning", title: "Hora Inválida", text: `Termina después de ${formatHora(endHour)}.`, timer: 3e3, showConfirmButton: !1 })) : (document.getElementById("horaFin").value = formatHora(r), guardarBtn.disabled = !1) } function abrirModal(e, t, o) { reservaForm.classList.remove("was-validated"), document.getElementById("reservaDia").value = e, document.getElementById("reservaHora").value = t, document.getElementById("nombre").value = o?.nombre || "", document.getElementById("tipo").value = o?.tipo || "Individual", duracionSelect.value = o?.duracion || 40, document.getElementById("horaInicio").value = o?.horaInicio || t, actualizarHoraFin(), eliminarBtn.style.display = o ? "inline-block" : "none"; const n = new bootstrap.Modal(document.getElementById("reservaModal")); n.show() } duracionSelect.addEventListener("change", actualizarHoraFin); function enviarCorreoReserva(e) { const t = "service_93zs6up", o = "template_352le9n", n = { day: e.dia, horaInicio: e.horaInicio, horaFin: e.horaFin, name: e.nombre, type: e.tipo, duration: e.duracion, ac1: e.ac1, ac2: e.ac2 }; console.log("Enviando correo:", n), emailjs.send(t, o, n).then(e => { console.log("Éxito!", e.status, e.text); const t = Swal.mixin({ toast: !0, position: "top-end", showConfirmButton: !1, timer: 2e3, timerProgressBar: !0, didOpen: e => { e.onmouseenter = Swal.stopTimer, e.onmouseleave = Swal.resumeTimer } }); t.fire({ icon: "info", title: "Notificación enviada." }) }).catch(e => { console.error("Error correo:", e), Swal.fire({ title: "Error Notificación", text: `Reserva guardada, error al enviar correo: ${e.text || "Desconocido"}`, icon: "warning", timer: 4e3, showConfirmButton: !0 }) }) } guardarBtn.onclick = () => { if (!reservaForm.checkValidity()) return reservaForm.classList.add("was-validated"), void 0; const e = document.getElementById("reservaDia").value, t = document.getElementById("horaInicio").value, o = document.getElementById("nombre").value.trim(), n = document.getElementById("tipo").value, a = parseInt(duracionSelect.value); if (isNaN(a) || a <= 0) return Swal.fire("Error", "Duración inválida.", "error"), void 0; const [r, s] = t.split(":").map(Number), i = 60 * r + s, l = i + a; if (l > endHour) return Swal.fire("Error", `Termina después de ${formatHora(endHour)}.`, "error"), void 0; const c = formatHora(l), d = `${e}-${t}`; let u = !1, h = null; for (const g in reservas) { if (g === d) continue; const f = reservas[g]; if (!g || g.indexOf("-") === -1) continue; const m = g.split("-"); if (m.length < 2) continue; const p = m.slice(0, -1).join("-"); if (p !== e || !f || !f.horaInicio || !f.duracion || isNaN(f.duracion)) continue; const w = f.horaInicio.split(":"); if (w.length !== 2) continue; const E = parseInt(w[0], 10), I = parseInt(w[1], 10); if (isNaN(E) || isNaN(I)) continue; const L = 60 * E + I, S = L + f.duracion; if (i < S && l > L) { u = !0, h = f; break } } if (u) return Swal.fire("Conflicto", `Se solapa con "${h.nombre}" (${h.horaInicio}-${h.horaFin}).`, "error"), void 0; const b = eliminarBtn.style.display !== "none", v = () => { let r, s; b ? (r = "modificaste la reserva a nombre de", s = ", con las siguientes características:") : (r = "Te recuerdo que registraste una reserva a nombre de", s = ", con las siguientes características:"); const i = { nombre: o, tipo: n, duracion: a, horaInicio: t, horaFin: c }, l = document.getElementById("reservaHora").value, u = `${e}-${l}`; b && d !== u && reservas[u] && delete reservas[u], reservas[d] = i, guardarReservasEnLocalStorage(); const h = { dia: e, horaInicio: t, horaFin: c, nombre: o, tipo: n, duracion: a, ac1: r, ac2: s }; enviarCorreoReserva(h); const g = document.getElementById("reservaModal"), f = bootstrap.Modal.getInstance(g); f && f.hide(), renderCalendar(), Swal.fire({ icon: "success", title: "¡Guardado!", text: `Reserva para ${o} guardada.`, showConfirmButton: !1, timer: 1500 }) }; b ? Swal.fire({ title: "Confirmar", text: `Guardar cambios para "${o}"?`, icon: "question", showCancelButton: !0, confirmButtonColor: "#d9e6cc", cancelButtonColor: "#f3a391", confirmButtonText: "Sí", cancelButtonText: "No" }).then(e => { e.isConfirmed && v() }) : v() }, eliminarBtn.onclick = () => {
            const e = document.getElementById("reservaDia").value, t = document.getElementById("horaInicio").value, o = `${e}-${t}`; if (!reservas[o]) return Swal.fire("Error", "Reserva no encontrada.", "error"), void 0; Swal.fire({ title: "¿Seguro?", text: `Eliminar reserva de "${reservas[o]?.nombre || "clase"}". ¡Irreversible!`, icon: "warning", showCancelButton: !0, confirmButtonColor: "#d9e6cc", cancelButtonColor: "#f3a391", confirmButtonText: "Sí", cancelButtonText: "No" }).then(e => {
                if (e.isConfirmed) if (reservas[o]) {
                    delete reservas[o],
                        guardarReservasEnLocalStorage();
                    const e = document.getElementById("reservaModal"),
                        t = bootstrap.Modal.getInstance(e); t && t.hide(),
                            renderCalendar(),
                            Swal.fire("¡Eliminado!",
                                "Reserva eliminada.",
                                "success")
                } else Swal.fire("Error", "No se pudo eliminar.", "error"), renderCalendar()
            })
        }; function setExportButtonLoading(e) {
            const t = [downloadImageBtn, downloadPdfBtn, exportExcelBtn, exportDataBtn, importDataBtn];
            t.forEach(t => { t && "exportExcelBtn" !== t.id && (t.disabled = e) }), exportExcelBtn && (exportExcelBtn.disabled = e || "undefined" == typeof window.XLSX);
            const o = '<span class="spinner-border spinner-border-sm" role="status"></span> Proc...',
                n = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/><path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/></svg> Imagen', a = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/><path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5"/></svg> PDF', r = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V9h-3V6h1V4.5h-1A1.5 1.5 0 0 1 9.5 3M3 11h10v1h-3v2h3v1h-3v2H9v-2H6v2H5v-2H3z"/><path d="M3 6h10v3H3z"/></svg> Excel', s = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M14.5 14a1.5 1.5 0 0 1-1.5 1.5H3A1.5 1.5 0 0 1 1.5 14V2A1.5 1.5 0 0 1 3 0.5H13A1.5 1.5 0 0 1 14.5 2zm-1.5.5a.5.5 0 0 0 .5-.5V2a.5.5 0 0 0-.5-.5H3a.5.5 0 0 0-.5.5v12a.5.5 0 0 0 .5.5z"/><path d="M6.854 4.646a.5.5 0 0 1 0 .708L4.207 8l2.647 2.646a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 0 1 .708 0m2.292 0a.5.5 0 0 0 0 .708L11.793 8l-2.647 2.646a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708 0"/></svg> JSON', i = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M3.5 10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5"/><path d="M4 1a1 1 0 0 0-1 1v1h1V2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 .5.5v1h1V2a1 1 0 0 0-1-1z"/><path d="M4 5.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5M4 7.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m1 4v1H4v-1zm4 0v1H8v-1zm4 0v1h-1v-1z"/><path fill-rule="evenodd" d="M1.5 3A1.5 1.5 0 0 0 0 4.5v7A1.5 1.5 0 0 0 1.5 13h13a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 14.5 3zm13 1a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .5-.5z"/></svg> Importar';
            e ? (downloadImageBtn && (downloadImageBtn.innerHTML = o), downloadPdfBtn && (downloadPdfBtn.innerHTML = o),
                exportExcelBtn && (exportExcelBtn.innerHTML = o),
                exportDataBtn && (exportDataBtn.innerHTML = o),
                importDataBtn && (importDataBtn.innerHTML = o)) : (downloadImageBtn && (downloadImageBtn.innerHTML = n),
                    downloadPdfBtn && (downloadPdfBtn.innerHTML = a),
                    exportExcelBtn && ("undefined" != typeof window.XLSX ? exportExcelBtn.innerHTML = r : exportExcelBtn.innerHTML = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z"/></svg> Error Excel'),
                    exportDataBtn && (exportDataBtn.innerHTML = s),
                    importDataBtn && (importDataBtn.innerHTML = i))
        }
        async function captureCalendar(e = {}) { try { const t = document.getElementById("calendarContainer"), o = t.style.paddingBottom; t.style.paddingBottom = "30px"; const n = 1200, a = await html2canvas(t, { scale: 2, useCORS: !0, logging: !1, allowTaint: !0, backgroundColor: "#ffffff", width: n, windowWidth: n, ignoreElements: e => e.classList.contains("action-buttons") || "BUTTON" === e.tagName || "INPUT" === e.tagName, ...e }); return t.style.paddingBottom = o, a } catch (e) { console.error("Err html2canvas:", e); const t = document.getElementById("calendarContainer"); throw t.style.paddingBottom = originalPadding, e } } downloadImageBtn.addEventListener("click", async () => { setExportButtonLoading(!0), await new Promise(e => setTimeout(e, 100)); try { const e = await captureCalendar(), t = e.toDataURL("image/png"), o = document.createElement("a"); o.href = t, o.download = "calendario-reservas.png", document.body.appendChild(o), o.click(), document.body.removeChild(o), Swal.fire({ icon: "success", title: "Imagen OK", showConfirmButton: !1, timer: 1500 }) } catch (e) { console.error("Err IMG:", e), Swal.fire("Error", "No se generó imagen.", "error") } finally { setExportButtonLoading(!1) } }), downloadPdfBtn.addEventListener("click", async () => { setExportButtonLoading(!0), await new Promise(e => setTimeout(e, 100)); const { jsPDF: e } = window.jspdf; try { const t = await captureCalendar(), o = t.toDataURL("image/jpeg", .92), n = { width: t.width, height: t.height }, a = 595.28, r = n.height * a / n.width, s = a > r ? "l" : "p", i = new e({ orientation: s, unit: "pt", format: "a4" }); i.addImage(o, "JPEG", 0, 0, a, r), i.save("calendario-reservas.pdf"), Swal.fire({ icon: "success", title: "PDF OK", showConfirmButton: !1, timer: 1500 }) } catch (e) { console.error("Err PDF:", e), Swal.fire("Error", "No se generó PDF.", "error") } finally { setExportButtonLoading(!1) } }), exportDataBtn.addEventListener("click", () => { if (0 === Object.keys(reservas).length) return Swal.fire("Vacío", "No hay reservas.", "info"), void 0; try { const e = JSON.stringify(reservas, null, 2), t = new Blob([e], { type: "application/json;charset=utf-8" }), o = URL.createObjectURL(t), n = document.createElement("a"); n.href = o, n.download = `reservas_${(new Date).toISOString().split("T")[0]}.json`, document.body.appendChild(n), n.click(), document.body.removeChild(n), URL.revokeObjectURL(o), Swal.fire("Exportado", "Datos JSON guardados.", "success") } catch (e) { console.error("Err Exp:", e), Swal.fire("Error", "No se exportaron datos.", "error") } }); function exportarExcel() { if ("undefined" == typeof window.XLSX) return console.error("XLSX not loaded!"), Swal.fire("Error", "Librería Excel no cargada.", "error"), void 0; if (0 === Object.keys(reservas).length) return Swal.fire("Vacío", "No hay reservas.", "info"), void 0; setExportButtonLoading(!0); try { const e = [], t = ["Día", "Inicio", "Fin", "Nombre", "Tipo", "Duración"]; e.push(t); const o = Object.keys(reservas).sort((e, t) => { const [o, n] = e.split("-"), [a, r] = t.split("-"), s = days.indexOf(o), i = days.indexOf(a); return s !== i ? s - i : n.localeCompare(r) }); o.forEach(t => { const o = reservas[t], n = t.substring(0, t.lastIndexOf("-")); e.push([n, o.horaInicio, o.horaFin, o.nombre, o.tipo, o.duracion]) }); const n = window.XLSX.utils.aoa_to_sheet(e), a = t.map(e => ({ wch: e.length + 5 })); e.forEach(e => { e.forEach((e, t) => { const o = e ? String(e).length : 0; a[t].wch < o + 2 && (a[t].wch = o + 2) }) }), a.forEach(e => { e.wch > 50 && (e.wch = 50) }), n["!cols"] = a; const r = window.XLSX.utils.book_new(); window.XLSX.utils.book_append_sheet(r, n, "Reservas"); const s = (new Date).toISOString().split("T")[0]; window.XLSX.writeFile(r, `reservas_${s}.xlsx`), Swal.fire("Exportado", "Datos Excel guardados.", "success") } catch (e) { console.error("Err Excel:", e), Swal.fire("Error", "No se generó Excel.", "error") } finally { setExportButtonLoading(!1) } } importDataBtn.addEventListener("click", () => { fileInput.click() }), fileInput.addEventListener("change", e => { const t = e.target.files[0]; if (!t) return; if (!t.name.endsWith(".json") && !t.name.endsWith(".txt")) return Swal.fire("Inválido", "Selecciona .json o .txt.", "error"), void (fileInput.value = null); const o = new FileReader; o.onload = e => { const t = e.target.result; try { const o = JSON.parse(t); if ("object" != typeof o || null === o || Array.isArray(o)) throw new Error("No es objeto JSON."); let n = !0; for (const a in o) if ("string" != typeof a || a.indexOf("-") === -1 || "object" != typeof o[a] || !o[a].nombre || !o[a].horaInicio) console.warn(`Inválido: ${a}`, o[a]), n = !1; n || console.warn("Formato inesperado en datos."), Swal.fire({ title: "Importar", html: `${Object.keys(o).length} reservas.<br>¿Reemplazar <b>TODAS</b>? <b style='color:red;'>¡Irreversible!</b>`, icon: "warning", showCancelButton: !0, confirmButtonColor: "#3085d6", cancelButtonColor: "#d33", confirmButtonText: "Sí", cancelButtonText: "No" }).then(e => { e.isConfirmed && (reservas = o, guardarReservasEnLocalStorage(), renderCalendar(), Swal.fire("Importado", "Datos actualizados.", "success")) }) } catch (e) { console.error("Err Imp:", e), Swal.fire("Error Importación", `No se procesó. ¿JSON?\n${e.message}`, "error") } finally { fileInput.value = null } }, o.onerror = e => { Swal.fire("Error Lectura", "No se leyó archivo.", "error"), fileInput.value = null }, o.readAsText(t) });

        document.addEventListener("DOMContentLoaded", () => {
            cargarReservasDesdeLocalStorage();
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener("click", exportarExcel);
                if (typeof window.XLSX !== 'undefined') {
                    xlsxScriptLoaded();
                }
            } else {
                console.error("Btn Excel no hallado.");
            }

            // --- Back to Top Button Logic ---
            const backToTopButton = document.getElementById("backToTopBtn");
            const scrollThreshold = 200; // Show button after scrolling 200px

            // Function to handle scroll events
            function scrollFunction() {
                if (window.scrollY > scrollThreshold || document.documentElement.scrollTop > scrollThreshold) {
                    if (backToTopButton) backToTopButton.classList.add("show");
                } else {
                    if (backToTopButton) backToTopButton.classList.remove("show");
                }
            }

            // Function to scroll smoothly to the top
            function scrollToTop() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }

            // Attach event listeners only if the button exists
            if (backToTopButton) {
                window.addEventListener('scroll', scrollFunction);
                backToTopButton.addEventListener('click', scrollToTop);
            } else {
                console.error("Back to Top button not found.");
            }
            // --- End Back to Top Button Logic ---

        });
    </script>

</body>

</html>