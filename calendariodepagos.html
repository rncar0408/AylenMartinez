<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Calendario de Pagos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
        integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
        integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
        integrity="sha512-r22gChDnGvCbOBVEEYcvbRPcfTaXflcJrycv5fK7NfYMhAxtQQEz3O4ht6iAnWvSMnCjU/hV9YEr7+5JaK9MAA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" onload="xlsxScriptLoaded()" onerror="xlsxScriptFailed()">
        </script>
    <style>
        /* --- ESTILOS CSS (sin cambios) --- */
        body {
            background-color: #dde9ce !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            line-height: 1.6;
            color: #333;
        }

        .container.py-5 {
            padding-top: 2rem !important;
            padding-bottom: 3rem !important;
        }

        .payment-container {
            background: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .back-to-dashboard {
            color: #0d6efd;
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: color 0.2s ease;
        }

        .back-to-dashboard:hover {
            color: #0a58ca;
            text-decoration: underline;
        }

        .back-to-dashboard svg {
            margin-bottom: 2px;
        }

        .price-section {
            background-color: #f0f4f0;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            align-items: center;
            border: 1px solid #ced4da;
            gap: 15px;
        }

        .price-display {
            text-align: center;
            font-size: 1rem;
            color: #555;
        }

        .price-display span {
            font-weight: bold;
            color: #0d6efd;
            font-size: 1.1rem;
        }

        #editPricesBtn {
            font-weight: 500;
        }

        .month-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            gap: 15px;
        }

        .month-navigation .btn {
            padding: 0.375rem 0.75rem;
        }

        .month-display {
            font-size: 1.6rem;
            font-weight: 500;
            min-width: 200px;
            text-align: center;
            color: #2c3e50;
        }

        hr {
            border-top: 1px solid #ccc;
            margin-top: 25px;
            margin-bottom: 25px;
        }

        .action-buttons-main {
            text-align: center;
            margin-bottom: 25px;
            margin-top: 15px;
            padding: 0 15px;
        }

        .action-buttons-main .btn {
            margin: 6px 10px;
            font-weight: 500;
        }

        #studentListTitle {
            color: #34495e;
            font-weight: 600;
        }

        .student-list {
            list-style: none;
            padding: 0;
        }

        .student-item {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 18px 25px;
            margin-bottom: 15px;
            border-radius: 12px;
            border: 1px solid #d5dce5;
            background-color: #fdfdfe;
            transition: box-shadow 0.25s ease, border-color 0.25s ease;
        }

        .student-item:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
            border-color: #adb5bd;
        }

        .student-info {
            flex: 1 1 45%;
            min-width: 220px;
            padding-right: 15px;
        }

        .payment-status-details {
            flex: 1 1 30%;
            min-width: 190px;
            padding-right: 15px;
        }

        .payment-actions {
            flex: 0 0 auto;
            min-width: 230px;
            /* Aumentar ancho mínimo para acomodar botón extra */
            text-align: right;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            align-items: center;
            flex-wrap: wrap;
            /* Permitir que los botones pasen a la siguiente línea si no caben */
        }

        .payment-actions .btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .student-info span {
            display: block;
            margin-bottom: 2px;
        }

        .student-name {
            font-weight: 600;
            font-size: 1.15rem;
            color: #2c3e50;
        }

        .group-name-display {
            font-size: 0.8rem;
            color: #6c757d;
            font-style: italic;
            margin-top: -2px;
            margin-bottom: 4px !important;
        }

        .class-slot,
        .class-duration {
            font-size: 0.9rem;
            color: #5a6a7a;
        }

        .status-paid-full,
        .status-paid-partial,
        .status-pending,
        .status-recovery {
            font-weight: bold;
            font-size: 0.95rem;
            text-align: right;
            display: block;
        }

        .status-paid-full {
            color: #198754;
        }

        .status-paid-partial {
            color: #ffc107;
        }

        .status-pending {
            color: #dc3545;
        }

        .status-recovery {
            font-style: italic;
            color: #0d6efd;
        }

        .payment-details {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
            text-align: right;
            display: block;
        }

        .modal-header {
            border-bottom: none;
        }

        .modal-header .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        .modal-body p strong {
            color: #333;
        }

        .modal-footer {
            border-top: 1px solid #dee2e6;
            background-color: #f8f9fa;
        }

        #receiptContent {
            border: 1px dashed #aaa;
            padding: 30px;
            margin: 20px auto;
            max-width: 550px;
            font-family: 'Consolas', 'Courier New', Courier, monospace;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        #receiptContent h4 {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            font-size: 1.3rem;
            color: #333;
        }

        #receiptContent p {
            margin-bottom: 10px;
            line-height: 1.6;
            font-size: 1rem;
        }

        #receiptContent p strong {
            display: inline-block;
            min-width: 140px;
        }

        #receiptContent .receipt-footer {
            margin-top: 35px;
            text-align: center;
            font-size: 0.85rem;
            color: #777;
            border-top: 1px dotted #ccc;
            padding-top: 15px;
        }

        .modal-lg-receipt {
            max-width: 700px;
        }

        @media (max-width: 767.98px) {
            .price-section {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 15px;
            }

            .price-display {
                text-align: left;
                padding-left: 10px;
            }

            #editPricesBtn {
                align-self: center;
                margin-top: 10px;
            }

            .student-item {
                flex-direction: column;
                align-items: stretch;
                padding: 15px;
            }

            .student-info,
            .payment-status-details,
            .payment-actions {
                flex-basis: auto;
                width: 100%;
                text-align: left;
                padding-right: 0;
                margin-bottom: 12px;
            }

            .payment-status-details,
            .payment-details,
            .status-paid-full,
            .status-paid-partial,
            .status-pending,
            .status-recovery {
                text-align: left;
            }

            .payment-actions {
                margin-top: 5px;
                justify-content: flex-start;
                margin-bottom: 0;
                flex-wrap: wrap;
            }

            .month-display {
                font-size: 1.4rem;
                min-width: 150px;
            }

            .month-navigation {
                gap: 10px;
            }

            .modal-lg-receipt {
                max-width: 95%;
            }

            #receiptContent {
                padding: 20px;
            }
        }

        @media (max-width: 575.98px) {
            h2 {
                font-size: 1.8rem;
            }

            .payment-container {
                padding: 20px;
            }

            .student-name {
                font-size: 1.1rem;
            }

            .action-buttons-main .btn {
                display: block;
                width: 90%;
                margin: 8px auto;
            }

            .container.py-5 {
                padding-top: 1.5rem !important;
            }

            .payment-actions {
                min-width: 100%;
                /* Hacer que ocupe todo el ancho */
            }
        }

        #backToTopBtn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: #0d6efd;
            color: white;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 50%;
            font-size: 18px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, background-color 0.2s ease;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #backToTopBtn:hover {
            background-color: #0a58ca;
        }

        #backToTopBtn[style*="opacity: 0"] {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <div class="payment-container" id="paymentContainer">
            <!-- Contenido HTML (sin cambios en la estructura general) -->
            <!-- Link Volver al Dashboard -->
            <div class="mb-4">
                <a href="dashboard.html" class="back-to-dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-arrow-left-short" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5" />
                    </svg>
                    Volver al Dashboard
                </a>
            </div>
            <!-- Título Principal -->
            <h2 class="text-center mb-4">Control de Pagos Mensuales</h2>

            <!-- Sección de Precios -->
            <div class="price-section">
                <div class="price-display">Individual 40 min/mes: <span id="price40"></span></div>
                <div class="price-display">Individual 60 min/mes: <span id="price60"></span></div>
                <div class="price-display">Grupal 60 min/mes (x Part.): <span id="priceGrupal"></span></div>
                <button id="editPricesBtn" class="btn btn-sm"
                    style="background-color: #f3a391; border-color: #f3a391; color: black;">Editar Precios</button>
            </div>

            <!-- Navegación de Mes -->
            <div class="month-navigation">
                <button id="prevMonthBtn" class="btn btn-sm"
                    style="background-color: #fae39e; border-color: #fae39e; color: black;"><svg
                        xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-chevron-left" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0" />
                    </svg> Anterior</button>
                <span id="monthDisplay" class="month-display">Cargando...</span>
                <button id="nextMonthBtn" class="btn btn-sm"
                    style="background-color: #fae39e; border-color: #fae39e; color: black;">Siguiente <svg
                        xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-chevron-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708" />
                    </svg></button>
            </div>
            <hr>
            <!-- Botones de Acción Principales -->
            <div class="action-buttons-main">
                <button id="exportDataBtn" class="btn btn-sm"
                    style="background-color: #c0d5c1; border-color: #c0d5c1; color: black;">Exportar Datos
                    (JSON)</button>
                <button id="importDataBtn" class="btn btn-sm"
                    style="background-color: #96a5c0; border-color: #96a5c0; color: black;">Importar Datos
                    (JSON)</button>
                <input type="file" id="fileInput" accept=".json" style="display: none;" />
            </div>
            <hr>

            <!-- Lista de Alumnos -->
            <h4 class="text-center mb-3" id="studentListTitle">Alumnos/Participantes</h4>
            <ul class="student-list" id="studentList">
                <li class="text-center p-4">Cargando alumnos y pagos...</li>
            </ul>
        </div>
    </div>

    <!-- Modal Editar Precios -->
    <div class="modal fade" id="priceModal" tabindex="-1" aria-labelledby="priceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #c0d5c1; border-color: #c0d5c1; color: black;">
                    <h5 class="modal-title" id="priceModalLabel">Editar Precios Base Mensuales</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="priceForm">
                        <div class="mb-3">
                            <label for="basePrice40Input" class="form-label">Precio Mensual (Individual 40 min)</label>
                            <input type="number" id="basePrice40Input" class="form-control" required min="0" step="any">
                        </div>
                        <div class="mb-3">
                            <label for="basePrice60Input" class="form-label">Precio Mensual (Individual 60 min)</label>
                            <input type="number" id="basePrice60Input" class="form-control" required min="0" step="any">
                        </div>
                        <div class="mb-3">
                            <label for="basePriceGrupalInput" class="form-label">Precio Mensual (Grupal 60 min x
                                Participante)</label>
                            <input type="number" id="basePriceGrupalInput" class="form-control" required min="0"
                                step="any">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" style="background-color: #f3a391;"
                        data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn"
                        style="background-color: #d9e6cc; border-color: #d9e6cc; color: black;"
                        id="savePricesBtn">Guardar Precios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Registro/Modificación de Pago -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #c0d5c1; border-color: #c0d5c1; color: black;">
                    <h5 class="modal-title" id="paymentModalLabel">Registrar Pago</h5> <button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm" novalidate>
                        <input type="hidden" id="paymentStudentId" />
                        <input type="hidden" id="paymentYearMonth" />
                        <input type="hidden" id="paymentClassType" />
                        <div class="mb-2"> <label class="form-label">Alumno/Participante:</label>
                            <p><strong id="paymentStudentName"></strong></p>
                        </div>
                        <div class="mb-2"> <label class="form-label">Mes a Pagar:</label>
                            <p><strong id="paymentMonthYearDisplay"></strong> (<span
                                    id="paymentClassCountDisplay"></span> clases)</p>
                        </div>
                        <div class="mb-3"> <label for="paymentClassesPaid" class="form-label">Clases a Pagar</label>
                            <select id="paymentClassesPaid" class="form-select" required></select>
                            <div class="invalid-feedback">Selecciona una opción de clases.</div>
                        </div>
                        <div class="mb-3"> <label class="form-label">Monto Sugerido:</label>
                            <p><strong id="suggestedAmountDisplay"></strong></p>
                        </div>
                        <div class="mb-3"> <label for="paymentAmount" class="form-label">Monto Pagado
                                Efectivamente</label> <input type="number" id="paymentAmount" class="form-control"
                                required min="0" step="0.01" />
                            <div class="invalid-feedback">Ingresa un monto válido (número positivo).</div>
                        </div>
                        <div class="mb-3"> <label for="paymentDate" class="form-label">Fecha de Pago</label> <input
                                type="date" id="paymentDate" class="form-control" required />
                            <div class="invalid-feedback">Selecciona una fecha válida.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer"> <button type="button" class="btn" style="background-color: #f3a391;"
                        data-bs-dismiss="modal">Cancelar</button> <button type="button" class="btn"
                        style="background-color: #d9e6cc; border-color: #d9e6cc; color: black;"
                        id="savePaymentBtn">Guardar Pago</button> </div>
            </div>
        </div>
    </div>

    <!-- Modal Comprobante -->
    <div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg-receipt">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #c0d5c1; border-color: #c0d5c1; color: black;">
                    <h5 class="modal-title" id="receiptModalLabel">Comprobante de Pago</h5> <button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="receiptContentContainer">
                        <div id="receiptContent">
                            <h4>Comprobante de Pago</h4>
                            <p><strong>Alumno/Participante:</strong> <span id="receiptStudentName"></span></p>
                            <p><strong>Mes Abonado:</strong> <span id="receiptMonthYear"></span></p>
                            <p><strong>Fecha de Pago:</strong> <span id="receiptPaymentDate"></span></p>
                            <p><strong>Clases Abonadas:</strong> <span id="receiptClassCount"></span></p>
                            <p><strong>Monto Abonado:</strong> $<span id="receiptAmount"></span></p>
                            <div class="receipt-footer"> Gracias por tu pago. </div>
                        </div>
                    </div>
                    <div class="mt-3"> <label for="receiptEmailInput" class="form-label">Enviar a Email:</label> <input
                            type="email" class="form-control" id="receiptEmailInput"
                            placeholder="Ingresa el email del destinatario"> </div>
                </div>
                <div class="modal-footer justify-content-center flex-wrap">
                    <button type="button" class="btn btn-sm"
                        style="background-color: #96a5c0; border-color: #96a5c0; color: black;"
                        id="downloadReceiptImageBtn"><svg class="bi me-1" width="16" height="16" fill="currentColor"
                            viewBox="0 0 16 16">...</svg> Imagen</button>
                    <button type="button" class="btn btn-sm"
                        style="background-color: #fae39e; border-color: #fae39e; color: black;"
                        id="downloadReceiptPdfBtn"><svg class="bi me-1" width="16" height="16" fill="currentColor"
                            viewBox="0 0 16 16">...</svg> PDF</button>
                    <button type="button" class="btn btn-sm"
                        style="background-color: #d9e6cc; border-color: #d9e6cc; color: black;"
                        id="sendReceiptEmailBtn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            fill="currentColor" class="bi bi-envelope" viewBox="0 0 16 16">...</svg> Enviar
                        Email</button>
                    <button type="button" class="btn btn-sm" style="background-color: #f3a391;"
                        data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Botón "Volver Arriba" -->
    <button onclick="scrollToTop()" id="backToTopBtn" title="Volver arriba"
        style="background-color: #5b7d2b; border-color: #5b7d2b; color: black;"> <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Scripts JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // ===============================================================
        // --- INICIO: Lógica JavaScript para Control de Pagos ---
        // ===============================================================

        function xlsxScriptLoaded() { console.log("Librería XLSX cargada."); }
        function xlsxScriptFailed() { console.error("Error al cargar XLSX."); Swal.fire('Error Crítico', 'No se pudo cargar librería Excel.', 'error'); }

        (function () { emailjs.init({ publicKey: "VeY3vHwsOZrOOSsKI" }); })();

        // --- Referencias DOM (sin cambios) ---
        const studentList = document.getElementById('studentList');
        const monthDisplay = document.getElementById('monthDisplay');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const paymentForm = document.getElementById('paymentForm');
        const paymentModalEl = document.getElementById('paymentModal');
        const paymentModal = new bootstrap.Modal(paymentModalEl);
        const receiptModalEl = document.getElementById('receiptModal');
        const receiptModal = new bootstrap.Modal(receiptModalEl);
        const receiptContentContainer = document.getElementById('receiptContentContainer');
        const priceModalEl = document.getElementById('priceModal');
        const priceModal = new bootstrap.Modal(priceModalEl);
        const price40Display = document.getElementById('price40');
        const price60Display = document.getElementById('price60');
        const priceGrupalDisplay = document.getElementById('priceGrupal');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const fileInput = document.getElementById('fileInput');
        const downloadReceiptImageBtn = document.getElementById('downloadReceiptImageBtn');
        const downloadReceiptPdfBtn = document.getElementById('downloadReceiptPdfBtn');
        const sendReceiptEmailBtn = document.getElementById('sendReceiptEmailBtn');

        // --- Claves y Datos Globales (sin cambios) ---
        const reservationDataKey_Corrected = 'reservasCalendarioV2_1';
        const paymentDataKey = 'studentPaymentDataV3';
        const defaultPrices = { duration40: 50000, duration60: 70000, durationGrupal: 50000 };
        let students = {};
        let basePrices = { ...defaultPrices };
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const dayNames = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
        let receiptData = {};

        // --- Funciones Utilitarias (sin cambios) ---
        function getYearMonthKey(year, month) { return `${year}-${(month + 1).toString().padStart(2, '0')}`; }
        function formatCurrency(amount) { return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(amount); }
        function formatDate(dateString) { if (!dateString) return 'N/A'; try { const [y, m, d] = dateString.split('-'); return `${d}/${m}/${y}`; } catch (e) { return dateString; } }
        function countWeekdaysInMonth(year, month, targetDayName) { const targetDayIndex = dayNames.indexOf(targetDayName); if (targetDayIndex === -1) return 0; let count = 0; const date = new Date(Date.UTC(year, month, 1)); const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate(); for (let day = 1; day <= daysInMonth; day++) { date.setUTCDate(day); if (date.getUTCDay() === targetDayIndex) { count++; } } return count; }
        function calculateMonthlyDetails(year, month, studentDuration, studentDay, classType = 'Individual') { let basePrice = 0; if (classType === 'Grupal') { basePrice = basePrices.durationGrupal; studentDuration = 60; } else { basePrice = studentDuration === 60 ? basePrices.duration60 : basePrices.duration40; } const classCount = countWeekdaysInMonth(year, month, studentDay); const perClassPrice = classCount > 0 ? Math.round(basePrice / classCount) : basePrice; return { basePrice, classCount, perClassPrice }; }
        function saveData() { try { const dataToSave = { students: students, prices: basePrices }; localStorage.setItem(paymentDataKey, JSON.stringify(dataToSave)); console.log(`Datos guardados en ${paymentDataKey}.`); } catch (error) { console.error("Error guardando:", error); Swal.fire('Error', 'No se pudieron guardar los cambios.', 'error'); } }

        // --- Carga de Datos (sin cambios) ---
        function loadData() {
            let loadedPaymentStudents = {};
            let loadedPrices = { ...defaultPrices };
            let processedStudents = {};
            try {
                const paymentStoredData = localStorage.getItem(paymentDataKey);
                if (paymentStoredData) {
                    const parsedPaymentData = JSON.parse(paymentStoredData);
                    loadedPaymentStudents = parsedPaymentData.students || {};
                    loadedPrices = { ...defaultPrices, ...(parsedPaymentData.prices || {}) };
                    console.log(`Datos de pagos previos cargados desde ${paymentDataKey}.`);
                } else {
                    console.log(`No se encontraron datos de pagos previos en ${paymentDataKey}.`);
                    loadedPrices = { ...defaultPrices };
                }
                const reservationStoredData = localStorage.getItem(reservationDataKey_Corrected);
                if (reservationStoredData) {
                    const parsedReservationData = JSON.parse(reservationStoredData);
                    console.log(`Datos de reservas encontrados en ${reservationDataKey_Corrected}. Procesando...`);
                    for (const key in parsedReservationData) {
                        const reserva = parsedReservationData[key];
                        if (!reserva || typeof reserva !== 'object' || !reserva.nombre || !reserva.horaInicio || !reserva.duracion || !reserva.tipo) { console.warn(`Reserva inválida (clave ${key}). Saltando.`); continue; }
                        const dia = key.substring(0, key.lastIndexOf('-'));
                        const hora = reserva.horaInicio;
                        const groupName = reserva.nombre;
                        const groupNameNormalized = groupName.toLowerCase().replace(/\s+/g, '');
                        if (reserva.tipo === "Grupal") {
                            console.log(`Procesando Grupo: ${groupName} (${dia} ${hora})`);
                            if (Array.isArray(reserva.participantes) && reserva.participantes.length > 0) {
                                reserva.participantes.forEach((participante, index) => {
                                    if (!participante || !participante.nombre) { console.warn(`Participante inválido en grupo ${groupName} (índice ${index}). Saltando.`); return; }
                                    const participantName = participante.nombre;
                                    const participantNameNormalized = participantName.toLowerCase().replace(/\s+/g, '');
                                    const participantId = `${groupNameNormalized}-${participantNameNormalized}-${dia}-${hora}`;
                                    console.log(`  - Creando/Actualizando Participante: ${participantName} (ID: ${participantId})`);
                                    const participantEntry = { id: participantId, name: participantName, email: participante.email || '', groupName: groupName, classDay: dia, classTime: hora, duration: 60, classType: "Grupal", specificDate: reserva.fechaEspecifica || null, payments: {} };
                                    if (loadedPaymentStudents[participantId]) {
                                        console.log(`    Fusionando pagos existentes para ${participantName}`);
                                        participantEntry.payments = loadedPaymentStudents[participantId].payments || {};
                                        participantEntry.email = loadedPaymentStudents[participantId].email || participante.email || '';
                                        if (participante.email && participante.email !== loadedPaymentStudents[participantId].email) { participantEntry.email = participante.email; console.log(`    Email actualizado para ${participantName} a: ${participantEntry.email}`); }
                                        delete loadedPaymentStudents[participantId];
                                    } else { console.log(`    Sin pagos previos encontrados para ${participantName}`); participantEntry.email = participante.email || ''; }
                                    processedStudents[participantId] = participantEntry;
                                });
                            } else { console.warn(`Grupo '${groupName}' no tiene participantes válidos en la reserva.`); }
                        } else {
                            const studentNameNormalized = groupNameNormalized;
                            const studentId = `${studentNameNormalized}-${dia}-${hora}`;
                            console.log(`Procesando Individual/Otro: ${groupName} (ID: ${studentId}, Tipo: ${reserva.tipo})`);
                            const studentEntry = { id: studentId, name: groupName, classDay: dia, classTime: hora, duration: reserva.duracion, classType: reserva.tipo, specificDate: reserva.fechaEspecifica || null, email: reserva.email || '', payments: {} };
                            if (loadedPaymentStudents[studentId]) {
                                console.log(`    Fusionando pagos existentes para ${studentId}`);
                                studentEntry.payments = loadedPaymentStudents[studentId].payments || {};
                                studentEntry.email = loadedPaymentStudents[studentId].email || reserva.email || '';
                                if (reserva.email && reserva.email !== loadedPaymentStudents[studentId].email) { studentEntry.email = reserva.email; console.log(`    Email actualizado para ${studentId} a: ${studentEntry.email}`); }
                                delete loadedPaymentStudents[studentId];
                            } else { console.log(`    Sin pagos previos encontrados para ${studentId}`); studentEntry.email = reserva.email || ''; }
                            processedStudents[studentId] = studentEntry;
                        }
                    }
                    console.log("Alumnos/participantes procesados desde reservas.");
                } else {
                    console.log(`No se encontraron datos de reservas en ${reservationDataKey_Corrected}...`);
                    processedStudents = loadedPaymentStudents;
                    for (const id in processedStudents) {
                        if (!processedStudents[id].classType) processedStudents[id].classType = 'Desconocido (Solo Pago)';
                        if (!processedStudents[id].hasOwnProperty('specificDate')) processedStudents[id].specificDate = null;
                        if (!processedStudents[id].hasOwnProperty('duration')) processedStudents[id].duration = 0;
                        if (!processedStudents[id].hasOwnProperty('classDay')) processedStudents[id].classDay = '?';
                        if (!processedStudents[id].hasOwnProperty('classTime')) processedStudents[id].classTime = '?';
                    }
                }
                for (const remainingId in loadedPaymentStudents) {
                    console.log(`Añadiendo alumno/participante ${remainingId} que solo estaba en datos de pago.`);
                    if (!loadedPaymentStudents[remainingId].classType) loadedPaymentStudents[remainingId].classType = 'Desconocido (Solo Pago)';
                    if (!loadedPaymentStudents[remainingId].hasOwnProperty('specificDate')) loadedPaymentStudents[remainingId].specificDate = null;
                    if (!loadedPaymentStudents[remainingId].hasOwnProperty('duration')) loadedPaymentStudents[remainingId].duration = 0;
                    if (!loadedPaymentStudents[remainingId].hasOwnProperty('classDay')) loadedPaymentStudents[remainingId].classDay = '?';
                    if (!loadedPaymentStudents[remainingId].hasOwnProperty('classTime')) loadedPaymentStudents[remainingId].classTime = '?';
                    processedStudents[remainingId] = loadedPaymentStudents[remainingId];
                }
            } catch (error) {
                console.error("Error cargando/parseando datos:", error);
                processedStudents = {};
                loadedPrices = { ...defaultPrices };
                Swal.fire('Advertencia', `Error al cargar datos: ${error.message}`, 'warning');
            }
            students = processedStudents;
            basePrices = loadedPrices;
            console.log("Datos finales cargados:", { students, basePrices });
            updatePriceDisplay();
        }

        // --- Actualiza Displays de Precios (sin cambios) ---
        function updatePriceDisplay() { price40Display.textContent = formatCurrency(basePrices.duration40); price60Display.textContent = formatCurrency(basePrices.duration60); priceGrupalDisplay.textContent = formatCurrency(basePrices.durationGrupal); }

        // --- MODIFICADO: Renderizado añade botón Cancelar y su listener ---
        function renderMonthlyView(year, month) {
            monthDisplay.textContent = `${monthNames[month]} ${year}`;
            studentList.innerHTML = '';
            const yearMonthKey = getYearMonthKey(year, month);
            const studentIds = Object.keys(students);
            if (studentIds.length === 0) { studentList.innerHTML = '<li class="text-center text-muted p-4">No hay alumnos/participantes cargados.</li>'; return; }
            studentIds.sort((a, b) => students[a].name.localeCompare(students[b].name)).forEach(id => {
                const student = students[id];
                if (!student || !student.name || typeof student.duration === 'undefined' || !student.classType || !student.classDay || !student.classTime) { console.warn(`Datos incompletos para ID: ${id}. Saltando renderizado.`, student); return; }
                const monthlyDetails = calculateMonthlyDetails(year, month, student.duration, student.classDay, student.classType);
                const payment = student.payments?.[yearMonthKey];
                const li = document.createElement('li');
                li.className = 'student-item';
                let statusHTML = '';
                let actionsHTML = '';
                let paymentDetailsHTML = '';

                if (payment) {
                    const paidClassesText = payment.isFullMonthPayment ? `Mes Completo` : `${payment.classesPaid} clase(s)`;
                    paymentDetailsHTML = `<div class="payment-details"> Pagó ${formatCurrency(payment.amountPaid)} (${paidClassesText}) el ${formatDate(payment.paymentDate)} </div>`;
                    if (payment.isFullMonthPayment || (monthlyDetails.classCount > 0 && payment.classesPaid >= monthlyDetails.classCount)) {
                        statusHTML = `<span class="status-paid-full">Pagado (Completo)</span>`;
                    } else {
                        const classCountText = monthlyDetails.classCount > 0 ? `/${monthlyDetails.classCount}` : '';
                        statusHTML = `<span class="status-paid-partial">Pago Parcial (${payment.classesPaid}${classCountText})</span>`;
                    }
                    // *** AÑADIDO BOTÓN CANCELAR ***
                    actionsHTML = `
                        <button class="btn btn-sm view-receipt-btn" style="background-color: #96a5c0; border-color: #96a5c0; color: black;" data-studentid="${id}" data-yearmonth="${yearMonthKey}" title="Ver Comprobante"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-receipt" viewBox="0 0 16 16"><path d="M1.92.506a.5.5 0 0 1 .434.14L3 1.293l.646-.647a.5.5 0 0 1 .708 0L5 1.293l.646-.647a.5.5 0 0 1 .708 0L7 1.293l.646-.647a.5.5 0 0 1 .708 0L9 1.293l.646-.647a.5.5 0 0 1 .708 0L11 1.293l.646-.647a.5.5 0 0 1 .708 0L13 1.293l.646-.647a.5.5 0 0 1 .434-.14L15 1.5v13a.5.5 0 0 1-.053.224l-.5 2a.5.5 0 0 1-.447.276H1.5a.5.5 0 0 1-.447-.276l-.5-2A.5.5 0 0 1 1 14.5v-13Z M2 2v12h12V2z"/><path d="M3 4.5a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m3 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5"/></svg> Recibo</button>
                        <button class="btn btn-sm register-payment-btn" style="background-color: #fae39e; border-color: #fae39e; color: black;" data-studentid="${id}" data-yearmonth="${yearMonthKey}" data-duration="${student.duration}" data-day="${student.classDay}" data-type="${student.classType}" title="Modificar Pago"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11A1.5 1.5 0 0 0 15 13.5V6h-1v7.5a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H6v-1H2.5A1.5 1.5 0 0 0 1 2.5z"/></svg> Modificar</button>
                        <button class="btn btn-sm cancel-payment-btn" style="background-color: #f3a391; border-color: #f3a391; color: black;" data-studentid="${id}" data-yearmonth="${yearMonthKey}" title="Cancelar Pago Registrado"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.647 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/></svg> Cancelar</button>
                    `;
                } else {
                    if (student.classType === "Clase de recuperación") {
                        let fechaTexto = student.specificDate ? ` (${formatDate(student.specificDate)})` : ' (Fecha no especificada)';
                        statusHTML = `<span class="status-recovery">Clase de recuperación${fechaTexto}</span>`;
                        actionsHTML = '';
                    } else {
                        statusHTML = `<span class="status-pending">Pendiente</span>`;
                        actionsHTML = `<button class="btn btn-sm register-payment-btn" style="background-color: #c0d5c1; border-color: #c0d5c1; color: black;" data-studentid="${id}" data-yearmonth="${yearMonthKey}" data-duration="${student.duration}" data-day="${student.classDay}" data-type="${student.classType}" title="Registrar Pago"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cash-coin" viewBox="0 0 16 16">...</svg> Registrar Pago</button>`;
                    }
                }
                const groupNameHTML = student.groupName ? `<span class="group-name-display">(Grupo: ${student.groupName})</span>` : '';
                const durationDisplay = student.classType === 'Grupal' ? 60 : student.duration;
                const specificDateHTML = student.specificDate ? `<span class="class-duration" style="font-style: italic; font-size: 0.8em;">Fecha Esp: ${formatDate(student.specificDate)}</span>` : '';
                li.innerHTML = `<div class="student-info"> <span class="student-name">${student.name}</span> ${groupNameHTML} <span class="class-slot">Clase: ${student.classDay} ${student.classTime}</span> <span class="class-duration">Duración: ${durationDisplay} min</span> <span class="class-duration" style="font-style: italic;">Tipo: ${student.classType || 'No definido'}</span> ${specificDateHTML} </div> <div class="payment-status-details"> ${statusHTML} ${paymentDetailsHTML} </div> <div class="payment-actions"> ${actionsHTML} </div>`;
                studentList.appendChild(li);
            });
            document.querySelectorAll('.register-payment-btn').forEach(button => button.addEventListener('click', handleRegisterPaymentClick));
            document.querySelectorAll('.view-receipt-btn').forEach(button => button.addEventListener('click', handleViewReceiptClick));
            // +++ AÑADIR LISTENER PARA CANCELAR +++
            document.querySelectorAll('.cancel-payment-btn').forEach(button => button.addEventListener('click', handleCancelPaymentClick));
        }

        // --- Manejadores y Lógica de Modales (sin cambios funcionales) ---
        function handleRegisterPaymentClick(event) { const btn = event.currentTarget; openPaymentModal(btn.dataset.studentid, btn.dataset.yearmonth, parseInt(btn.dataset.duration, 10), btn.dataset.day, btn.dataset.type); }
        function handleViewReceiptClick(event) { openReceiptModal(event.currentTarget.dataset.studentid, event.currentTarget.dataset.yearmonth); }
        function openPriceModal() { document.getElementById('basePrice40Input').value = basePrices.duration40; document.getElementById('basePrice60Input').value = basePrices.duration60; document.getElementById('basePriceGrupalInput').value = basePrices.durationGrupal; priceModal.show(); }
        function savePrices() { const price40 = parseFloat(document.getElementById('basePrice40Input').value); const price60 = parseFloat(document.getElementById('basePrice60Input').value); const priceGrupal = parseFloat(document.getElementById('basePriceGrupalInput').value); if (isNaN(price40) || isNaN(price60) || isNaN(priceGrupal) || price40 < 0 || price60 < 0 || priceGrupal < 0) { Swal.fire('Error', 'Ingresa precios válidos (números positivos).', 'error'); return; } basePrices.duration40 = price40; basePrices.duration60 = price60; basePrices.durationGrupal = priceGrupal; saveData(); updatePriceDisplay(); renderMonthlyView(currentYear, currentMonth); priceModal.hide(); Swal.fire('Éxito', 'Precios actualizados.', 'success'); }
        function openPaymentModal(studentId, yearMonth, studentDuration, studentDay, classType) { const student = students[studentId]; if (!student) { Swal.fire('Error', 'No se encontró info del alumno/participante.', 'error'); return; } console.log(`Abriendo modal pago para ID: ${studentId} (${student.name}), Tipo: ${classType}, Mes: ${yearMonth}`); const [year, monthNum] = yearMonth.split('-').map(Number); const month = monthNum - 1; const yearMonthKey = getYearMonthKey(year, month); const monthName = monthNames[month]; const monthlyDetails = calculateMonthlyDetails(year, month, studentDuration, studentDay, classType); const existingPayment = student.payments?.[yearMonthKey]; const paymentModalLabel = document.getElementById('paymentModalLabel'); const paymentStudentName = document.getElementById('paymentStudentName'); const paymentMonthYearDisplay = document.getElementById('paymentMonthYearDisplay'); const paymentClassCountDisplay = document.getElementById('paymentClassCountDisplay'); const selectClasses = document.getElementById('paymentClassesPaid'); const suggestedAmountDisplay = document.getElementById('suggestedAmountDisplay'); const paymentAmountInput = document.getElementById('paymentAmount'); const paymentDateInput = document.getElementById('paymentDate'); const savePaymentBtn = document.getElementById('savePaymentBtn'); document.getElementById('paymentStudentId').value = studentId; document.getElementById('paymentYearMonth').value = yearMonthKey; document.getElementById('paymentClassType').value = classType; paymentStudentName.textContent = student.name + (student.groupName ? ` (Grupo: ${student.groupName})` : ''); paymentMonthYearDisplay.textContent = `${monthName} ${year}`; paymentClassCountDisplay.textContent = monthlyDetails.classCount > 0 ? monthlyDetails.classCount : '0'; paymentForm.classList.remove('was-validated'); savePaymentBtn.disabled = false; if (classType === "Clase de prueba") { console.log("Modal: Aplicando reglas Clase de prueba."); paymentModalLabel.textContent = "Registrar Pago (Clase de Prueba)"; selectClasses.innerHTML = '<option value="1" selected>1 clase (Prueba)</option>'; selectClasses.disabled = true; const oneClassPrice = monthlyDetails.classCount > 0 ? monthlyDetails.perClassPrice : basePrices.duration40; suggestedAmountDisplay.textContent = formatCurrency(oneClassPrice); paymentAmountInput.value = existingPayment ? existingPayment.amountPaid.toFixed(2) : oneClassPrice.toFixed(2); paymentAmountInput.disabled = false; paymentDateInput.valueAsDate = existingPayment ? new Date(existingPayment.paymentDate + 'T00:00:00') : new Date(); selectClasses.onchange = null; } else if (classType === "Clase de recuperación") { console.log("Modal: Aplicando reglas Clase de recuperación."); paymentModalLabel.textContent = "Registrar (Clase de Recuperación - Sin Costo)"; selectClasses.innerHTML = '<option value="0" selected>0 clases (Recuperación)</option>'; selectClasses.disabled = true; suggestedAmountDisplay.textContent = formatCurrency(0); paymentAmountInput.value = '0.00'; paymentAmountInput.disabled = true; paymentDateInput.valueAsDate = existingPayment ? new Date(existingPayment.paymentDate + 'T00:00:00') : new Date(); savePaymentBtn.disabled = false; selectClasses.onchange = null; } else { console.log(`Modal: Aplicando lógica ${classType}.`); selectClasses.innerHTML = ''; selectClasses.disabled = false; paymentAmountInput.disabled = false; savePaymentBtn.disabled = false; if (monthlyDetails.classCount > 0) { for (let i = 1; i <= monthlyDetails.classCount; i++) { const option = document.createElement('option'); option.value = i; option.textContent = `${i} clase(s) (${formatCurrency(i * monthlyDetails.perClassPrice)})`; selectClasses.appendChild(option); } const fullMonthOption = document.createElement('option'); fullMonthOption.value = 'full'; fullMonthOption.textContent = `Mes Completo (${monthlyDetails.classCount} clases) (${formatCurrency(monthlyDetails.basePrice)})`; selectClasses.appendChild(fullMonthOption); if (existingPayment) { paymentModalLabel.textContent = "Modificar Pago" + (classType === 'Grupal' ? " (Grupal)" : ""); paymentAmountInput.value = existingPayment.amountPaid.toFixed(2); paymentDateInput.value = existingPayment.paymentDate; if (existingPayment.hasOwnProperty('isFullMonthPayment') && existingPayment.hasOwnProperty('classesPaid')) { selectClasses.value = existingPayment.isFullMonthPayment ? 'full' : existingPayment.classesPaid.toString(); } else { selectClasses.value = 'full'; } } else { paymentModalLabel.textContent = "Registrar Pago" + (classType === 'Grupal' ? " (Grupal)" : ""); selectClasses.value = 'full'; paymentAmountInput.value = monthlyDetails.basePrice.toFixed(2); paymentDateInput.valueAsDate = new Date(); } const updateSuggested = () => { const selectedValue = selectClasses.value; let suggestedAmount = 0; if (selectedValue === 'full') { suggestedAmount = monthlyDetails.basePrice; } else { const numClasses = parseInt(selectedValue, 10); suggestedAmount = (numClasses > 0 && monthlyDetails.perClassPrice > 0) ? numClasses * monthlyDetails.perClassPrice : 0; } suggestedAmountDisplay.textContent = formatCurrency(suggestedAmount); if (!existingPayment) { paymentAmountInput.value = suggestedAmount.toFixed(2); } }; selectClasses.onchange = updateSuggested; updateSuggested(); } else { paymentModalLabel.textContent = "Registrar Pago (0 clases este mes)"; selectClasses.innerHTML = '<option value="0" selected>0 clases este mes</option>'; selectClasses.disabled = true; suggestedAmountDisplay.textContent = formatCurrency(0); paymentAmountInput.value = '0.00'; paymentAmountInput.disabled = true; paymentDateInput.valueAsDate = new Date(); savePaymentBtn.disabled = true; if (existingPayment) { paymentModalLabel.textContent = "Modificar Pago (0 clases este mes)"; paymentAmountInput.value = existingPayment.amountPaid.toFixed(2); paymentAmountInput.disabled = false; paymentDateInput.value = existingPayment.paymentDate; savePaymentBtn.disabled = false; } selectClasses.onchange = null; } } paymentModal.show(); }
        function savePayment() { if (!paymentForm.checkValidity()) { paymentForm.classList.add('was-validated'); const firstInvalidField = paymentForm.querySelector(':invalid'); if (firstInvalidField) { firstInvalidField.focus(); } return; } const studentId = document.getElementById('paymentStudentId').value; const yearMonth = document.getElementById('paymentYearMonth').value; const amountPaidInput = document.getElementById('paymentAmount'); const amountPaid = parseFloat(amountPaidInput.value); const paymentDate = document.getElementById('paymentDate').value; const selectClasses = document.getElementById('paymentClassesPaid'); const classesPaidSelection = selectClasses.value; const classType = document.getElementById('paymentClassType').value; if (isNaN(amountPaid) || amountPaid < 0 || !paymentDate || !yearMonth || !studentId) { Swal.fire('Datos Inválidos', 'Verifica monto y fecha.', 'warning'); paymentForm.classList.add('was-validated'); return; } const isFullMonthPayment = classesPaidSelection === 'full'; const classCountSpan = document.getElementById('paymentClassCountDisplay'); let monthClassCount = 0; if (classCountSpan) { monthClassCount = parseInt(classCountSpan.textContent, 10); if (isNaN(monthClassCount)) monthClassCount = 0; } const classesPaidCount = isFullMonthPayment ? monthClassCount : parseInt(classesPaidSelection, 10); if (!students[studentId]) { Swal.fire('Error Interno', 'No se encontró el alumno/participante.', 'error'); return; } if (!students[studentId].payments) { students[studentId].payments = {}; } const paymentObject = { amountPaid: amountPaid, paymentDate: paymentDate, classesPaid: isNaN(classesPaidCount) ? 0 : classesPaidCount, isFullMonthPayment: isFullMonthPayment, recordedAt: new Date().toISOString() }; students[studentId].payments[yearMonth] = paymentObject; saveData(); renderMonthlyView(currentYear, currentMonth); paymentModal.hide(); if (!(amountPaid === 0 && classType === "Clase de recuperación")) { Swal.fire('¡Guardado!', 'Pago registrado/actualizado.', 'success'); } else { console.log("Registro de recuperación $0 guardado, sin alerta de éxito."); } }
        function openReceiptModal(studentId, yearMonth) { const student = students[studentId]; const payment = student?.payments?.[yearMonth]; if (!student || !payment) { Swal.fire('Error', 'No se encontró info de pago.', 'error'); return; } const [year, monthNum] = yearMonth.split('-').map(Number); const monthName = monthNames[monthNum - 1]; const monthlyDetails = calculateMonthlyDetails(year, monthNum - 1, student.duration, student.classDay, student.classType); receiptData = { studentId, studentName: student.name, studentEmail: student.email || '', monthYear: `${monthName} ${year}`, paymentDate: formatDate(payment.paymentDate), amountFormatted: formatCurrency(payment.amountPaid), amountRaw: payment.amountPaid, classCount: payment.isFullMonthPayment ? monthlyDetails.classCount : payment.classesPaid, isFullMonth: payment.isFullMonthPayment }; document.getElementById('receiptStudentName').textContent = receiptData.studentName; document.getElementById('receiptMonthYear').textContent = receiptData.monthYear; document.getElementById('receiptPaymentDate').textContent = receiptData.paymentDate; document.getElementById('receiptAmount').textContent = payment.amountPaid.toFixed(2); document.getElementById('receiptClassCount').textContent = receiptData.isFullMonth ? `Mes Completo (${receiptData.classCount} ${receiptData.classCount === 1 ? 'clase' : 'clases'})` : `${receiptData.classCount} ${receiptData.classCount === 1 ? 'clase' : 'clases'}`; document.getElementById('receiptEmailInput').value = receiptData.studentEmail; receiptModal.show(); }
        async function generateReceiptCanvas() { const el = document.getElementById('receiptContent'); if (!el) { Swal.fire('Error Técnico', 'Elemento recibo no encontrado.', 'error'); return null; } if (typeof window.html2canvas === 'undefined') { Swal.fire('Error Técnico', 'Falta librería html2canvas.', 'error'); return null; } try { const canvas = await window.html2canvas(el, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }); return canvas; } catch (err) { console.error("Error html2canvas:", err); Swal.fire('Error Imagen', 'Error al generar imagen.', 'error'); return null; } }
        async function downloadReceiptAsImage() { const canvas = await generateReceiptCanvas(); if (!canvas) return; try { const img = canvas.toDataURL('image/png'); const link = document.createElement('a'); link.href = img; const safe = `comprobante_${receiptData.studentName}_${receiptData.monthYear}`.replace(/[^a-z0-9_-]/gi, '_') + '.png'; link.download = safe; document.body.appendChild(link); link.click(); document.body.removeChild(link); } catch (err) { console.error("Error descarga imagen:", err); Swal.fire('Error Descarga', 'No se pudo descargar imagen.', 'error'); } }
        async function downloadReceiptAsPdf() { const canvas = await generateReceiptCanvas(); if (!canvas) return; if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') { Swal.fire('Error Técnico', 'Falta librería jsPDF.', 'error'); return; } const { jsPDF } = window.jspdf; try { const img = canvas.toDataURL('image/png'); const pdf = new jsPDF({ o: 'p', u: 'pt', f: 'a5' }); const props = pdf.getImageProperties(img); const w = pdf.internal.pageSize.getWidth(); const h = pdf.internal.pageSize.getHeight(); const m = 40; const aw = w - 2 * m; const ah = h - 2 * m; const r = props.width / props.height; let fw = props.width; let fh = props.height; if (fw > aw) { fw = aw; fh = fw / r; } if (fh > ah) { fh = ah; fw = fh * r; } const x = (w - fw) / 2; const y = m; pdf.addImage(img, 'PNG', x, y, fw, fh); const safe = `comprobante_${receiptData.studentName}_${receiptData.monthYear}`.replace(/[^a-z0-9_-]/gi, '_') + '.pdf'; pdf.save(safe); } catch (err) { console.error("Error PDF:", err); Swal.fire('Error PDF', 'No se pudo generar/descargar PDF.', 'error'); } }
        async function sendReceiptEmail() { const input = document.getElementById('receiptEmailInput'); const email = input.value.trim(); if (!email) { Swal.fire('Falta Email', 'Ingresa correo.', 'warning'); input.focus(); return; } if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { Swal.fire('Email Inválido', 'Ingresa dirección válida.', 'warning'); input.focus(); input.select(); return; } if (receiptData.studentId && students[receiptData.studentId] && email && email !== students[receiptData.studentId].email) { console.log(`Actualizando email para ${receiptData.studentName} de '${students[receiptData.studentId].email}' a '${email}'`); students[receiptData.studentId].email = email; receiptData.studentEmail = email; saveData(); } else if (receiptData.studentId && students[receiptData.studentId] && !students[receiptData.studentId].email && email) { console.log(`Guardando email nuevo para ${receiptData.studentName}: '${email}'`); students[receiptData.studentId].email = email; receiptData.studentEmail = email; saveData(); } Swal.fire({ title: 'Enviando Email...', text: `Preparando para ${email}`, allowOutsideClick: false, didOpen: () => { Swal.showLoading() } }); try { const html = `<div style="font-family: Arial, sans-serif; border: 1px solid #eee; padding: 20px;background-color: #d9e6cc;border-radius:15px;"><h4 style="text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">Comprobante de Pago</h4><p><strong>Alumno/Participante:</strong> ${receiptData.studentName}</p><p><strong>Mes Abonado:</strong> ${receiptData.monthYear}</p><p><strong>Fecha de Pago:</strong> ${receiptData.paymentDate}</p><p><strong>Clases Abonadas:</strong> ${receiptData.isFullMonth ? `Mes Completo (${receiptData.classCount})` : receiptData.classCount}</p><p><strong>Monto Abonado:</strong> ${receiptData.amountFormatted}</p><p style="margin-top: 30px; text-align: center; font-size: 0.9em; color: #777;">Gracias por tu pago.</p></div>`; const serviceID = 'service_h2fm824'; const templateID = 'template_v7gzygn'; const [mName, yStr] = receiptData.monthYear.split(' '); const params = { mes: mName, year: yStr, email: email, recibo: html, to_name: receiptData.studentName }; await emailjs.send(serviceID, templateID, params); Swal.fire('¡Enviado!', `Comprobante enviado a ${email}.`, 'success'); } catch (error) { console.error('Error email:', error); Swal.fire('Error', `No se pudo enviar email: ${error?.text || error?.message || 'Desconocido'}`, 'error'); } }
        function exportData() { try { const data = { version: 3, createdAt: new Date().toISOString(), students: students, prices: basePrices }; const str = JSON.stringify(data, null, 2); const blob = new Blob([str], { type: 'application/json;charset=utf-8' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; const ts = new Date().toISOString().split('T')[0].replace(/-/g, ''); link.download = `datos_pagos_alumnos_v3_${ts}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); Swal.fire('¡Exportado!', 'Datos guardados en JSON.', 'success'); } catch (error) { console.error("Error exportando:", error); Swal.fire('Error', 'Error al exportar.', 'error'); } }
        function importData(event) { const file = event.target.files[0]; if (!file) return; if (!file.name.toLowerCase().endsWith('.json')) { Swal.fire('Inválido', 'Selecciona .json.', 'error'); fileInput.value = null; return; } const reader = new FileReader(); reader.onload = (e) => { const content = e.target.result; try { const imported = JSON.parse(content); if (typeof imported !== 'object' || imported === null || (!imported.students && !imported.prices)) throw new Error("Estructura JSON inválida."); if (!imported.students || typeof imported.students !== 'object') throw new Error("'students' inválido."); const importedPrices = { ...defaultPrices, ...(imported.prices || {}) }; if (isNaN(importedPrices.duration40) || isNaN(importedPrices.duration60) || isNaN(importedPrices.durationGrupal)) { throw new Error("'prices' inválido o falta precio grupal."); } Swal.fire({ title: 'Confirmar Importación', html: `Datos de <strong>${file.name}</strong>.<br>¿Reemplazar <b>TODOS</b> los datos?<br><b style='color:red;'>¡Irreversible!</b>`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Sí, reemplazar', cancelButtonText: 'Cancelar' }).then((result) => { if (result.isConfirmed) { console.log("Importando..."); students = imported.students || {}; basePrices = importedPrices; for (const id in students) { if (!students[id].payments) students[id].payments = {}; if (!students[id].classType) students[id].classType = 'Desconocido (Importado)'; if (!students[id].hasOwnProperty('specificDate')) students[id].specificDate = null; if (students[id].classType === 'Grupal') { students[id].duration = 60; if (!students[id].groupName) console.warn(`Participante importado ${id} (${students[id].name}) no tiene groupName.`); } else if (typeof students[id].duration === 'undefined') { students[id].duration = 0; } if (!students[id].classDay) students[id].classDay = '?'; if (!students[id].classTime) students[id].classTime = '?'; if (!students[id].email) students[id].email = ''; } saveData(); updatePriceDisplay(); renderMonthlyView(currentYear, currentMonth); Swal.fire('¡Importado!', 'Datos actualizados.', 'success'); console.log("Importación OK."); } else { console.log("Importación cancelada."); } }); } catch (error) { console.error("Error procesando JSON:", error); Swal.fire('Error Importación', `No se procesó archivo. ¿JSON válido?\n<br><small>${error.message}</small>`, 'error'); } finally { fileInput.value = null; } }; reader.onerror = (e) => { console.error("Error leyendo archivo:", e); Swal.fire('Error Lectura', 'No se leyó archivo.', 'error'); fileInput.value = null; }; reader.readAsText(file); }

        // +++ NUEVA FUNCIÓN: Manejador para el botón Cancelar Pago +++
        function handleCancelPaymentClick(event) {
            const btn = event.currentTarget;
            const studentId = btn.dataset.studentid;
            const yearMonth = btn.dataset.yearmonth;
            const studentName = students[studentId]?.name || 'Desconocido';
            const [year, monthNum] = yearMonth.split('-').map(Number);
            const monthName = monthNames[monthNum - 1];

            Swal.fire({
                title: '¿Cancelar Pago?',
                html: `Estás a punto de eliminar el registro de pago para <b>${studentName}</b> del mes de <b>${monthName} ${year}</b>.<br>Esta acción no se puede deshacer.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, cancelar pago',
                cancelButtonText: 'No, mantener'
            }).then((result) => {
                if (result.isConfirmed) {
                    cancelPayment(studentId, yearMonth);
                }
            });
        }

        // +++ NUEVA FUNCIÓN: Lógica para eliminar el pago +++
        function cancelPayment(studentId, yearMonthKey) {
            if (students[studentId] && students[studentId].payments && students[studentId].payments[yearMonthKey]) {
                console.log(`Cancelando pago para ${studentId} en ${yearMonthKey}`);
                delete students[studentId].payments[yearMonthKey];
                saveData();
                renderMonthlyView(currentYear, currentMonth);
                Swal.fire('¡Cancelado!', 'El registro de pago ha sido eliminado.', 'success');
            } else {
                console.error(`Error al cancelar: No se encontró el pago para ${studentId} en ${yearMonthKey}`);
                Swal.fire('Error', 'No se pudo encontrar el registro de pago para cancelar.', 'error');
            }
        }

        // --- Event Listeners y Carga Inicial ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM cargado."); loadData(); renderMonthlyView(currentYear, currentMonth);
            prevMonthBtn.addEventListener('click', () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderMonthlyView(currentYear, currentMonth); });
            nextMonthBtn.addEventListener('click', () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderMonthlyView(currentYear, currentMonth); });
            document.getElementById('editPricesBtn').addEventListener('click', openPriceModal);
            document.getElementById('savePricesBtn').addEventListener('click', savePrices);
            document.getElementById('savePaymentBtn').addEventListener('click', savePayment);
            downloadReceiptImageBtn.addEventListener('click', downloadReceiptAsImage);
            downloadReceiptPdfBtn.addEventListener('click', downloadReceiptAsPdf);
            sendReceiptEmailBtn.addEventListener('click', sendReceiptEmail);
            exportDataBtn.addEventListener('click', exportData);
            importDataBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', importData);
            initializeBackToTopButton();
            // NOTA: Los listeners para botones dinámicos (.register-payment-btn, .view-receipt-btn, .cancel-payment-btn) se añaden dentro de renderMonthlyView.
        });

        // --- Lógica Botón Volver Arriba (sin cambios) ---
        let mybutton = null; function scrollFunction() { if (mybutton && (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100)) { if (mybutton.style.display !== "flex" || mybutton.style.opacity === "0") { mybutton.style.display = "flex"; setTimeout(() => { mybutton.style.opacity = "1"; }, 10); } } else if (mybutton) { if (mybutton.style.opacity !== "0") { mybutton.style.opacity = "0"; } } } function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); } function initializeBackToTopButton() { mybutton = document.getElementById("backToTopBtn"); if (mybutton) { console.log("Botón 'Volver Arriba' OK."); scrollFunction(); window.onscroll = scrollFunction; } else { console.error("#backToTopBtn no encontrado."); } }
    </script>
</body>

</html>