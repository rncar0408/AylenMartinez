<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Calendario de Pagos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.min.css" rel="stylesheet" />
    <!-- *** ADDED: Font Awesome for the icon *** -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
        integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
        integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
        integrity="sha512-r22gChDnGvCbOBVEEYcvbRPcfTaXflcJrycv5fK7NfYMhAxtQQEz3O4ht6iAnWvSMnCjU/hV9YEr7+5JaK9MAA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" onload="xlsxScriptLoaded()" onerror="xlsxScriptFailed()">
        </script>
    <style>
        /* --- START: Copied styles for background #dde9ce and responsiveness --- */
        body {
            /* --- Applied new background color --- */
            background-color: #dde9ce !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            line-height: 1.6;
            color: #333;
            /* Default text color */
        }

        .container.py-5 {
            padding-top: 2rem !important;
            /* Reduced top padding slightly */
            padding-bottom: 3rem !important;
        }

        .payment-container {
            background: #ffffff;
            padding: 30px;
            border-radius: 15px;
            /* --- Slightly enhanced shadow for more definition --- */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        /* Link style */
        .back-to-dashboard {
            color: #0d6efd;
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: color 0.2s ease;
        }

        .back-to-dashboard:hover {
            color: #0a58ca;
            text-decoration: underline;
        }

        .back-to-dashboard svg {
            margin-bottom: 2px;
            /* Align icon better */
        }


        .price-section {
            background-color: #f0f4f0;
            /* Slightly adjusted color to blend */
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            align-items: center;
            border: 1px solid #ced4da;
            gap: 15px;
        }

        .price-display {
            text-align: center;
            font-size: 1rem;
            color: #555;
        }

        .price-display span {
            font-weight: bold;
            color: #0d6efd;
            /* Bootstrap primary color */
            font-size: 1.1rem;
        }

        #editPricesBtn {
            font-weight: 500;
        }

        .month-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            gap: 15px;
        }

        .month-navigation .btn {
            padding: 0.375rem 0.75rem;
            /* Standard Bootstrap button padding */
        }

        .month-display {
            font-size: 1.6rem;
            font-weight: 500;
            min-width: 200px;
            /* Wider display */
            text-align: center;
            color: #2c3e50;
            /* Darker color for emphasis */
        }

        hr {
            border-top: 1px solid #ccc;
            /* Slightly darker separator */
            margin-top: 25px;
            margin-bottom: 25px;
        }

        .action-buttons-main {
            text-align: center;
            margin-bottom: 25px;
            margin-top: 15px;
            padding: 0 15px;
            /* Add padding on small screens */
        }

        .action-buttons-main .btn {
            margin: 6px 10px;
            font-weight: 500;
            /* Slightly bolder text */
            /* Making main buttons solid */
            /* btn-success and btn-primary classes will be added directly in HTML below */
        }

        #studentListTitle {
            color: #34495e;
            /* Darker heading color */
            font-weight: 600;
        }

        .student-list {
            list-style: none;
            padding: 0;
        }

        .student-item {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 18px 25px;
            /* Slightly more padding */
            margin-bottom: 15px;
            border-radius: 12px;
            border: 1px solid #d5dce5;
            /* Softer border */
            background-color: #fdfdfe;
            /* Very light background for items */
            transition: box-shadow 0.25s ease, border-color 0.25s ease;
        }

        .student-item:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
            border-color: #adb5bd;
        }

        .student-info {
            flex: 1 1 45%;
            /* Grow, shrink, basis */
            min-width: 220px;
            /* Slightly larger min-width */
            padding-right: 15px;
            /* Space between sections */
        }

        .payment-status-details {
            flex: 1 1 30%;
            min-width: 190px;
            /* text-align: right; */
            /* Alineación general a la derecha quitada */
            padding-right: 15px;
            /* Space between sections */
        }

        .payment-actions {
            flex: 0 0 auto;
            /* Don't grow or shrink, size based on content */
            min-width: 160px;
            /* Adjust if needed */
            text-align: right;
            display: flex;
            gap: 8px;
            /* Increased gap */
            justify-content: flex-end;
            align-items: center;
            /* Vertically align buttons if they wrap */
        }

        /* Style for buttons generated by JS */
        .payment-actions .btn {
            display: inline-flex;
            /* Align icon and text */
            align-items: center;
            gap: 4px;
        }

        .student-info span {
            display: block;
            margin-bottom: 2px;
            /* Small gap between lines */
        }

        .student-name {
            font-weight: 600;
            font-size: 1.15rem;
            /* Slightly larger name */
            color: #2c3e50;
        }

        .class-slot,
        .class-duration {
            font-size: 0.9rem;
            color: #5a6a7a;
            /* Slightly darker gray */
        }

        /* Status colors */
        .status-paid-full {
            color: #198754;
            /* Verde */
            font-weight: bold;
            font-size: 0.95rem;
            text-align: right;
            /* Alineación derecha para consistencia */
            display: block;
            /* Necesario para text-align */
        }

        .status-paid-partial {
            color: #ffc107;
            /* Amarillo */
            font-weight: bold;
            font-size: 0.95rem;
            text-align: right;
            /* Alineación derecha */
            display: block;
            /* Necesario para text-align */
        }

        .status-pending {
            color: #dc3545;
            /* Rojo */
            font-weight: bold;
            font-size: 0.95rem;
            text-align: right;
            /* Alineación derecha */
            display: block;
            /* Necesario para text-align */
        }

        /* --- NUEVO ESTILO para clase de recuperación sin pago --- */
        .status-recovery {
            font-weight: bold;
            /* Hacerla más gruesa */
            font-style: italic;
            /* Hacerla cursiva */
            color: #0d6efd;
            /* Usar un color distintivo (azul Bootstrap) */
            display: block;
            /* Convertirla en bloque para que ocupe ancho y permita text-align */
            text-align: right;
            align-items: end;
            /* Alinear el texto a la derecha */
            width: 100%;
            /* Asegurar que ocupe el ancho disponible */
            margin-top: 5px;
            /* Añadir un pequeño margen superior si es necesario */
            font-size: 0.95rem;
            /* Tamaño consistente con otros estados */
        }

        /* --- FIN NUEVO ESTILO --- */

        .payment-details {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
            text-align: right;
            /* Alinear detalles del pago a la derecha */
            display: block;
            /* Necesario para text-align */
        }

        /* Modal Styles */
        .modal-header {
            border-bottom: none;
        }

        .modal-header .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        .modal-body p strong {
            color: #333;
        }

        .modal-footer {
            border-top: 1px solid #dee2e6;
            background-color: #f8f9fa;
        }


        /* Receipt Styles */
        #receiptContent {
            border: 1px dashed #aaa;
            padding: 30px;
            margin: 20px auto;
            max-width: 550px;
            font-family: 'Consolas', 'Courier New', Courier, monospace;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        #receiptContent h4 {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            font-size: 1.3rem;
            color: #333;
        }

        #receiptContent p {
            margin-bottom: 10px;
            line-height: 1.6;
            font-size: 1rem;
        }

        #receiptContent p strong {
            display: inline-block;
            min-width: 140px;
        }

        #receiptContent .receipt-footer {
            margin-top: 35px;
            text-align: center;
            font-size: 0.85rem;
            color: #777;
            border-top: 1px dotted #ccc;
            padding-top: 15px;
        }

        .modal-lg-receipt {
            max-width: 700px;
        }

        /* Responsive Adjustments */
        @media (max-width: 767.98px) {
            .price-section {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 15px;
            }

            .price-display {
                text-align: left;
                padding-left: 10px;
            }

            #editPricesBtn {
                align-self: center;
                margin-top: 10px;
            }

            .student-item {
                flex-direction: column;
                align-items: stretch;
                padding: 15px;
            }

            .student-info,
            .payment-status-details,
            .payment-actions {
                flex-basis: auto;
                width: 100%;
                text-align: left;
                padding-right: 0;
                margin-bottom: 12px;
            }

            .payment-status-details,
            .payment-details,
            .status-paid-full,
            .status-paid-partial,
            .status-pending,
            .status-recovery {
                text-align: left;
                /* Alinear estados a la izquierda en móviles */
            }

            .payment-actions {
                margin-top: 5px;
                justify-content: flex-start;
                margin-bottom: 0;
                flex-wrap: wrap;
            }

            .month-display {
                font-size: 1.4rem;
                min-width: 150px;
            }

            .month-navigation {
                gap: 10px;
            }

            .modal-lg-receipt {
                max-width: 95%;
            }

            #receiptContent {
                padding: 20px;
            }
        }

        @media (max-width: 575.98px) {
            h2 {
                font-size: 1.8rem;
            }

            .payment-container {
                padding: 20px;
            }

            .student-name {
                font-size: 1.1rem;
            }

            .action-buttons-main .btn {
                display: block;
                width: 90%;
                margin: 8px auto;
            }

            .container.py-5 {
                padding-top: 1.5rem !important;
            }
        }

        /* Back to Top Button Styles */
        #backToTopBtn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: #0d6efd;
            color: white;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 50%;
            font-size: 18px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, background-color 0.2s ease;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #backToTopBtn:hover {
            background-color: #0a58ca;
        }

        #backToTopBtn[style*="opacity: 0"] {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <div class="payment-container" id="paymentContainer">
            <!-- Link Volver al Dashboard -->
            <div class="mb-4">
                <a href="dashboard.html" class="back-to-dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-arrow-left-short" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5" />
                    </svg> Volver al Dashboard
                </a>
            </div>
            <!-- Título Principal -->
            <h2 class="text-center mb-4">Control de Pagos Mensuales</h2>

            <!-- Sección de Precios -->
            <div class="price-section">
                <div class="price-display">40 min/mes: <span id="price40"></span></div>
                <div class="price-display">60 min/mes: <span id="price60"></span></div>
                <button id="editPricesBtn" class="btn btn-sm"
                    style="background-color: #f3a391; border-color: #f3a391; color: black;">Editar Precios</button>
            </div>

            <!-- Navegación de Mes -->
            <div class="month-navigation">
                <button id="prevMonthBtn" class="btn btn-sm"
                    style="background-color: #fae39e; border-color: #fae39e; color: black;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-chevron-left" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0" />
                    </svg> Anterior
                </button>
                <span id="monthDisplay" class="month-display">Cargando...</span>
                <button id="nextMonthBtn" class="btn btn-sm"
                    style="background-color: #fae39e; border-color: #fae39e; color: black;">
                    Siguiente <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-chevron-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708" />
                    </svg>
                </button>
            </div>
            <hr>
            <!-- Botones de Acción Principales (Exportar/Importar) -->
            <div class="action-buttons-main">
                <button id="exportDataBtn" class="btn btn-sm"
                    style="background-color: #c0d5c1; border-color: #c0d5c1; color: black;">Exportar Datos
                    (JSON)</button>
                <button id="importDataBtn" class="btn btn-sm"
                    style="background-color: #96a5c0; border-color: #96a5c0; color: black;">Importar Datos
                    (JSON)</button>
                <input type="file" id="fileInput" accept=".json" style="display: none;" />
            </div>
            <hr>

            <!-- Lista de Alumnos -->
            <h4 class="text-center mb-3" id="studentListTitle">Alumnos</h4>
            <ul class="student-list" id="studentList">
                <li class="text-center p-4">Cargando alumnos y pagos...</li>
            </ul>
        </div>
    </div>

    <!-- Modal Editar Precios -->
    <div class="modal fade" id="priceModal" tabindex="-1" aria-labelledby="priceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #c0d5c1; border-color: #c0d5c1; color: black;">
                    <h5 class="modal-title" id="priceModalLabel">Editar Precios Base Mensuales</h5> <button
                        type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="priceForm">
                        <div class="mb-3"> <label for="basePrice40Input" class="form-label">Precio Mensual (40
                                min)</label> <input type="number" id="basePrice40Input" class="form-control" required
                                min="0"> </div>
                        <div class="mb-3"> <label for="basePrice60Input" class="form-label">Precio Mensual (60
                                min)</label> <input type="number" id="basePrice60Input" class="form-control" required
                                min="0"> </div>
                    </form>
                </div>
                <div class="modal-footer"> <button type="button" class="btn" style="background-color: #f3a391;"
                        data-bs-dismiss="modal">Cancelar</button> <button type="button" class="btn"
                        style="background-color: #d9e6cc; border-color: #d9e6cc; color: black;"
                        id="savePricesBtn">Guardar Precios</button> </div>
            </div>
        </div>
    </div>

    <!-- Modal Registro/Modificación de Pago -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #c0d5c1; border-color: #c0d5c1; color: black;">
                    <h5 class="modal-title" id="paymentModalLabel">Registrar Pago</h5> <button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm" novalidate>
                        <input type="hidden" id="paymentStudentId" />
                        <input type="hidden" id="paymentYearMonth" />
                        <div class="mb-2"> <label class="form-label">Alumno:</label>
                            <p><strong id="paymentStudentName"></strong></p>
                        </div>
                        <div class="mb-2"> <label class="form-label">Mes a Pagar:</label>
                            <p><strong id="paymentMonthYearDisplay"></strong> (<span
                                    id="paymentClassCountDisplay"></span> clases)</p>
                        </div>
                        <div class="mb-3"> <label for="paymentClassesPaid" class="form-label">Clases a Pagar</label>
                            <select id="paymentClassesPaid" class="form-select" required></select>
                            <div class="invalid-feedback">Selecciona una opción de clases.</div>
                        </div>
                        <div class="mb-3"> <label class="form-label">Monto Sugerido:</label>
                            <p><strong id="suggestedAmountDisplay"></strong></p>
                        </div>
                        <div class="mb-3"> <label for="paymentAmount" class="form-label">Monto Pagado
                                Efectivamente</label> <input type="number" id="paymentAmount" class="form-control"
                                required min="0" step="0.01" />
                            <div class="invalid-feedback">Ingresa un monto válido (número positivo).</div>
                        </div>
                        <div class="mb-3"> <label for="paymentDate" class="form-label">Fecha de Pago</label> <input
                                type="date" id="paymentDate" class="form-control" required />
                            <div class="invalid-feedback">Selecciona una fecha válida.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer"> <button type="button" class="btn" style="background-color: #f3a391;"
                        data-bs-dismiss="modal">Cancelar</button> <button type="button" class="btn"
                        style="background-color: #d9e6cc; border-color: #d9e6cc; color: black;"
                        id="savePaymentBtn">Guardar Pago</button> </div>
            </div>
        </div>
    </div>

    <!-- Modal Comprobante -->
    <div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg-receipt">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #c0d5c1; border-color: #c0d5c1; color: black;">
                    <h5 class="modal-title" id="receiptModalLabel">Comprobante de Pago</h5> <button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="receiptContentContainer">
                        <div id="receiptContent">
                            <h4>Comprobante de Pago</h4>
                            <p><strong>Alumno:</strong> <span id="receiptStudentName"></span></p>
                            <p><strong>Mes Abonado:</strong> <span id="receiptMonthYear"></span></p>
                            <p><strong>Fecha de Pago:</strong> <span id="receiptPaymentDate"></span></p>
                            <p><strong>Clases Abonadas:</strong> <span id="receiptClassCount"></span></p>
                            <p><strong>Monto Abonado:</strong> $<span id="receiptAmount"></span></p>
                            <div class="receipt-footer"> Gracias por tu pago. </div>
                        </div>
                    </div>
                    <div class="mt-3"> <label for="receiptEmailInput" class="form-label">Enviar a Email:</label> <input
                            type="email" class="form-control" id="receiptEmailInput"
                            placeholder="Ingresa el email del destinatario"> </div>
                </div>
                <div class="modal-footer justify-content-center flex-wrap">
                    <button type="button" class="btn btn-sm"
                        style="background-color: #96a5c0; border-color: #96a5c0; color: black;"
                        id="downloadReceiptImageBtn"><svg class="bi me-1" width="16" height="16" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0" />
                            <path
                                d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z" />
                        </svg> Imagen</button>
                    <button type="button" class="btn btn-sm"
                        style="background-color: #fae39e; border-color: #fae39e; color: black;"
                        id="downloadReceiptPdfBtn"><svg class="bi me-1" width="16" height="16" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path
                                d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z" />
                            <path
                                d="M4.603 14.087a.8.8 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.7 7.7 0 0 1 1.482-.625c.49-.174.99-.326 1.493-.472a.5.5 0 0 1 .497.48.5.5 0 0 1-.497.51a6.7 6.7 0 0 0-1.442.439c-.56.2-.986.465-1.284.788-.297.322-.407.718-.383 1.152a.8.8 0 0 0 .438.42zM7.06 10.44a.3.3 0 0 1 .3-.295c.408 0 .76.162.993.402s.398.577.468.957a.3.3 0 0 1-.3.295c-.408 0-.76-.162-.993-.402a1.2 1.2 0 0 1-.468-.957z" />
                        </svg> PDF</button>
                    <button type="button" class="btn btn-sm"
                        style="background-color: #d9e6cc; border-color: #d9e6cc; color: black;"
                        id="sendReceiptEmailBtn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            fill="currentColor" class="bi bi-envelope" viewBox="0 0 16 16">
                            <path
                                d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1zm13 2.383-4.708 2.825L15 11.105zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741M1 11.105l4.708-2.897L1 5.383z" />
                        </svg> Enviar Email</button>
                    <button type="button" class="btn btn-sm" style="background-color: #f3a391;"
                        data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Botón "Volver Arriba" -->
    <button onclick="scrollToTop()" id="backToTopBtn" title="Volver arriba"
        style="background-color: #5b7d2b; border-color: #5b7d2b; color: black;"> <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Scripts JS: Bootstrap y SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Inicio del Script Principal de la Aplicación -->
    <script>
        // ===============================================================
        // --- INICIO: Lógica JavaScript para Control de Pagos ---
        // ===============================================================

        function xlsxScriptLoaded() { console.log("Librería XLSX cargada."); }
        function xlsxScriptFailed() { console.error("Error al cargar XLSX."); Swal.fire('Error Crítico', 'No se pudo cargar librería Excel.', 'error'); }

        (function () { emailjs.init({ publicKey: "VeY3vHwsOZrOOSsKI" }); })(); // *** TU PUBLIC KEY ***

        const studentList = document.getElementById('studentList');
        const monthDisplay = document.getElementById('monthDisplay');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const paymentForm = document.getElementById('paymentForm');
        const paymentModalEl = document.getElementById('paymentModal');
        const paymentModal = new bootstrap.Modal(paymentModalEl);
        const receiptModalEl = document.getElementById('receiptModal');
        const receiptModal = new bootstrap.Modal(receiptModalEl);
        const receiptContentContainer = document.getElementById('receiptContentContainer');
        const priceModalEl = document.getElementById('priceModal');
        const priceModal = new bootstrap.Modal(priceModalEl);
        const price40Display = document.getElementById('price40');
        const price60Display = document.getElementById('price60');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const fileInput = document.getElementById('fileInput');
        const downloadReceiptImageBtn = document.getElementById('downloadReceiptImageBtn');
        const downloadReceiptPdfBtn = document.getElementById('downloadReceiptPdfBtn');
        const sendReceiptEmailBtn = document.getElementById('sendReceiptEmailBtn');

        const reservationDataKey = 'reservasCalendarioV2';
        const paymentDataKey = 'studentPaymentDataV2';

        const defaultPrices = { duration40: 50000, duration60: 70000 };
        let students = {};
        let basePrices = { ...defaultPrices };
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const dayNames = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
        let receiptData = {};

        function getYearMonthKey(year, month) { return `${year}-${(month + 1).toString().padStart(2, '0')}`; }
        function formatCurrency(amount) { return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(amount); }
        function formatDate(dateString) { if (!dateString) return 'N/A'; try { const [y, m, d] = dateString.split('-'); return `${d}/${m}/${y}`; } catch (e) { return dateString; } }
        function countWeekdaysInMonth(year, month, targetDayName) { const targetDayIndex = dayNames.indexOf(targetDayName); if (targetDayIndex === -1) return 0; let count = 0; const date = new Date(Date.UTC(year, month, 1)); const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate(); for (let day = 1; day <= daysInMonth; day++) { date.setUTCDate(day); if (date.getUTCDay() === targetDayIndex) { count++; } } return count; }
        function calculateMonthlyDetails(year, month, studentDuration, studentDay) { const basePrice = studentDuration === 60 ? basePrices.duration60 : basePrices.duration40; const classCount = countWeekdaysInMonth(year, month, studentDay); const perClassPrice = classCount > 0 ? Math.round(basePrice / classCount) : basePrice; return { basePrice, classCount, perClassPrice }; }
        function saveData() { try { const dataToSave = { students: students, prices: basePrices }; localStorage.setItem(paymentDataKey, JSON.stringify(dataToSave)); console.log(`Datos guardados en ${paymentDataKey}.`); } catch (error) { console.error("Error guardando:", error); Swal.fire('Error', 'No se pudieron guardar los cambios.', 'error'); } }

        // --- MODIFICADO: Carga `classType` y `specificDate` desde reservas ---
        function loadData() {
            let loadedStudents = {}; let loadedPrices = { ...defaultPrices }; let processedStudents = {};
            try {
                const paymentStoredData = localStorage.getItem(paymentDataKey);
                if (paymentStoredData) { const parsedPaymentData = JSON.parse(paymentStoredData); loadedStudents = parsedPaymentData.students || {}; loadedPrices = parsedPaymentData.prices || { ...defaultPrices }; console.log("Datos de pagos previos cargados."); } else { console.log("No se encontraron datos de pagos previos."); }
                const reservationStoredData = localStorage.getItem(reservationDataKey);
                if (reservationStoredData) {
                    const parsedReservationData = JSON.parse(reservationStoredData); console.log("Datos de reservas encontrados. Procesando...");
                    for (const key in parsedReservationData) {
                        const reserva = parsedReservationData[key];
                        if (!reserva || typeof reserva !== 'object' || !reserva.nombre || !reserva.horaInicio || !reserva.duracion || !reserva.tipo) { console.warn(`Reserva inválida (clave ${key}). Saltando.`); continue; }
                        const dia = key.substring(0, key.lastIndexOf('-')); const normalizedName = reserva.nombre.toLowerCase().replace(/\s+/g, ''); const studentId = `${normalizedName}-${dia}-${reserva.horaInicio}`;
                        const newStudentEntry = { name: reserva.nombre, classDay: dia, classTime: reserva.horaInicio, duration: reserva.duracion, classType: reserva.tipo, specificDate: reserva.fechaEspecifica || null, email: '', payments: {} };
                        let existingDataFound = false;
                        if (loadedStudents[studentId]) {
                            console.log(`Fusionando datos para ID ${studentId}`); newStudentEntry.payments = loadedStudents[studentId].payments || {}; newStudentEntry.email = loadedStudents[studentId].email || ''; delete loadedStudents[studentId]; existingDataFound = true;
                        } else { const existingStudentKey = Object.keys(loadedStudents).find(sid => loadedStudents[sid].name === newStudentEntry.name && loadedStudents[sid].classDay === newStudentEntry.classDay && loadedStudents[sid].classTime === newStudentEntry.classTime); if (existingStudentKey) { console.log(`Fusionando por Nombre/Horario para ${newStudentEntry.name}`); newStudentEntry.payments = loadedStudents[existingStudentKey].payments || {}; newStudentEntry.email = loadedStudents[existingStudentKey].email || ''; delete loadedStudents[existingStudentKey]; existingDataFound = true; } }
                        processedStudents[studentId] = newStudentEntry;
                    }
                    console.log("Alumnos procesados desde reservas.");
                    for (const remainingId in loadedStudents) { console.log(`Añadiendo alumno ${remainingId} solo desde pagos.`); if (!loadedStudents[remainingId].classType) { loadedStudents[remainingId].classType = 'Desconocido'; } if (!loadedStudents[remainingId].hasOwnProperty('specificDate')) { loadedStudents[remainingId].specificDate = null; } processedStudents[remainingId] = loadedStudents[remainingId]; }
                } else { console.log("No se encontraron datos de reservas..."); for (const id in loadedStudents) { if (!loadedStudents[id].classType) { loadedStudents[id].classType = 'Desconocido'; } if (!loadedStudents[id].hasOwnProperty('specificDate')) { loadedStudents[id].specificDate = null; } } processedStudents = loadedStudents; }
            } catch (error) { console.error("Error cargando/parseando datos:", error); processedStudents = {}; loadedPrices = { ...defaultPrices }; Swal.fire('Advertencia', 'Error al cargar datos.', 'warning'); }
            students = processedStudents; basePrices = loadedPrices; updatePriceDisplay();
        }

        function updatePriceDisplay() { price40Display.textContent = formatCurrency(basePrices.duration40); price60Display.textContent = formatCurrency(basePrices.duration60); }

        // --- MODIFICADO: Muestra estado especial y oculta botón para recuperación ---
        function renderMonthlyView(year, month) {
            monthDisplay.textContent = `${monthNames[month]} ${year}`; studentList.innerHTML = ''; const yearMonthKey = getYearMonthKey(year, month); const studentIds = Object.keys(students);
            if (studentIds.length === 0) { studentList.innerHTML = '<li class="text-center text-muted p-4">No hay alumnos cargados.</li>'; return; }
            studentIds.sort((a, b) => students[a].name.localeCompare(students[b].name)).forEach(id => {
                const student = students[id];
                if (!student || !student.name || !student.classDay || !student.duration || !student.classTime) { console.warn(`Datos incompletos para alumno ID: ${id}. Saltando.`); return; }
                const monthlyDetails = calculateMonthlyDetails(year, month, student.duration, student.classDay); const payment = student.payments?.[yearMonthKey];
                const li = document.createElement('li'); li.className = 'student-item'; let statusHTML = ''; let actionsHTML = ''; let paymentDetailsHTML = '';
                if (payment) {
                    const paidClassesText = payment.isFullMonthPayment ? `Mes Completo` : `${payment.classesPaid} clase(s)`; paymentDetailsHTML = `<div class="payment-details"> Pagó ${formatCurrency(payment.amountPaid)} (${paidClassesText}) el ${formatDate(payment.paymentDate)} </div>`;
                    if (payment.isFullMonthPayment || (monthlyDetails.classCount > 0 && payment.classesPaid >= monthlyDetails.classCount)) { statusHTML = `<span class="status-paid-full">Pagado (Completo)</span>`; } else { const classCountText = monthlyDetails.classCount > 0 ? `/${monthlyDetails.classCount}` : ''; statusHTML = `<span class="status-paid-partial">Pago Parcial (${payment.classesPaid}${classCountText})</span>`; }
                    actionsHTML = `<button class="btn btn-sm view-receipt-btn" style="background-color: #96a5c0; border-color: #96a5c0; color: black;" data-studentid="${id}" data-yearmonth="${yearMonthKey}" title="Ver Comprobante"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-receipt" viewBox="0 0 16 16"><path d="M1.92.506a.5.5 0 0 1 .434.14L3 1.293l.646-.647a.5.5 0 0 1 .708 0L5 1.293l.646-.647a.5.5 0 0 1 .708 0L7 1.293l.646-.647a.5.5 0 0 1 .708 0L9 1.293l.646-.647a.5.5 0 0 1 .708 0L11 1.293l.646-.647a.5.5 0 0 1 .708 0L13 1.293l.646-.647a.5.5 0 0 1 .434-.14L15 1.5v13a.5.5 0 0 1-.053.224l-.5 2a.5.5 0 0 1-.447.276H1.5a.5.5 0 0 1-.447-.276l-.5-2A.5.5 0 0 1 1 14.5v-13Z M2 2v12h12V2z"/><path d="M3 4.5a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m3 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5"/></svg> Recibo</button> <button class="btn btn-sm register-payment-btn" style="background-color: #fae39e; border-color: #fae39e; color: black;" data-studentid="${id}" data-yearmonth="${yearMonthKey}" data-duration="${student.duration}" data-day="${student.classDay}" title="Modificar Pago"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11A1.5 1.5 0 0 0 15 13.5V6h-1v7.5a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H6v-1H2.5A1.5 1.5 0 0 0 1 2.5z"/></svg> Modificar</button>`;
                } else { // --- SIN PAGO REGISTRADO ---
                    if (student.classType === "Clase de recuperación") { // --- Caso: Recuperación ---
                        let fechaTexto = '';
                        if (student.specificDate) { try { fechaTexto = ` (${formatDate(student.specificDate)})`; } catch (e) { console.warn(`Error formateando fecha '${student.specificDate}'`); fechaTexto = ` (Fecha: ${student.specificDate})`; } } else { console.warn(`Recuperación sin fecha para ${student.name}`); fechaTexto = ' (Fecha no especificada)'; }
                        statusHTML = `<span class="status-recovery">Clase de recuperación${fechaTexto}</span>`; // Texto especial y clase CSS
                        actionsHTML = ''; // Sin botón de registrar pago
                    } else { // --- Caso: Pendiente Normal ---
                        statusHTML = `<span class="status-pending">Pendiente</span>`;
                        actionsHTML = `<button class="btn btn-sm register-payment-btn" style="background-color: #c0d5c1; border-color: #c0d5c1; color: black;" data-studentid="${id}" data-yearmonth="${yearMonthKey}" data-duration="${student.duration}" data-day="${student.classDay}" title="Registrar Pago"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cash-coin" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11 15a4 4 0 1 0 0-8 4 4 0 0 0 0 8m5-4a5 5 0 1 1-10 0 5 5 0 0 1 10 0"/><path d="M9.438 11.944c.047.596.518 1.06 1.363 1.116v.44h.375v-.443c.875-.061 1.386-.529 1.386-1.207 0-.618-.39-.935-1.37-1.169-.8-.193-1.425-.384-1.425-1.059 0-.517.397-.977 1.298-1.051v-.48h.375v.488c.77.07 1.216.548 1.216 1.184 0 .631-.373.929-.98 1.138-.554.132-1.116.312-1.116.91 0 .439.323.808 1.317.849z M1.01 1v1.66h.375v-1.66H1.01z M3.47 1v1.66h.375v-1.66h-.375zm2.133 1.66h.375v-1.66h-.375V1.66zm2.134 0h.375v-1.66h-.375V1.66zm2.133 0h.375v-1.66h-.375v-1.66zm1.734 0h.375v-1.66h-.375v1.66z M.5 1.5a.5.5 0 0 0 0 1h15a.5.5 0 0 0 0-1zM1 11.88V15h15v-3.12A6.9 6.9 0 0 1 11 13c-1.34 0-2.61-.386-3.66-1.042a7 7 0 0 1-2.23-2.23C4.386 8.61 4 7.34 4 6a7 7 0 0 1 1.042-3.66A7 7 0 0 1 7.27.586 7 7 0 0 1 11 0a7 7 0 0 1 4.414 1.88A7 7 0 0 1 16 6c0 1.34-.386 2.61-1.042 3.66a7 7 0 0 1-2.23 2.23C11.73 11.413 10.34 11.88 9 11.88c-1.34 0-2.61-.386-3.66-1.042a7 7 0 0 1-2.23-2.23A7 7 0 0 1 .96 6H0a8 8 0 0 0 .04 1.042A8 8 0 0 0 2.3 9.27a8 8 0 0 0 2.23 2.23A8 8 0 0 0 6 12.04c1.042.96 2.414 1.46 3.88 1.46 1.466 0 2.838-.5 3.88-1.46A8 8 0 0 0 15.96 9H15a7 7 0 0 1-.04 1.042 7 7 0 0 1-1.88 3.23 7 7 0 0 1-2.23 2.23C9.838 15.614 8.466 16 7 16c-1.466 0-2.838-.5-3.88-1.46A8 8 0 0 0 1 11.88"/></svg> Registrar Pago</button>`;
                    }
                }
                li.innerHTML = `<div class="student-info"><span class="student-name">${student.name}</span><span class="class-slot">Clase: ${student.classDay} ${student.classTime}</span><span class="class-duration">Duración: ${student.duration} min</span><span class="class-duration" style="font-style: italic;">Tipo: ${student.classType || 'No definido'}</span> ${student.specificDate ? `<span class="class-duration" style="font-style: italic; font-size: 0.8em;">Fecha Esp: ${student.specificDate}</span>` : ''}</div> <div class="payment-status-details">${statusHTML}${paymentDetailsHTML}</div> <div class="payment-actions">${actionsHTML}</div>`;
                studentList.appendChild(li);
            });
            document.querySelectorAll('.register-payment-btn').forEach(button => button.addEventListener('click', handleRegisterPaymentClick));
            document.querySelectorAll('.view-receipt-btn').forEach(button => button.addEventListener('click', handleViewReceiptClick));
        }

        // --- Manejadores de Eventos y Lógica de Modales (Mayormente sin cambios, pero con lógica de deshabilitación incorporada) ---
        function handleRegisterPaymentClick(event) { const btn = event.currentTarget; openPaymentModal(btn.dataset.studentid, btn.dataset.yearmonth, parseInt(btn.dataset.duration, 10), btn.dataset.day); }
        function handleViewReceiptClick(event) { console.log('Click en botón Recibo. StudentID:', event.currentTarget.dataset.studentid, 'YearMonth:', event.currentTarget.dataset.yearmonth); openReceiptModal(event.currentTarget.dataset.studentid, event.currentTarget.dataset.yearmonth); }
        function openPriceModal() { document.getElementById('basePrice40Input').value = basePrices.duration40; document.getElementById('basePrice60Input').value = basePrices.duration60; priceModal.show(); }
        function savePrices() { const price40 = parseFloat(document.getElementById('basePrice40Input').value); const price60 = parseFloat(document.getElementById('basePrice60Input').value); if (isNaN(price40) || isNaN(price60) || price40 < 0 || price60 < 0) { Swal.fire('Error', 'Ingresa precios válidos.', 'error'); return; } basePrices.duration40 = price40; basePrices.duration60 = price60; saveData(); updatePriceDisplay(); renderMonthlyView(currentYear, currentMonth); priceModal.hide(); Swal.fire('Éxito', 'Precios actualizados.', 'success'); }

        // --- MODIFICADO: Aplica reglas y deshabilita campos/botones para tipos especiales ---
        function openPaymentModal(studentId, yearMonth, studentDuration, studentDay) {
            const student = students[studentId]; if (!student) { Swal.fire('Error', 'No se encontró info del alumno.', 'error'); return; }
            const classType = student.classType || 'Desconocido'; console.log(`Abriendo modal pago para: ${student.name} (ID: ${studentId}), Tipo: ${classType}, Mes: ${yearMonth}`);
            const [year, monthNum] = yearMonth.split('-').map(Number); const month = monthNum - 1; const yearMonthKey = getYearMonthKey(year, month); const monthName = monthNames[month]; const monthlyDetails = calculateMonthlyDetails(year, month, studentDuration, studentDay); const existingPayment = student.payments?.[yearMonthKey];
            const paymentModalLabel = document.getElementById('paymentModalLabel'); const paymentStudentName = document.getElementById('paymentStudentName'); const paymentMonthYearDisplay = document.getElementById('paymentMonthYearDisplay'); const paymentClassCountDisplay = document.getElementById('paymentClassCountDisplay'); const selectClasses = document.getElementById('paymentClassesPaid'); const suggestedAmountDisplay = document.getElementById('suggestedAmountDisplay'); const paymentAmountInput = document.getElementById('paymentAmount'); const paymentDateInput = document.getElementById('paymentDate'); const savePaymentBtn = document.getElementById('savePaymentBtn');
            document.getElementById('paymentStudentId').value = studentId; document.getElementById('paymentYearMonth').value = yearMonthKey; paymentStudentName.textContent = student.name; paymentMonthYearDisplay.textContent = `${monthName} ${year}`; paymentClassCountDisplay.textContent = monthlyDetails.classCount > 0 ? monthlyDetails.classCount : '0';
            paymentForm.classList.remove('was-validated'); savePaymentBtn.disabled = false;

            if (classType === "Clase de prueba") {
                console.log("Aplicando reglas para Clase de prueba."); paymentModalLabel.textContent = "Registrar Pago (Clase de Prueba)"; selectClasses.innerHTML = '<option value="1" selected>1 clase (Prueba)</option>'; selectClasses.disabled = true;
                const oneClassPrice = monthlyDetails.classCount > 0 ? monthlyDetails.perClassPrice : basePrices.duration40; console.log(`Clase de Prueba: Precio 1 clase = ${formatCurrency(oneClassPrice)}`);
                suggestedAmountDisplay.textContent = formatCurrency(oneClassPrice); paymentAmountInput.value = oneClassPrice.toFixed(2); paymentAmountInput.disabled = true; // <-- Monto deshabilitado
                paymentDateInput.valueAsDate = existingPayment ? new Date(existingPayment.paymentDate + 'T00:00:00') : new Date(); selectClasses.onchange = null;
            } else if (classType === "Clase de recuperación") {
                console.log("Aplicando reglas para Clase de recuperación."); paymentModalLabel.textContent = "Registrar (Clase de Recuperación - Sin Costo)"; selectClasses.innerHTML = '<option value="0" selected>0 clases (Recuperación)</option>'; selectClasses.disabled = true;
                suggestedAmountDisplay.textContent = formatCurrency(0); paymentAmountInput.value = '0.00'; paymentAmountInput.disabled = true; // <-- Monto deshabilitado
                paymentDateInput.valueAsDate = existingPayment ? new Date(existingPayment.paymentDate + 'T00:00:00') : new Date();
                savePaymentBtn.disabled = true; // <-- Botón Guardar deshabilitado
                console.log("Botón Guardar deshabilitado para Clase de recuperación."); selectClasses.onchange = null;
            } else { // --- Lógica por defecto ---
                console.log(`Aplicando lógica por defecto para tipo: ${classType}`); selectClasses.innerHTML = ''; selectClasses.disabled = false; paymentAmountInput.disabled = false; savePaymentBtn.disabled = false;
                if (monthlyDetails.classCount > 0) {
                    for (let i = 1; i <= monthlyDetails.classCount; i++) { const option = document.createElement('option'); option.value = i; option.textContent = `${i} clase(s) (${formatCurrency(i * monthlyDetails.perClassPrice)})`; selectClasses.appendChild(option); }
                    const fullMonthOption = document.createElement('option'); fullMonthOption.value = 'full'; fullMonthOption.textContent = `Mes Completo (${monthlyDetails.classCount} clases) (${formatCurrency(monthlyDetails.basePrice)})`; selectClasses.appendChild(fullMonthOption);
                    if (existingPayment) {
                        paymentModalLabel.textContent = "Modificar Pago"; paymentAmountInput.value = existingPayment.amountPaid.toFixed(2); paymentDateInput.value = existingPayment.paymentDate;
                        if (existingPayment.hasOwnProperty('isFullMonthPayment') && existingPayment.hasOwnProperty('classesPaid')) { selectClasses.value = existingPayment.isFullMonthPayment ? 'full' : existingPayment.classesPaid.toString(); const selectedOnLoad = selectClasses.value; let suggestedOnLoad = 0; if (selectedOnLoad === 'full') { suggestedOnLoad = monthlyDetails.basePrice; } else { const numClasses = parseInt(selectedOnLoad, 10); suggestedOnLoad = (numClasses > 0 && monthlyDetails.perClassPrice > 0) ? numClasses * monthlyDetails.perClassPrice : 0; } suggestedAmountDisplay.textContent = formatCurrency(suggestedOnLoad); } else { console.warn("Pago existente sin props esperadas.", existingPayment); selectClasses.value = 'full'; suggestedAmountDisplay.textContent = formatCurrency(monthlyDetails.basePrice); }
                    } else { paymentModalLabel.textContent = "Registrar Pago"; selectClasses.value = 'full'; suggestedAmountDisplay.textContent = formatCurrency(monthlyDetails.basePrice); paymentAmountInput.value = monthlyDetails.basePrice.toFixed(2); paymentDateInput.valueAsDate = new Date(); }
                } else {
                    paymentModalLabel.textContent = "Registrar Pago (0 clases este mes)"; selectClasses.innerHTML = '<option value="0" selected>0 clases este mes</option>'; selectClasses.disabled = true; suggestedAmountDisplay.textContent = formatCurrency(0); paymentAmountInput.value = '0.00'; paymentAmountInput.disabled = true; paymentDateInput.valueAsDate = new Date(); savePaymentBtn.disabled = true;
                    if (existingPayment) { paymentModalLabel.textContent = "Modificar Pago (0 clases este mes)"; paymentAmountInput.value = existingPayment.amountPaid.toFixed(2); paymentAmountInput.disabled = false; paymentDateInput.value = existingPayment.paymentDate; savePaymentBtn.disabled = false; }
                }
                selectClasses.onchange = () => { const selectedValue = selectClasses.value; let suggestedAmount = 0; if (selectedValue === 'full') { suggestedAmount = monthlyDetails.basePrice; } else { const numClasses = parseInt(selectedValue, 10); suggestedAmount = (numClasses > 0 && monthlyDetails.perClassPrice > 0) ? numClasses * monthlyDetails.perClassPrice : 0; } suggestedAmountDisplay.textContent = formatCurrency(suggestedAmount); paymentAmountInput.value = suggestedAmount.toFixed(2); };
            }
            paymentModal.show();
        }

        // --- MODIFICADO: Verifica si el botón guardar está deshabilitado ---
        function savePayment() {
            console.log('Función savePayment iniciada.'); const saveBtn = document.getElementById('savePaymentBtn');
            if (saveBtn.disabled) { console.log("Intento de guardar con botón deshabilitado. Acción cancelada."); paymentModal.hide(); return; } // <-- Salir si está deshabilitado

            if (!paymentForm.checkValidity()) { console.log('Validación falló.'); paymentForm.classList.add('was-validated'); const firstInvalidField = paymentForm.querySelector(':invalid'); if (firstInvalidField) { firstInvalidField.focus(); } return; }
            console.log('Validación PASÓ.'); const studentId = document.getElementById('paymentStudentId').value; const yearMonth = document.getElementById('paymentYearMonth').value; const amountPaidInput = document.getElementById('paymentAmount'); const amountPaid = parseFloat(amountPaidInput.value); const paymentDate = document.getElementById('paymentDate').value; const selectClasses = document.getElementById('paymentClassesPaid'); const classesPaidSelection = selectClasses.value;
            console.log('Valores leídos:', { studentId, yearMonth, amountPaid, paymentDate, classesPaidSelection });
            if (isNaN(amountPaid) || amountPaid < 0 || !paymentDate || !yearMonth || !studentId) { console.error('Error: Datos inválidos.', { studentId, yearMonth, amountPaid, paymentDate }); Swal.fire('Datos Inválidos', 'Verifica monto y fecha.', 'warning'); paymentForm.classList.add('was-validated'); return; }
            const isFullMonthPayment = classesPaidSelection === 'full'; const classCountSpan = document.getElementById('paymentClassCountDisplay'); let monthClassCount = 0; if (classCountSpan) { monthClassCount = parseInt(classCountSpan.textContent, 10); if (isNaN(monthClassCount)) monthClassCount = 0; } const classesPaidCount = isFullMonthPayment ? monthClassCount : parseInt(classesPaidSelection, 10);
            if (!students[studentId]) { console.error(`Error Crítico: Alumno ${studentId} no encontrado.`); Swal.fire('Error Interno', 'No se encontró el alumno.', 'error'); return; }
            if (!students[studentId].payments) { console.log(`Creando 'payments' para ${studentId}`); students[studentId].payments = {}; }
            const paymentObject = { amountPaid: amountPaid, paymentDate: paymentDate, classesPaid: isNaN(classesPaidCount) ? 0 : classesPaidCount, isFullMonthPayment: isFullMonthPayment, recordedAt: new Date().toISOString() };
            console.log(`Objeto pago para ${yearMonth}:`, paymentObject); students[studentId].payments[yearMonth] = paymentObject;
            console.log('Asignado. Guardando...'); saveData();
            console.log('Guardado. Renderizando...'); renderMonthlyView(currentYear, currentMonth); paymentModal.hide();
            // No mostrar alerta de éxito para $0
            if (amountPaid === 0 && classesPaidCount === 0 && students[studentId]?.classType === "Clase de recuperación") {
                console.log("Registro de recuperación $0 guardado (o no, si el botón estaba deshabilitado). Sin alerta de éxito.");
            } else { Swal.fire('¡Guardado!', 'Pago registrado/actualizado.', 'success'); }
        }

        function openReceiptModal(studentId, yearMonth) { console.log('Abriendo modal recibo para:', { studentId, yearMonth }); const student = students[studentId]; const payment = student?.payments?.[yearMonth]; if (!student || !payment) { console.error('Error fatal: No se encontró alumno o pago.', { studentId, yearMonth }); Swal.fire('Error', 'No se encontró info de pago.', 'error'); return; } const [year, monthNum] = yearMonth.split('-').map(Number); const monthName = monthNames[monthNum - 1]; const monthlyDetails = calculateMonthlyDetails(year, monthNum - 1, student.duration, student.classDay); receiptData = { studentId, studentName: student.name, studentEmail: student.email || '', monthYear: `${monthName} ${year}`, paymentDate: formatDate(payment.paymentDate), amountFormatted: formatCurrency(payment.amountPaid), amountRaw: payment.amountPaid, classCount: payment.isFullMonthPayment ? monthlyDetails.classCount : payment.classesPaid, isFullMonth: payment.isFullMonthPayment }; console.log('Datos recibo:', receiptData); document.getElementById('receiptStudentName').textContent = receiptData.studentName; document.getElementById('receiptMonthYear').textContent = receiptData.monthYear; document.getElementById('receiptPaymentDate').textContent = receiptData.paymentDate; document.getElementById('receiptAmount').textContent = payment.amountPaid.toFixed(2); document.getElementById('receiptClassCount').textContent = receiptData.isFullMonth ? `Mes Completo (${receiptData.classCount} ${receiptData.classCount === 1 ? 'clase' : 'clases'})` : `${receiptData.classCount} ${receiptData.classCount === 1 ? 'clase' : 'clases'}`; document.getElementById('receiptEmailInput').value = receiptData.studentEmail; console.log('Mostrando modal recibo...'); receiptModal.show(); }
        async function generateReceiptCanvas() { console.log('Generando Canvas...'); const el = document.getElementById('receiptContent'); if (!el) { console.error("#receiptContent no encontrado."); Swal.fire('Error Técnico', 'Elemento recibo no encontrado.', 'error'); return null; } if (typeof window.html2canvas === 'undefined') { console.error("html2canvas no definido."); Swal.fire('Error Técnico', 'Falta librería html2canvas.', 'error'); return null; } try { const canvas = await window.html2canvas(el, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }); console.log('Canvas OK:', canvas); return canvas; } catch (err) { console.error("Error html2canvas:", err); Swal.fire('Error Imagen', 'Error al generar imagen.', 'error'); return null; } }
        async function downloadReceiptAsImage() { console.log('Descargando Imagen...'); const canvas = await generateReceiptCanvas(); if (!canvas) return; try { const img = canvas.toDataURL('image/png'); const link = document.createElement('a'); link.href = img; const safe = `comprobante_${receiptData.studentName}_${receiptData.monthYear}`.replace(/[^a-z0-9_-]/gi, '_') + '.png'; link.download = safe; document.body.appendChild(link); link.click(); document.body.removeChild(link); console.log('Descarga Imagen OK.'); } catch (err) { console.error("Error descarga imagen:", err); Swal.fire('Error Descarga', 'No se pudo descargar imagen.', 'error'); } }
        async function downloadReceiptAsPdf() { console.log('Descargando PDF...'); const canvas = await generateReceiptCanvas(); if (!canvas) return; if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') { console.error("jsPDF no definido."); Swal.fire('Error Técnico', 'Falta librería jsPDF.', 'error'); return; } const { jsPDF } = window.jspdf; try { const img = canvas.toDataURL('image/png'); const pdf = new jsPDF({ o: 'p', u: 'pt', f: 'a5' }); const props = pdf.getImageProperties(img); const w = pdf.internal.pageSize.getWidth(); const h = pdf.internal.pageSize.getHeight(); const m = 40; const aw = w - 2 * m; const ah = h - 2 * m; const r = props.width / props.height; let fw = props.width; let fh = props.height; if (fw > aw) { fw = aw; fh = fw / r; } if (fh > ah) { fh = ah; fw = fh * r; } const x = (w - fw) / 2; const y = m; pdf.addImage(img, 'PNG', x, y, fw, fh); const safe = `comprobante_${receiptData.studentName}_${receiptData.monthYear}`.replace(/[^a-z0-9_-]/gi, '_') + '.pdf'; pdf.save(safe); console.log('Descarga PDF OK.'); } catch (err) { console.error("Error PDF:", err); Swal.fire('Error PDF', 'No se pudo generar/descargar PDF.', 'error'); } }
        async function sendReceiptEmail() { console.log('Enviando Email...'); const input = document.getElementById('receiptEmailInput'); const email = input.value.trim(); if (!email) { Swal.fire('Falta Email', 'Ingresa correo.', 'warning'); input.focus(); return; } if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { Swal.fire('Email Inválido', 'Ingresa dirección válida.', 'warning'); input.focus(); input.select(); return; } if (receiptData.studentId && students[receiptData.studentId] && email && !students[receiptData.studentId].email) { students[receiptData.studentId].email = email; saveData(); console.log(`Email actualizado para ${receiptData.studentName} a ${email}`); } Swal.fire({ title: 'Enviando Email...', text: `Preparando para ${email}`, allowOutsideClick: false, didOpen: () => { Swal.showLoading() } }); try { const html = `<div style="font-family: Arial, sans-serif; border: 1px solid #eee; padding: 20px;background-color: #d9e6cc;border-radius:15px;"><h4 style="text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">Comprobante de Pago</h4><p><strong>Alumno:</strong> ${receiptData.studentName}</p><p><strong>Mes Abonado:</strong> ${receiptData.monthYear}</p><p><strong>Fecha de Pago:</strong> ${receiptData.paymentDate}</p><p><strong>Clases Abonadas:</strong> ${receiptData.isFullMonth ? `Mes Completo (${receiptData.classCount})` : receiptData.classCount}</p><p><strong>Monto Abonado:</strong> ${receiptData.amountFormatted}</p><p style="margin-top: 30px; text-align: center; font-size: 0.9em; color: #777;">Gracias por tu pago.</p></div>`; const serviceID = 'service_h2fm824'; const templateID = 'template_v7gzygn'; const [mName, yStr] = receiptData.monthYear.split(' '); const params = { mes: mName, year: yStr, email: email, recibo: html, to_name: receiptData.studentName }; console.log("Enviando con params:", params); await emailjs.send(serviceID, templateID, params); console.log('Email enviado!'); Swal.fire('¡Enviado!', `Comprobante enviado a ${email}.`, 'success'); } catch (error) { console.error('Error email:', error); Swal.fire('Error', `No se pudo enviar email: ${error?.text || error?.message || 'Desconocido'}`, 'error'); } }
        function exportData() { try { const data = { version: 3, createdAt: new Date().toISOString(), students: students, prices: basePrices }; const str = JSON.stringify(data, null, 2); const blob = new Blob([str], { type: 'application/json;charset=utf-8' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; const ts = new Date().toISOString().split('T')[0].replace(/-/g, ''); link.download = `datos_pagos_alumnos_v3_${ts}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); Swal.fire('¡Exportado!', 'Datos guardados en JSON.', 'success'); } catch (error) { console.error("Error exportando:", error); Swal.fire('Error', 'Error al exportar.', 'error'); } }
        function importData(event) { const file = event.target.files[0]; if (!file) return; if (!file.name.toLowerCase().endsWith('.json')) { Swal.fire('Inválido', 'Selecciona .json.', 'error'); fileInput.value = null; return; } const reader = new FileReader(); reader.onload = (e) => { const content = e.target.result; try { const imported = JSON.parse(content); if (typeof imported !== 'object' || imported === null || (!imported.students && !imported.prices)) throw new Error("Estructura JSON inválida."); if (!imported.students || typeof imported.students !== 'object') throw new Error("'students' inválido."); if (imported.prices && (typeof imported.prices !== 'object' || isNaN(imported.prices.duration40) || isNaN(imported.prices.duration60))) throw new Error("'prices' inválido."); Swal.fire({ title: 'Confirmar Importación', html: `Datos de <strong>${file.name}</strong>.<br>¿Reemplazar <b>TODOS</b> los datos?<br><b style='color:red;'>¡Irreversible!</b>`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Sí, reemplazar', cancelButtonText: 'Cancelar' }).then((result) => { if (result.isConfirmed) { console.log("Importando..."); students = imported.students || {}; basePrices = imported.prices || { ...defaultPrices }; for (const id in students) { if (!students[id].payments) students[id].payments = {}; if (!students[id].classType) students[id].classType = 'Desconocido'; if (!students[id].hasOwnProperty('specificDate')) students[id].specificDate = null; } saveData(); updatePriceDisplay(); renderMonthlyView(currentYear, currentMonth); Swal.fire('¡Importado!', 'Datos actualizados.', 'success'); console.log("Importación OK."); } else { console.log("Importación cancelada."); } }); } catch (error) { console.error("Error procesando JSON:", error); Swal.fire('Error Importación', `No se procesó archivo. ¿JSON válido?\n<br><small>${error.message}</small>`, 'error'); } finally { fileInput.value = null; } }; reader.onerror = (e) => { console.error("Error leyendo archivo:", e); Swal.fire('Error Lectura', 'No se leyó archivo.', 'error'); fileInput.value = null; }; reader.readAsText(file); }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM cargado."); loadData(); renderMonthlyView(currentYear, currentMonth);
            prevMonthBtn.addEventListener('click', () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderMonthlyView(currentYear, currentMonth); });
            nextMonthBtn.addEventListener('click', () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderMonthlyView(currentYear, currentMonth); });
            document.getElementById('editPricesBtn').addEventListener('click', openPriceModal); document.getElementById('savePricesBtn').addEventListener('click', savePrices); document.getElementById('savePaymentBtn').addEventListener('click', savePayment); downloadReceiptImageBtn.addEventListener('click', downloadReceiptAsImage); downloadReceiptPdfBtn.addEventListener('click', downloadReceiptAsPdf); sendReceiptEmailBtn.addEventListener('click', sendReceiptEmail); exportDataBtn.addEventListener('click', exportData); importDataBtn.addEventListener('click', () => fileInput.click()); fileInput.addEventListener('change', importData);
            initializeBackToTopButton();
        });

        // --- Lógica Botón Volver Arriba ---
        let mybutton = null; function scrollFunction() { if (mybutton && (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100)) { if (mybutton.style.display !== "flex" || mybutton.style.opacity === "0") { mybutton.style.display = "flex"; setTimeout(() => { mybutton.style.opacity = "1"; }, 10); } } else if (mybutton) { if (mybutton.style.opacity !== "0") { mybutton.style.opacity = "0"; } } } function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); } function initializeBackToTopButton() { mybutton = document.getElementById("backToTopBtn"); if (mybutton) { console.log("Botón 'Volver Arriba' OK."); scrollFunction(); window.onscroll = scrollFunction; } else { console.error("#backToTopBtn no encontrado."); } }
    </script>
</body>

</html>