<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Calendario de Reservas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
        integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
        integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
        integrity="sha512-r22gChDnGvCbOBVEEYcvbRPcfTaXflcJrycv5fK7NfYMhAxtQQEz3O4ht6iAnWvSMnCjU/hV9YEr7+5JaK9MAA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" onload="xlsxScriptLoaded()"
        onerror="xlsxScriptFailed()"></script>
    <style>
        /* --- ESTILOS CSS (Sin cambios respecto a la versi√≥n anterior) --- */
        body {
            background-color: #dde9ce !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            line-height: 1.6;
            color: #495057
        }

        .calendar-container {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .09);
            margin-bottom: 30px;
            border: 1px solid #d8e0cc;
            position: relative
        }

        .back-to-dashboard {
            color: #0d6efd;
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: color 0.2s ease;
        }

        .back-to-dashboard:hover {
            color: #5a7d2a
        }

        .back-to-dashboard svg {
            width: 1em;
            height: 1em;
            margin-right: 3px;
            vertical-align: text-bottom
        }

        .calendar-title {
            text-align: center;
            margin-bottom: 15px;
            font-weight: 600;
            color: #5a7d2a;
            padding-top: 25px
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1.5rem;
            margin-top: 25px;
            overflow: visible
        }

        @media (max-width:1200px) {
            .calendar {
                grid-template-columns: repeat(3, 1fr)
            }
        }

        @media (max-width:768px) {
            .calendar {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem
            }
        }

        @media (max-width:576px) {
            .calendar {
                grid-template-columns: 1fr;
                gap: 1rem
            }

            .action-buttons .btn {
                width: calc(50% - 10px)
            }
        }

        .day {
            background: #fdfdfd;
            border: 1px solid #e0e7d1;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, .05);
            min-height: 380px
        }

        .day h5 {
            border-bottom: 1px solid #e0e7d1;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            color: #5a7d2a;
            text-align: center;
            font-size: 1.1rem
        }

        .hour {
            background: #f8f9fa;
            color: #495057;
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            transition: background-color .2s ease, transform .1s ease, box-shadow .2s ease;
            border: 1px solid #dee2e6;
            font-size: .9rem
        }

        .hour:hover:not(.reserved) {
            background-color: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, .08)
        }

        .reserved {
            color: #fff;
            cursor: pointer;
            font-weight: 700;
            padding: 12px;
            font-size: .9rem;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: center;
            border: 1px solid transparent;
            transition: filter .2s ease, transform .1s ease, box-shadow .2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, .1)
        }

        .tipo-individual {
            background-color: #ffe0b3;
            border-color: #ffe0b3;
            color: #333
        }

        .tipo-grupal {
            background-color: #c7e89b;
            border-color: #c7e89b;
            color: #333
        }

        .tipo-ayuda-ingreso-a-institutos {
            background-color: #b3e6f2;
            border-color: #b3e6f2;
            color: #333
        }

        .tipo-clase-de-prueba {
            background-color: #b3e6f2;
            border-color: #b3e6f2;
            color: #333
        }

        .tipo-clase-de-recuperacion {
            background-color: #f59e90;
            border-color: #e38e80;
            color: #333
        }

        .tipo-default {
            background-color: #6c757d;
            border-color: #5c636a;
            color: #fff
        }

        .reserved strong {
            display: block;
            margin-bottom: 4px;
            font-size: .95rem
        }

        .reserved small {
            font-weight: 400;
            font-style: italic;
            display: block;
            margin-top: 3px;
            font-size: .8rem;
            opacity: .9
        }

        .reserved .specific-date {
            font-weight: bold;
            font-style: normal;
        }

        .reserved .participant-info {
            font-weight: normal;
            font-style: normal;
            opacity: 0.8;
        }

        .reserved:hover {
            filter: brightness(95%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, .15)
        }

        .modal-header {
            background-color: #8fa376;
            color: #fff;
            border-bottom: none;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            padding: 1rem 1.5rem
        }

        .modal-content {
            border-radius: 13px;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, .2)
        }

        .modal-body {
            padding: 1.5rem
        }

        .modal-footer {
            border-top: 1px solid #dee2e6;
            padding: 1rem 1.5rem
        }

        .swal2-container {
            z-index: 1060;
            justify-content: center !important;
            align-items: center !important
        }

        .action-buttons {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px
        }

        .action-buttons .btn {
            flex-grow: 0;
            flex-shrink: 0
        }

        #backToTopBtn {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: #5a7d2a;
            color: white;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: opacity 0.3s ease-in-out, background-color 0.2s;
            justify-content: center;
            align-items: center;
        }

        #backToTopBtn:hover {
            background-color: #486623;
        }

        #backToTopBtn.show {
            display: flex;
            opacity: 1;
        }

        #grupalParticipantsGroup {
            border: 1px dashed #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            background-color: #f8f9fa;
        }

        .participant-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-end;
        }

        .participant-row .form-group {
            flex-grow: 1;
            margin-bottom: 0;
        }

        .participant-row .btn-remove-participant {
            flex-shrink: 0;
            height: calc(1.5em + .75rem + 2px);
        }

        #participantsListContainer .participant-row:first-child .btn-remove-participant {
            visibility: hidden;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="..."
        crossorigin="anonymous" referrerpolicy="no-referrer" onload="xlsxScriptLoaded()" onerror="xlsxScriptFailed()">
        </script>
</head>

<body style="background-color: #dde9ce !important;">
    <div class="container py-4">
        <div class="calendar-container" id="calendarContainer">
            <!-- Cabecera (Unchanged) -->
            <div class="mb-4">
                <a href="dashboard.html" class="back-to-dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-arrow-left-short" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5" />
                    </svg>
                    Volver al Dashboard
                </a>
            </div>
            <h2 class="calendar-title">Calendario de Clases Semanal</h2>

            <!-- Botones de Acci√≥n (Unchanged) -->
            <div class="action-buttons">
                <button id="downloadImageBtn" class="btn btn-sm" style="background-color: #f3a391;"> <svg
                        class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0" />
                        <path
                            d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z" />
                    </svg> Exportar Imagen </button>
                <button id="downloadPdfBtn" class="btn btn-sm"
                    style="background-color: #fae39e; border-color: #fae39e; color: black;"> <svg class="bi me-1"
                        width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path
                            d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z" />
                        <path fill-rule="evenodd"
                            d="M5 11.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5" />
                    </svg> Exportar PDF </button>
                <button id="exportExcelBtn" class="btn btn-sm"
                    style="background-color: #c0d5c1; border-color: #c0d5c1;color: black;"> <svg
                        xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-file-earmark-spreadsheet me-1" viewBox="0 0 16 16">
                        <path
                            d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V9h-3V6h1V4.5h-1A1.5 1.5 0 0 1 9.5 3M3 11h10v1h-3v2h3v1h-3v2H9v-2H6v2H5v-2H3z" />
                        <path d="M3 6h10v3H3z" />
                    </svg> Exportar Excel </button>
                <button id="exportDataBtn" class="btn btn-sm"
                    style="background-color: #d9e6cc; border-color: #d9e6cc; color: black;"> <svg
                        xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-file-code me-1" viewBox="0 0 16 16">
                        <path
                            d="M14.5 14a1.5 1.5 0 0 1-1.5 1.5H3A1.5 1.5 0 0 1 1.5 14V2A1.5 1.5 0 0 1 3 0.5H13A1.5 1.5 0 0 1 14.5 2zm-1.5.5a.5.5 0 0 0 .5-.5V2a.5.5 0 0 0-.5-.5H3a.5.5 0 0 0-.5.5v12a.5.5 0 0 0 .5.5z" />
                        <path
                            d="M6.854 4.646a.5.5 0 0 1 0 .708L4.207 8l2.647 2.646a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 0 1 .708 0m2.292 0a.5.5 0 0 0 0 .708L11.793 8l-2.647 2.646a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708 0" />
                    </svg> Exportar JSON </button>
                <button id="importDataBtn" class="btn btn-sm"
                    style="background-color: #96a5c0; border-color: #96a5c0; color: black;"> <svg class="bi me-1"
                        width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M3.5 10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m4.5-3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m0 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5" />
                        <path d="M4 1a1 1 0 0 0-1 1v1h1V2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 .5.5v1h1V2a1 1 0 0 0-1-1z" />
                        <path
                            d="M4 5.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5M4 7.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m1 4v1H4v-1zm4 0v1H8v-1zm4 0v1h-1v-1z" />
                        <path fill-rule="evenodd"
                            d="M1.5 3A1.5 1.5 0 0 0 0 4.5v7A1.5 1.5 0 0 0 1.5 13h13a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 14.5 3zm13 1a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .5-.5z" />
                    </svg> Importar JSON </button>
                <input type="file" id="fileInput" accept=".txt, .json" style="display: none;" />
            </div>

            <!-- Calendario (Unchanged) -->
            <div class="calendar" id="calendar">
                <div class="text-center w-100" style="grid-column: 1 / -1; padding: 20px;">Cargando calendario...</div>
            </div>
        </div>
    </div>

    <!-- Modal (Unchanged) -->
    <div class="modal fade" id="reservaModal" tabindex="-1" aria-labelledby="reservaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #c0d5c1; border-color: #c0d5c1; color: black;">
                    <h5 class="modal-title" id="reservaModalLabel">Detalles Clase</h5><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="reservaForm" novalidate>
                        <input type="hidden" id="reservaDia" />
                        <input type="hidden" id="reservaHora" />
                        <div class="row g-3">
                            <div class="col-md-6 mb-3"> <label for="horaInicio" class="form-label">Inicio</label> <input
                                    type="time" class="form-control bg-light" id="horaInicio" readonly /> </div>
                            <div class="col-md-6 mb-3"> <label for="horaFin" class="form-label">Fin</label> <input
                                    type="time" class="form-control bg-light" id="horaFin" readonly /> </div>
                            <div class="col-12 mb-3"> <label for="nombre" class="form-label">Nombre
                                    (Principal/Grupo)</label> <input type="text" id="nombre" class="form-control"
                                    required />
                                <div class="invalid-feedback">Ingresa un nombre principal o de grupo.</div>
                            </div>
                            <div class="col-md-6 mb-3"> <label for="tipo" class="form-label">Tipo</label> <select
                                    id="tipo" class="form-select" required>
                                    <option>Individual</option>
                                    <option>Grupal</option>
                                    <option>Ayuda Ingreso a institutos</option>
                                    <option>Clase de prueba</option>
                                    <option>Clase de recuperaci√≥n</option>
                                </select>
                                <div class="invalid-feedback">Selecciona un tipo.</div>
                            </div>
                            <div class="col-md-6 mb-3"> <label for="duracion" class="form-label">Duraci√≥n</label>
                                <select id="duracion" class="form-select" required>
                                    <option value="40">40 min</option>
                                    <option value="60">1 hora</option>
                                </select>
                                <div class="invalid-feedback">Selecciona duraci√≥n.</div>
                            </div>
                            <div class="col-12 mb-3" id="emailGroup"> <label for="email"
                                    class="form-label">Email</label> <input type="email" id="email" class="form-control"
                                    placeholder="ejemplo@correo.com" />
                                <div class="invalid-feedback">Ingresa un email v√°lido.</div>
                            </div>
                            <div class="col-12 mb-3" id="fechaEspecificaGroup" style="display: none;"> <label
                                    for="fechaEspecifica" class="form-label">Fecha Espec√≠fica</label> <input type="date"
                                    id="fechaEspecifica" class="form-control" />
                                <div class="invalid-feedback">Ingresa una fecha para este tipo de clase.</div>
                            </div>
                            <div class="col-12 mb-3" id="grupalParticipantsGroup" style="display: none;">
                                <h6>Participantes (Clase Grupal)</h6>
                                <div id="participantsListContainer"></div> <button type="button"
                                    class="btn btn-sm btn-outline-success mt-2" id="addParticipantBtn"> <svg
                                        xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                        class="bi bi-plus-circle me-1" viewBox="0 0 16 16">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                                        <path
                                            d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4" />
                                    </svg> A√±adir Participante </button>
                                <div class="invalid-feedback" id="grupalParticipantsFeedback">Debes a√±adir al menos un
                                    participante con nombre y email para la clase grupal.</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn me-auto" style="background-color: #f3a391;" id="eliminarBtn"
                        style="display: none;"> <svg class="bi me-1" width="16" height="16" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path
                                d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z" />
                            <path
                                d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z" />
                        </svg> Eliminar </button>
                    <button type="button" class="btn"
                        style="background-color: #fae39e; border-color: #fae39e; color: black;"
                        data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn"
                        style="background-color: #d9e6cc; border-color: #d9e6cc; color: black;" id="guardarBtn"> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√≥n Back to Top (Unchanged) -->
    <button id="backToTopBtn" title="Volver arriba"
        style="background-color: #5b7d2b; border-color: #5b7d2b; color: black;"> <svg xmlns="http://www.w3.org/2000/svg"
            width="24" height="24" fill="currentColor" class="bi bi-arrow-up-short" viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M8 12a.5.5 0 0 0 .5-.5V5.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 5.707V11.5a.5.5 0 0 0 .5.5" />
        </svg> </button>

    <!-- Scripts JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // --- Handlers Carga XLSX (Unchanged) ---
        function xlsxScriptLoaded() { console.log("XLSX loaded."); const e = document.getElementById("exportExcelBtn"); e && (e.disabled = !1) } function xlsxScriptFailed() { console.error("Failed to load XLSX library."); const e = document.getElementById("exportExcelBtn"); e && (e.disabled = !0, e.title = "Error al cargar librer√≠a Excel", e.classList.add("btn-danger"), e.innerHTML = '<svg class="bi me-1" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z"/></svg> Error Excel'), Swal.fire("Error Cr√≠tico", "No se pudo cargar la librer√≠a necesaria para exportar a Excel. Por favor, revisa tu conexi√≥n a internet y recarga la p√°gina.", "error") }

        // --- Inicializaci√≥n EmailJS (Unchanged) ---
        !function () { emailjs.init({ publicKey: "qOfrwmjiPJNVT91sk" }) }();

        // --- Variables Globales y DOM Elements (Unchanged) ---
        const calendar = document.getElementById("calendar"), downloadImageBtn = document.getElementById("downloadImageBtn"), downloadPdfBtn = document.getElementById("downloadPdfBtn"), exportDataBtn = document.getElementById("exportDataBtn"), importDataBtn = document.getElementById("importDataBtn"), exportExcelBtn = document.getElementById("exportExcelBtn"), fileInput = document.getElementById("fileInput"), reservaModalElement = document.getElementById("reservaModal"), reservaForm = document.getElementById("reservaForm"), eliminarBtn = document.getElementById("eliminarBtn"), guardarBtn = document.getElementById("guardarBtn"), duracionSelect = document.getElementById("duracion"), tipoSelect = document.getElementById("tipo"), fechaEspecificaGroup = document.getElementById("fechaEspecificaGroup"), fechaEspecificaInput = document.getElementById("fechaEspecifica"), emailGroup = document.getElementById("emailGroup"), emailInput = document.getElementById("email"), grupalParticipantsGroup = document.getElementById("grupalParticipantsGroup"), participantsListContainer = document.getElementById("participantsListContainer"), addParticipantBtn = document.getElementById("addParticipantBtn"), grupalParticipantsFeedback = document.getElementById("grupalParticipantsFeedback"), days = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes"], startHour = 900, endHour = 1260, hours = [], generationIntervalMinutes = 20; for (let e = startHour; e < endHour; e += generationIntervalMinutes)hours.push(e); const localKey = "reservasCalendarioV2_1"; let reservas = {};

        // --- Funciones Utilitarias (Unchanged) ---
        function formatHora(e) { const t = Math.floor(e / 60).toString().padStart(2, "0"), o = (e % 60).toString().padStart(2, "0"); return `${t}:${o}` }
        function getTipoClass(e) { const t = String(e || "").toLowerCase().replace(/\s+/g, "-").replace(/[^a-z0-9-]/g, ""); switch (t) { case "individual": return "tipo-individual"; case "grupal": return "tipo-grupal"; case "ayuda-ingreso-a-institutos": return "tipo-ayuda-ingreso-a-institutos"; case "clase-de-prueba": return "tipo-clase-de-prueba"; case "clase-de-recuperacion": return "tipo-clase-de-recuperacion"; default: return console.warn(`Tipo desconocido normalizado: "${t}". Usando default.`), "tipo-default" } }

        // --- Guardar/Cargar LocalStorage (Unchanged) ---
        function guardarReservasEnLocalStorage() { try { localStorage.setItem(localKey, JSON.stringify(reservas)), console.log("Reservas guardadas.") } catch (e) { console.error("Error guardando:", e), Swal.fire("Error", "No se pudieron guardar.", "error") } }
        function cargarReservasDesdeLocalStorage() { calendar.innerHTML = '<div class="text-center w-100" style="grid-column: 1 / -1; padding: 20px;">Cargando...</div>'; try { const e = localStorage.getItem(localKey); reservas = e ? JSON.parse(e) : {}, console.log("Reservas cargadas.") } catch (e) { console.error("Error cargando:", e), reservas = {}, Swal.fire("Error", "Datos corruptos.", "warning") } requestAnimationFrame(() => setTimeout(renderCalendar, 0)) }

        // --- Renderizado del Calendario (Unchanged) ---
        function renderCalendar() { calendar.innerHTML = ""; days.forEach(e => { const t = document.createElement("div"); t.className = "day", t.innerHTML = `<h5>${e}</h5>`, hours.forEach(o => { const n = formatHora(o), a = `${e}-${n}`, r = reservas[a]; if (r) { const s = document.createElement("div"), i = r.tipo, l = getTipoClass(i); s.classList.add("hour", "reserved", l); let c = `<strong>${r.nombre}</strong><br>${r.horaInicio} - ${r.horaFin} (${r.duracion} min)<br><small>${r.tipo}</small>`; r.fechaEspecifica && (c += `<br><small class="specific-date">Fecha: ${r.fechaEspecifica}</small>`), "Grupal" === r.tipo ? c += `<br><small class="participant-info">Grupo (${Array.isArray(r.participantes) ? r.participantes.length : 0} part.)</small>` : r.email && (c += `<br><small class="participant-info">${r.email}</small>`), s.innerHTML = c, s.onclick = () => abrirModal(e, n, r), t.appendChild(s) } else if (!estaEnReserva(e, o) && canFitReservation(e, o, 40)) { const s = document.createElement("div"); s.className = "hour", s.textContent = n, s.onclick = () => abrirModal(e, n, null), t.appendChild(s) } }), calendar.appendChild(t) }) }

        // --- Chequeo de Ocupaci√≥n y Capacidad (Unchanged) ---
        function estaEnReserva(e, t) { for (const o in reservas) { const n = reservas[o]; if (!o || "string" != typeof o || -1 === o.indexOf("-")) continue; const a = o.split("-"); if (a.length < 2) continue; const r = a.slice(0, -1).join("-"); if (r !== e || !n || "object" != typeof n || !n.horaInicio || "string" != typeof n.horaInicio || "number" != typeof n.duracion || isNaN(n.duracion)) continue; const s = n.horaInicio.split(":"); if (2 !== s.length) continue; const i = parseInt(s[0], 10), l = parseInt(s[1], 10); if (isNaN(i) || isNaN(l)) continue; const c = 60 * i + l, d = c + n.duracion; if (t >= c && t < d) return !0 } return !1 }
        function canFitReservation(e, t, o) { const n = t + o; if (n > endHour) return !1; for (const a in reservas) { const r = reservas[a]; if (!a || "string" != typeof a || -1 === a.indexOf("-")) continue; const s = a.split("-"); if (s.length < 2) continue; const i = s.slice(0, -1).join("-"); if (i !== e || !r || "object" != typeof r || !r.horaInicio || "string" != typeof r.horaInicio || "number" != typeof r.duracion || isNaN(r.duracion)) continue; const l = r.horaInicio.split(":"); if (2 !== l.length) continue; const c = parseInt(l[0], 10), d = parseInt(l[1], 10); if (isNaN(c) || isNaN(d)) continue; const u = 60 * c + d, h = u + r.duracion; if (t < h && n > u) return !1 } return !0 }

        // --- L√≥gica del Modal (Unchanged) ---
        function actualizarHoraFin() { const e = document.getElementById("horaInicio").value, t = parseInt(duracionSelect.value); if (!e || isNaN(t) || t <= 0) return document.getElementById("horaFin").value = "", void (guardarBtn.disabled = !0); const [o, n] = e.split(":").map(Number), a = 60 * o + n, r = a + t; r > endHour ? (document.getElementById("horaFin").value = formatHora(endHour), guardarBtn.disabled = !0, Swal.fire({ icon: "warning", title: "Hora Inv√°lida", text: `Termina despu√©s de ${formatHora(endHour)}.`, timer: 3e3, showConfirmButton: !1 })) : (document.getElementById("horaFin").value = formatHora(r), guardarBtn.disabled = !1) }
        function addParticipantRow(e = "", t = "") { const o = document.createElement("div"); o.className = "participant-row mb-2", o.innerHTML = `\n                <div class="form-group flex-grow-1">\n                    <input type="text" class="form-control form-control-sm grupal-name" placeholder="Nombre participante" value="${e}" required>\n                     <div class="invalid-feedback">Nombre requerido.</div>\n                </div>\n                <div class="form-group flex-grow-1">\n                    <input type="email" class="form-control form-control-sm grupal-email" placeholder="Email participante" value="${t}" required>\n                    <div class="invalid-feedback">Email v√°lido requerido.</div>\n                </div>\n                <button type="button" class="btn btn-danger btn-sm btn-remove-participant" title="Eliminar participante">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">\n                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>\n                        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>\n                    </svg>\n                </button>\n            `, o.querySelector(".btn-remove-participant").addEventListener("click", e => { e.target.closest(".participant-row").remove(), updateModalFieldsVisibility() }), participantsListContainer.appendChild(o) }
        function updateModalFieldsVisibility() { const e = tipoSelect.value, t = "Clase de prueba" === e || "Clase de recuperaci√≥n" === e, o = "Grupal" === e; emailInput.required = !1, fechaEspecificaInput.required = !1, grupalParticipantsGroup.classList.remove("is-invalid"), participantsListContainer.querySelectorAll(".grupal-name, .grupal-email").forEach(e => e.required = !1), emailGroup.style.display = o ? "none" : "block", emailInput.required = !o, fechaEspecificaGroup.style.display = t ? "block" : "none", fechaEspecificaInput.required = t, grupalParticipantsGroup.style.display = o ? "block" : "none", o ? (0 === participantsListContainer.children.length && addParticipantRow(), participantsListContainer.querySelectorAll(".grupal-name, .grupal-email").forEach(e => e.required = !0)) : participantsListContainer.querySelectorAll(".grupal-name, .grupal-email").forEach(e => e.required = !1) }
        function abrirModal(e, t, o) { reservaForm.classList.remove("was-validated"), document.getElementById("reservaDia").value = e, document.getElementById("reservaHora").value = t, document.getElementById("horaInicio").value = o?.horaInicio || t, document.getElementById("nombre").value = o?.nombre || "", tipoSelect.value = o?.tipo || "Individual", duracionSelect.value = o?.duracion || 40, fechaEspecificaInput.value = o?.fechaEspecifica || "", emailInput.value = "", participantsListContainer.innerHTML = "", o ? "Grupal" === o.tipo && Array.isArray(o.participantes) ? (o.participantes.forEach(e => addParticipantRow(e.nombre, e.email)), 0 === participantsListContainer.children.length && addParticipantRow()) : o.email && (emailInput.value = o.email) : "Grupal" === tipoSelect.value && addParticipantRow(), updateModalFieldsVisibility(), actualizarHoraFin(), eliminarBtn.style.display = o ? "inline-block" : "none"; const n = new bootstrap.Modal(reservaModalElement); n.show() }
        duracionSelect.addEventListener("change", actualizarHoraFin); tipoSelect.addEventListener("change", updateModalFieldsVisibility); addParticipantBtn.addEventListener("click", () => addParticipantRow());

        // --- Env√≠o de Correo (Modificado para formato participant_details) ---
        function enviarCorreoReserva(e) {
            const t = "service_93zs6up", o = "template_352le9n";
            let dayValueToSend;
            if (("Clase de prueba" === e.tipo || "Clase de recuperaci√≥n" === e.tipo) && e.fechaEspecifica) {
                dayValueToSend = e.dia + " (" + e.fechaEspecifica + ")";
            } else {
                dayValueToSend = e.dia;
            }

            // +++ Construcci√≥n de participant_details MODIFICADA (Solo nombres en lista HTML para grupal) +++
            let participantDetailsText = "";
            if (e.tipo === "Grupal" && Array.isArray(e.participantes) && e.participantes.length > 0) {
                participantDetailsText = "Lista de participantes: <ul>";
                e.participantes.forEach(p => {
                    const name = p.nombre ? p.nombre.trim() : '';
                    if (name) {
                        participantDetailsText += `<li>${name}</li>`;
                    } else {
                        participantDetailsText += `<li>(Nombre no registrado)</li>`;
                    }
                });
                participantDetailsText += "</ul>";
            }
            // +++ Fin de la modificaci√≥n +++

            const n = {
                day: dayValueToSend,
                horaInicio: e.horaInicio,
                horaFin: e.horaFin,
                name: e.nombre,
                type: e.tipo,
                duration: e.duracion,
                participant_details: participantDetailsText, // Lista HTML o vac√≠o
                ac1: e.ac1,
                ac2: e.ac2
            };

            console.log("Enviando correo con payload:", n);
            emailjs.send(t, o, n).then(response => {
                console.log("√âxito!", response.status, response.text);
                const toast = Swal.mixin({ toast: !0, position: "top-end", showConfirmButton: !1, timer: 2500, timerProgressBar: !0, didOpen: e => { e.onmouseenter = Swal.stopTimer, e.onmouseleave = Swal.resumeTimer } });
                toast.fire({ icon: "info", title: "Notificaci√≥n enviada por correo." })
            }).catch(err => {
                console.error("Error correo:", err);
                Swal.fire({ title: "Error Notificaci√≥n", text: `Reserva guardada, pero hubo un error al enviar el correo: ${err.text || "Desconocido"}`, icon: "warning", timer: 5000, showConfirmButton: !0 })
            })
        }

        // +++ NUEVAS FUNCIONES PARA GENERAR Y DESCARGAR .ICS +++

        /**
         * Calcula la pr√≥xima fecha para un d√≠a de la semana dado a una hora espec√≠fica.
         * @param {string} nombreDia Ej: "Lunes", "Martes"...
         * @param {string} horaMinutosStr Ej: "15:00"
         * @returns {Date|null} Objeto Date de la pr√≥xima ocurrencia o null si hay error.
         */
        function getProximaFechaParaDia(nombreDia, horaMinutosStr) {
            const mapDias = { "Lunes": 1, "Martes": 2, "Mi√©rcoles": 3, "Jueves": 4, "Viernes": 5, "S√°bado": 6, "Domingo": 0 };
            const diaSemanaTarget = mapDias[nombreDia];

            if (typeof diaSemanaTarget === 'undefined') {
                console.error("Nombre de d√≠a inv√°lido:", nombreDia);
                return null;
            }

            const [horas, minutos] = horaMinutosStr.split(':').map(Number);
            if (isNaN(horas) || isNaN(minutos)) {
                console.error("Formato de hora inv√°lido:", horaMinutosStr);
                return null;
            }

            const hoy = new Date();
            const diaSemanaHoy = hoy.getDay(); // 0 = Domingo, 1 = Lunes...
            let diasHastaProximo = (diaSemanaTarget - diaSemanaHoy + 7) % 7;

            const proximaFecha = new Date(hoy);
            proximaFecha.setDate(hoy.getDate() + diasHastaProximo);
            proximaFecha.setHours(horas, minutos, 0, 0); // Establecer hora y minutos

            // Si el d√≠a calculado es hoy pero la hora ya pas√≥, calcular para la semana siguiente
            if (diasHastaProximo === 0 && proximaFecha < hoy) {
                proximaFecha.setDate(proximaFecha.getDate() + 7);
            }

            return proximaFecha;
        }

        /**
        * Parsea una fecha espec√≠fica (YYYY-MM-DD) y hora (HH:MM) a un objeto Date local.
        * @param {string} fechaStr Ej: "2024-08-15"
        * @param {string} horaStr Ej: "10:30"
        * @returns {Date|null} Objeto Date o null si el formato es inv√°lido.
        */
        function parsearFechaEspecifica(fechaStr, horaStr) {
            if (!fechaStr || !horaStr) return null;
            try {
                // Construye una cadena ISO 8601 parcial y la parsea.
                // new Date() con esta cadena generalmente asume la zona horaria local.
                const fechaHoraCompleta = `${fechaStr}T${horaStr}:00`;
                const fecha = new Date(fechaHoraCompleta);
                // Verifica si la fecha resultante es v√°lida
                if (isNaN(fecha.getTime())) {
                    throw new Error("Fecha inv√°lida generada");
                }
                return fecha;
            } catch (error) {
                console.error("Error parseando fecha espec√≠fica:", fechaStr, horaStr, error);
                return null;
            }
        }


        /**
         * Formatea un objeto Date al formato UTC YYYYMMDDTHHMMSSZ para iCalendar.
         * @param {Date} fecha
         * @returns {string} Fecha formateada.
         */
        function formatoFechaICS(fecha) {
            if (!(fecha instanceof Date) || isNaN(fecha)) {
                console.error("formatoFechaICS recibi√≥ una fecha inv√°lida:", fecha);
                // Devolver una fecha/hora por defecto o lanzar un error m√°s expl√≠cito
                return "20000101T000000Z"; // Placeholder
            }
            const pad = (num) => (num < 10 ? '0' : '') + num;
            return fecha.getUTCFullYear() +
                pad(fecha.getUTCMonth() + 1) +
                pad(fecha.getUTCDate()) + 'T' +
                pad(fecha.getUTCHours()) +
                pad(fecha.getUTCMinutes()) +
                pad(fecha.getUTCSeconds()) + 'Z';
        }

        /**
         * Genera el contenido de un archivo .ics para una reserva.
         * @param {object} reservaCompleta Objeto con detalles: { dia, nombre, tipo, duracion, horaInicio, horaFin, fechaEspecifica?, participantes?, email? }
         * @returns {string|null} Contenido del archivo .ics o null si hay error.
         */
        function generarICS(reservaCompleta) {
            try {
                let fechaInicio, fechaFin;

                // Determinar fecha de inicio
                if (reservaCompleta.fechaEspecifica) {
                    fechaInicio = parsearFechaEspecifica(reservaCompleta.fechaEspecifica, reservaCompleta.horaInicio);
                } else {
                    fechaInicio = getProximaFechaParaDia(reservaCompleta.dia, reservaCompleta.horaInicio);
                }

                if (!fechaInicio || isNaN(fechaInicio)) {
                    throw new Error("No se pudo determinar la fecha de inicio v√°lida.");
                }

                // Calcular fecha de fin
                fechaFin = new Date(fechaInicio.getTime() + reservaCompleta.duracion * 60000); // duracion en minutos

                if (isNaN(fechaFin)) {
                    throw new Error("No se pudo calcular la fecha de fin v√°lida.");
                }

                const ahoraUTC = formatoFechaICS(new Date());
                const inicioUTC = formatoFechaICS(fechaInicio);
                const finUTC = formatoFechaICS(fechaFin);
                // UID √∫nico para el evento (simple basado en timestamp)
                const uid = `reserva-${Date.now()}@mi-calendario.com`; // Cambia el dominio si quieres

                const resumen = `Clase ${reservaCompleta.tipo} - ${reservaCompleta.nombre}`;
                // Descripci√≥n opcional con m√°s detalles
                let descripcion = `Detalles de la clase:\\nTipo: ${reservaCompleta.tipo}\\nDuraci√≥n: ${reservaCompleta.duracion} min`;
                if (reservaCompleta.tipo === 'Grupal' && Array.isArray(reservaCompleta.participantes)) {
                    descripcion += '\\nParticipantes: ' + reservaCompleta.participantes.map(p => p.nombre).join(', ');
                } else if (reservaCompleta.email) {
                    descripcion += '\\nEmail contacto: ' + reservaCompleta.email;
                }

                // Construir el contenido ICS
                const contenidoICS = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'PRODID:-//MiAppDeReservas//Calendario//ES', // Identificador de tu aplicaci√≥n
                    'BEGIN:VEVENT',
                    `UID:${uid}`,
                    `DTSTAMP:${ahoraUTC}`,
                    `DTSTART:${inicioUTC}`,
                    `DTEND:${finUTC}`,
                    `SUMMARY:${resumen}`,
                    `DESCRIPTION:${descripcion.replace(/\n/g, '\\n')}`, // Escapar saltos de l√≠nea para ICS
                    // Alarma 2 horas antes
                    'BEGIN:VALARM',
                    'ACTION:DISPLAY',
                    `DESCRIPTION:Recordatorio: ${resumen}`,
                    'TRIGGER:-PT2H', // P=Period, T=Time, 2H=2 Hours (antes del DTSTART)
                    'END:VALARM',
                    'END:VEVENT',
                    'END:VCALENDAR'
                ].join('\r\n'); // ICS usa CRLF para saltos de l√≠nea

                return contenidoICS;

            } catch (error) {
                console.error("Error generando ICS:", error, reservaCompleta);
                Swal.fire("Error", `No se pudo generar el archivo de calendario (.ics): ${error.message}`, "error");
                return null;
            }
        }

        /**
         * Inicia la descarga de un archivo de texto.
         * @param {string} nombreArchivo Nombre del archivo a descargar (ej. "evento.ics").
         * @param {string} contenido Contenido del archivo.
         */
        function descargarArchivo(nombreArchivo, contenido) {
            if (!contenido) {
                console.error("Contenido vac√≠o para descargar.");
                return;
            }
            const blob = new Blob([contenido], { type: 'text/calendar;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nombreArchivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        // +++ FIN NUEVAS FUNCIONES ICS +++


        // --- Guardar Reserva (Modificado para ofrecer descarga .ics) ---
        guardarBtn.onclick = () => {
            updateModalFieldsVisibility();

            let grupalValid = true;
            if (tipoSelect.value === "Grupal") {
                const participantRows = participantsListContainer.querySelectorAll('.participant-row');
                if (participantRows.length === 0) {
                    grupalValid = false;
                } else {
                    participantRows.forEach(row => {
                        const nameInput = row.querySelector('.grupal-name');
                        const emailInput = row.querySelector('.grupal-email');
                        if (!nameInput.checkValidity() || !emailInput.checkValidity()) {
                            grupalValid = false;
                        }
                    });
                }
                if (!grupalValid) {
                    grupalParticipantsGroup.classList.add('is-invalid');
                    reservaForm.classList.add("was-validated");
                    return;
                } else {
                    grupalParticipantsGroup.classList.remove('is-invalid');
                }
            }

            if (!reservaForm.checkValidity()) {
                reservaForm.classList.add("was-validated");
                return;
            }

            const e = document.getElementById("reservaDia").value, // dia
                t = document.getElementById("horaInicio").value, // horaInicioStr
                o = document.getElementById("nombre").value.trim(), // nombre principal/grupo
                n = tipoSelect.value, // tipo
                a = parseInt(duracionSelect.value), // duracionInt
                fechaEspecifica = fechaEspecificaInput.value; // fecha

            if (isNaN(a) || a <= 0) { Swal.fire("Error", "Duraci√≥n inv√°lida.", "error"); return; }

            const [r, s] = t.split(":").map(Number), i = 60 * r + s, l = i + a;
            if (l > endHour) { Swal.fire("Error", `Termina despu√©s de ${formatHora(endHour)}.`, "error"); return; }
            const c = formatHora(l), // horaFinStr
                d = `${e}-${t}`; // key

            // Conflicto (sin cambios)
            let u = !1, h = null; for (const g in reservas) { if (g === d) continue; const f = reservas[g]; if (!g || g.indexOf("-") === -1) continue; const m = g.split("-"); if (m.length < 2) continue; const p = m.slice(0, -1).join("-"); if (p !== e || !f || !f.horaInicio || !f.duracion || isNaN(f.duracion)) continue; const w = f.horaInicio.split(":"); if (w.length !== 2) continue; const E = parseInt(w[0], 10), I = parseInt(w[1], 10); if (isNaN(E) || isNaN(I)) continue; const L = 60 * E + I, S = L + f.duracion; if (i < S && l > L) { u = !0, h = f; break } } if (u) return Swal.fire("Conflicto", `Se solapa con "${h.nombre}" (${h.horaInicio}-${h.horaFin}).`, "error"), void 0;

            const b = eliminarBtn.style.display !== "none"; // Es edici√≥n?

            const v = () => { // Funci√≥n de guardado
                let ac1, ac2; b ? (ac1 = "modificaste la reserva a nombre de", ac2 = ", con las siguientes caracter√≠sticas:") : (ac1 = "Te recuerdo que registraste una reserva a nombre de", ac2 = ", con las siguientes caracter√≠sticas:");

                // Crear reservaData (sin cambios)
                const reservaData = {
                    nombre: o, tipo: n, duracion: a, horaInicio: t, horaFin: c,
                    ...(fechaEspecifica && { fechaEspecifica: fechaEspecifica })
                };
                if (n === "Grupal") {
                    reservaData.participantes = [];
                    participantsListContainer.querySelectorAll('.participant-row').forEach(row => {
                        const nameVal = row.querySelector('.grupal-name').value.trim();
                        const emailVal = row.querySelector('.grupal-email').value.trim();
                        if (nameVal && emailVal) {
                            reservaData.participantes.push({ nombre: nameVal, email: emailVal });
                        }
                    });
                } else {
                    reservaData.email = emailInput.value.trim() || null;
                }

                // Guardar en local storage (sin cambios)
                const originalHoraStr = document.getElementById("reservaHora").value, originalKey = `${e}-${originalHoraStr}`;
                if (b && d !== originalKey && reservas[originalKey]) { delete reservas[originalKey]; }
                reservas[d] = reservaData;
                guardarReservasEnLocalStorage();

                // Preparar y enviar correo (sin cambios)
                const emailDetails = { ...reservaData, dia: e, ac1: ac1, ac2: ac2 };
                enviarCorreoReserva(emailDetails);

                // UI update (sin cambios)
                const modalInstance = bootstrap.Modal.getInstance(reservaModalElement); if (modalInstance) modalInstance.hide();
                renderCalendar();

                // +++ Mostrar SweetAlert de √©xito Y PREGUNTAR por .ics +++
                Swal.fire({
                    icon: "success",
                    title: "¬°Guardado!",
                    text: `Reserva para ${o} guardada correctamente.`,
                    showConfirmButton: true, // Bot√≥n OK
                    confirmButtonText: 'Ok',
                    showDenyButton: true, // Bot√≥n para .ics
                    denyButtonText: '<i class="bi bi-calendar-plus"></i> A√±adir al Calendario', // Texto para el bot√≥n .ics
                    denyButtonColor: '#5a7d2a' // Color verde para el bot√≥n .ics
                }).then((result) => {
                    if (result.isDenied) { // Si el usuario hizo clic en "A√±adir al Calendario"
                        // Crear objeto completo para la funci√≥n ICS (necesita el d√≠a)
                        const reservaParaICS = { ...reservaData, dia: e };
                        const contenidoICS = generarICS(reservaParaICS);
                        if (contenidoICS) {
                            const nombreArchivo = `clase_${reservaData.tipo}_${reservaData.nombre.replace(/\s+/g, '_')}_${d.replace(':', '_')}.ics`
                                .replace(/[^a-z0-9_.-]/gi, ''); // Limpiar nombre archivo
                            descargarArchivo(nombreArchivo, contenidoICS);
                        }
                        // No se necesita un mensaje extra aqu√≠, el navegador iniciar√° la descarga.
                    }
                    // Si hace clic en OK (result.isConfirmed) o cierra el di√°logo, no hacemos nada m√°s.
                });
                // +++ Fin Modificaci√≥n SweetAlert +++
            };

            // Confirmar edici√≥n (sin cambios)
            b ? Swal.fire({ title: "Confirmar", text: `Guardar cambios para "${o}"?`, icon: "question", showCancelButton: !0, confirmButtonColor: "#d9e6cc", cancelButtonColor: "#f3a391", confirmButtonText: "S√≠", cancelButtonText: "No" }).then(result => { result.isConfirmed && v() }) : v();
        };


        // --- Eliminar Reserva (Unchanged) ---
        eliminarBtn.onclick = () => { const e = document.getElementById("reservaDia").value, t = document.getElementById("horaInicio").value, o = `${e}-${t}`; reservas[o] ? Swal.fire({ title: "¬øSeguro?", text: `Eliminar reserva de "${reservas[o]?.nombre || "clase"}". ¬°Irreversible!`, icon: "warning", showCancelButton: !0, confirmButtonColor: "#d33", cancelButtonColor: "#aaa", confirmButtonText: "S√≠, eliminarla", cancelButtonText: "No" }).then(e => { if (e.isConfirmed) if (reservas[o]) { delete reservas[o], guardarReservasEnLocalStorage(); const t = bootstrap.Modal.getInstance(document.getElementById("reservaModal")); t && t.hide(), renderCalendar(), Swal.fire("¬°Eliminado!", "Reserva eliminada.", "success") } else Swal.fire("Error", "No se pudo eliminar.", "error"), renderCalendar() }) : Swal.fire("Error", "Reserva no encontrada.", "error") };

        // --- L√≥gica Botones Exportaci√≥n (Loading/Restore State - Unchanged) ---
        function setExportButtonLoading(e) { const t = [downloadImageBtn, downloadPdfBtn, exportExcelBtn, exportDataBtn, importDataBtn]; t.forEach(t => { if (t) { t.dataset.originalHtml || (t.dataset.originalHtml = t.innerHTML); const o = "exportExcelBtn" === t.id, n = "undefined" != typeof window.XLSX; t.disabled = e || o && !n, e ? o && !n || (t.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Proc...') : (t.innerHTML = t.dataset.originalHtml, o && !n && xlsxScriptFailed()) } }), !e && exportExcelBtn && "undefined" != typeof window.XLSX && (exportExcelBtn.disabled = !1) }

        // --- Captura de Calendario (Unchanged) ---
        async function captureCalendar(e = {}) { try { const t = document.getElementById("calendarContainer"), o = t.style.paddingBottom; t.style.paddingBottom = "30px"; const n = 1400, a = await html2canvas(t, { scale: 2, useCORS: !0, logging: !1, allowTaint: !0, backgroundColor: "#ffffff", width: n, windowWidth: n, ignoreElements: e => e.classList.contains("action-buttons") || "BUTTON" === e.tagName || "INPUT" === e.tagName, ...e }); return t.style.paddingBottom = o, a } catch (t) { console.error("Error during html2canvas capture:", t); const o = document.getElementById("calendarContainer"); if (o && "undefined" != typeof originalPaddingBottom) o.style.paddingBottom = originalPaddingBottom; throw t } }

        // --- Exportar Imagen/PDF (Unchanged) ---
        downloadImageBtn.addEventListener("click", async () => { setExportButtonLoading(!0), await new Promise(e => setTimeout(e, 100)); try { const e = await captureCalendar(), t = e.toDataURL("image/png"), o = document.createElement("a"); o.href = t, o.download = "calendario-reservas.png", document.body.appendChild(o), o.click(), document.body.removeChild(o), Swal.fire({ icon: "success", title: "Imagen OK", showConfirmButton: !1, timer: 1500 }) } catch (e) { console.error("Err IMG:", e), Swal.fire("Error", "No se gener√≥ imagen.", "error") } finally { setExportButtonLoading(!1) } });
        downloadPdfBtn.addEventListener("click", async () => { setExportButtonLoading(!0), await new Promise(e => setTimeout(e, 100)); if ("undefined" == typeof window.jspdf || "undefined" == typeof window.jspdf.jsPDF) return console.error("jsPDF no cargado"), Swal.fire("Error", "Librer√≠a PDF no cargada.", "error"), void setExportButtonLoading(!1); const { jsPDF: e } = window.jspdf; try { const t = await captureCalendar(), o = t.toDataURL("image/jpeg", .92), n = { width: t.width, height: t.height }, a = 595.28, r = n.height * a / n.width, s = a > r ? "l" : "p", i = new e({ orientation: s, unit: "pt", format: "a4" }); i.addImage(o, "JPEG", 0, 0, a, r), i.save("calendario-reservas.pdf"), Swal.fire({ icon: "success", title: "PDF OK", showConfirmButton: !1, timer: 1500 }) } catch (e) { console.error("Err PDF:", e), Swal.fire("Error", `No se gener√≥ PDF. ${e.message || ""}`, "error") } finally { setExportButtonLoading(!1) } });

        // --- Exportar JSON (Unchanged) ---
        exportDataBtn.addEventListener("click", () => { if (0 === Object.keys(reservas).length) return Swal.fire("Vac√≠o", "No hay reservas.", "info"), void 0; try { const e = JSON.stringify(reservas, null, 2), t = new Blob([e], { type: "application/json;charset=utf-8" }), o = URL.createObjectURL(t), n = document.createElement("a"); n.href = o, n.download = `reservas_${(new Date).toISOString().split("T")[0]}.json`, document.body.appendChild(n), n.click(), document.body.removeChild(n), URL.revokeObjectURL(o), Swal.fire("Exportado", "Datos JSON guardados.", "success") } catch (e) { console.error("Err Exp:", e), Swal.fire("Error", "No se exportaron datos.", "error") } });

        // --- Exportar Excel (Unchanged) ---
        function exportarExcel() { if ("undefined" == typeof window.XLSX) return console.error("XLSX library not loaded!"), void Swal.fire("Error", "La librer√≠a necesaria para exportar a Excel no est√° cargada.", "error"); if (0 === Object.keys(reservas).length) return void Swal.fire("Vac√≠o", "No hay reservas para exportar.", "info"); setExportButtonLoading(!0); try { const e = [], t = ["D√≠a", "Inicio", "Fin", "Nombre Principal/Grupo", "Tipo", "Duraci√≥n (min)", "Email(s) / Participantes"]; e.push(t); const o = Object.keys(reservas).sort((e, t) => { const [o, n] = e.split("-"), [a, r] = t.split("-"), s = days.indexOf(o), i = days.indexOf(a); return s !== i ? s - i : n.localeCompare(r) }); o.forEach(t => { const o = reservas[t], n = t.substring(0, t.lastIndexOf("-")); let a; "Clase de prueba" !== o.tipo && "Clase de recuperaci√≥n" !== o.tipo || !o.fechaEspecifica ? a = n : a = n + " (" + o.fechaEspecifica + ")"; let r = ""; "Grupal" === o.tipo && Array.isArray(o.participantes) ? r = o.participantes.map(e => `${e.nombre || "?"} (${e.email || "sin email"})`).join("; ") : o.email && (r = o.email); const s = [a, o.horaInicio, o.horaFin, o.nombre, o.tipo, o.duracion, r]; e.push(s) }); const n = window.XLSX.utils.aoa_to_sheet(e), a = t.map((e, t) => ({ wch: 15 })); e.forEach(e => { e.forEach((e, t) => { const o = e ? String(e).length : 0; if (a[t].wch < o + 2) { const n = 6 === t ? 60 : 40; a[t].wch = Math.min(o + 3, n) } }) }), a[0].wch = Math.max(a[0].wch, 20), a[3].wch = Math.max(a[3].wch, 25), a[6].wch = Math.max(a[6].wch, 30), n["!cols"] = a; const r = window.XLSX.utils.book_new(); window.XLSX.utils.book_append_sheet(r, n, "Reservas"); const s = (new Date).toISOString().split("T")[0]; window.XLSX.writeFile(r, `reservas_${s}.xlsx`), Swal.fire("Exportado", "Datos exportados a Excel correctamente.", "success") } catch (e) { console.error("Error al generar el archivo Excel:", e), Swal.fire("Error", "Ocurri√≥ un error al generar el archivo Excel.", "error") } finally { setExportButtonLoading(!1) } }

        // --- Importar JSON (Unchanged) ---
        importDataBtn.addEventListener("click", () => { fileInput.click() }); fileInput.addEventListener("change", e => { const t = e.target.files[0]; if (t) { if (!t.name.endsWith(".json") && !t.name.endsWith(".txt")) return Swal.fire("Inv√°lido", "Selecciona un archivo .json o .txt.", "error"), void (fileInput.value = null); const o = new FileReader; o.onload = e => { let t = e.target.result, o; try { if (o = JSON.parse(t), "object" != typeof o || null === o || Array.isArray(o)) throw new Error("El archivo no contiene un objeto JSON v√°lido."); let e = !1, n = 0; for (const a in o) { n++; const r = o[a]; if ("string" != typeof a || -1 === a.indexOf("-") || "object" != typeof r || !r.nombre || !r.horaInicio || !r.tipo) { console.warn(`Entrada inv√°lida (estructura base): ${a}`, r), e = !0; continue } "Grupal" === r.tipo ? (Array.isArray(r.participantes) ? r.participantes.forEach((t, o) => { ("object" != typeof t || !t.nombre || "string" != typeof t.email) && (console.warn(`Participante inv√°lido en ${a} (√≠ndice ${o}):`, t), e = !0) }) : (console.warn(`Entrada Grupal (${a}) no tiene array 'participantes':`, r), e = !0), r.email && console.warn(`Entrada Grupal (${a}) tiene campo 'email' inesperado. Se ignorar√°.`, r)) : ("string" != typeof r.email && null !== r.email && "undefined" != typeof r.email && (console.warn(`Entrada no-Grupal (${a}) tiene 'email' inv√°lido:`, r), e = !0), r.participantes && console.warn(`Entrada no-Grupal (${a}) tiene campo 'participantes' inesperado. Se ignorar√°.`, r)), r.fechaEspecifica && "string" != typeof r.fechaEspecifica && (console.warn(`Entrada (${a}) tiene 'fechaEspecifica' inv√°lida:`, r), e = !0) } if (0 === n) return Swal.fire("Vac√≠o", "El archivo JSON no contiene reservas.", "info"), void (fileInput.value = null); let a = `${n} reserva(s) encontradas.`; e && (a += "<br><b style='color:orange;'>Advertencia:</b> Algunas entradas tienen formato inesperado (ver consola F12)."), a += "<br>¬øDeseas reemplazar <b>TODAS</b> las reservas actuales con las del archivo? <b style='color:red;'>¬°Esta acci√≥n es irreversible!</b>", Swal.fire({ title: "Confirmar Importaci√≥n", html: a, icon: e ? "warning" : "question", showCancelButton: !0, confirmButtonColor: "#3085d6", cancelButtonColor: "#d33", confirmButtonText: "S√≠, importar y reemplazar", cancelButtonText: "Cancelar" }).then(e => { e.isConfirmed && (reservas = o, guardarReservasEnLocalStorage(), renderCalendar(), Swal.fire("¬°Importado!", "Las reservas han sido actualizadas desde el archivo.", "success")) }) } catch (e) { console.error("Error al importar JSON:", e), Swal.fire("Error de Importaci√≥n", `No se pudo procesar el archivo. Verifica que sea un JSON v√°lido.\nDetalle: ${e.message}`, "error") } finally { fileInput.value = null } }, o.onerror = e => { console.error("Error al leer el archivo:", e), Swal.fire("Error de Lectura", "No se pudo leer el archivo seleccionado.", "error"), fileInput.value = null }, o.readAsText(t) } });

        // --- Carga Inicial y L√≥gica Back-to-Top (Unchanged) ---
        document.addEventListener("DOMContentLoaded", () => { cargarReservasDesdeLocalStorage(); if (exportExcelBtn) { exportExcelBtn.addEventListener("click", exportarExcel); "undefined" != typeof window.XLSX ? xlsxScriptLoaded() : console.log("XLSX library not immediately available. Waiting for onload/onerror...") } else console.error("Bot√≥n Exportar Excel no encontrado en el DOM."); const e = document.getElementById("backToTopBtn"), t = 200; function o() { (window.scrollY > t || document.documentElement.scrollTop > t) ? e && e.classList.add("show") : e && e.classList.remove("show") } function n() { window.scrollTo({ top: 0, behavior: "smooth" }) } e ? (window.addEventListener("scroll", o), e.addEventListener("click", n)) : console.error("Back to Top button not found.") });
    </script>
 
</body>

</html>